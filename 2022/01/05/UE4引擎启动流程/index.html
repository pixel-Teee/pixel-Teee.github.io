<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="游戏流程总览两种主要路径：编辑器路径、standalone路径。 一般顺序为：初始化引擎、创建并初始化GameInstance、加载关卡，最后开始游戏。 StandaloneStandalone模式(在编辑器外进行的游戏使用该模式)，引擎启动和初始化之后立即对进行游戏所需的对象进行创建和初始化。GameInstace之类的对象在引擎启用之前被创建和初始化(与创建和初始化引擎不同)。 引擎的启动函数">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="游戏流程总览两种主要路径：编辑器路径、standalone路径。 一般顺序为：初始化引擎、创建并初始化GameInstance、加载关卡，最后开始游戏。 StandaloneStandalone模式(在编辑器外进行的游戏使用该模式)，引擎启动和初始化之后立即对进行游戏所需的对象进行创建和初始化。GameInstace之类的对象在引擎启用之前被创建和初始化(与创建和初始化引擎不同)。 引擎的启动函数">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/01/Image/GameFlowChart.png">
<meta property="og:image" content="http://example.com/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/Image/DebugOutput.png">
<meta property="og:image" content="http://example.com/2022/01/Image/CommandLine.png">
<meta property="og:image" content="http://example.com/2022/01/Image/UNATTENDED.png">
<meta property="og:image" content="http://example.com/2022/01/Image/Launch.png">
<meta property="og:image" content="http://example.com/2022/01/Image/FEngineLoop.png">
<meta property="article:published_time" content="2022-01-05T10:38:20.410Z">
<meta property="article:modified_time" content="2022-04-18T16:22:49.883Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/01/Image/GameFlowChart.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-UE4引擎启动流程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2022-01-05T10:38:20.410Z" itemprop="datePublished">2022-01-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="游戏流程总览"><a href="#游戏流程总览" class="headerlink" title="游戏流程总览"></a>游戏流程总览</h1><p>两种主要路径：<strong>编辑器</strong>路径、<strong>standalone</strong>路径。</p>
<p>一般顺序为：初始化引擎、创建并初始化<strong>GameInstance</strong>、加载关卡，最后开始游戏。</p>
<h1 id="Standalone"><a href="#Standalone" class="headerlink" title="Standalone"></a>Standalone</h1><p>Standalone模式(在编辑器外进行的游戏使用该模式)，引擎启动和初始化之后<strong>立即</strong>对进行游戏所需的对象进行创建和初始化。<strong>GameInstace</strong>之类的对象在引擎启用之前被创建和初始化(与创建和初始化引擎不同)。</p>
<p>引擎的<strong>启动函数</strong>被调用后，将立即加载初始地图。</p>
<p>关卡创建适当的<strong>GameMode</strong>和<strong>GameState</strong>，然后创建其他的Actors后，游戏进程便立即开始。</p>
<h1 id="编辑器"><a href="#编辑器" class="headerlink" title="编辑器"></a>编辑器</h1><p>编辑器由<strong>Play In Editor</strong>和<strong>Simulate In Editor</strong>使用，流程完全不同。</p>
<p>引擎立即初始化并启动，因为需要它运行编辑器，但诸如<strong>GameInstance</strong>之类对象的创建和初始化将被延迟，</p>
<p>直到玩家按下启动按钮启动PIE或SIE会话。</p>
<p>此外，<strong>关卡中的Actors将被复制</strong>，每个对象(包括GameInstance)均有每个PIE实例的单独副本。</p>
<p>注意，<strong>会把每个Actors都复制。</strong></p>
<p><img src="../../Image/GameFlowChart.png"></p>
<p>注意，紫色的小块，(UEngine)Start，在两个不同的分支的调用顺序是不一样的。</p>
<p>编辑器，多了一个(UEditorEngine)Init。</p>
<p>注意，按下按钮后，<strong>会进行拷贝的。</strong></p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p>启动入口在Source/Runtime/Launch里面。</p>
<h2 id="LaunchWindows-cpp"><a href="#LaunchWindows-cpp" class="headerlink" title="LaunchWindows.cpp"></a>LaunchWindows.cpp</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 WINAPI <span class="title">WinMain</span><span class="params">(_In_ HINSTANCE hInInstance, _In_opt_ HINSTANCE hPrevInstance, _In_ <span class="keyword">char</span>* pCmdLine, _In_ int32 nCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	int32 Result = <span class="built_in">LaunchWindowsStartup</span>(hInInstance, hPrevInstance, pCmdLine, nCmdShow, <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="built_in">LaunchWindowsShutdown</span>();</span><br><span class="line">	<span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Windows的入口，调用两个函数<strong>LaunchWindowsStartup</strong>和<strong>LaunchWindowsShutdown</strong>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LAUNCH_API int32 <span class="title">LaunchWindowsStartup</span><span class="params">( HINSTANCE hInInstance, HINSTANCE hPrevInstance, <span class="keyword">char</span>*, int32 nCmdShow, <span class="keyword">const</span> TCHAR* CmdLine )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">TRACE_BOOKMARK</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;WinMain.Enter&quot;</span>));<span class="comment">//这里产生了一个事件日志</span></span><br><span class="line">	</span><br><span class="line">    <span class="built_in">SetupWindowsEnvironment</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>TRACE_BOOKMARK，会产生一个事件日志，该事件名为WinMain.Enter。</p>
<p><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.26/en-US/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Reference/Trace/">https://docs.unrealengine.com/4.26/en-US/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Reference/Trace/</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置通用的debug设置</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetupWindowsEnvironment</span><span class="params">( <span class="keyword">void</span> )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//所有的ctr验证应当触发回调</span></span><br><span class="line">	_set_invalid_parameter_handler(InvalidParameterHandler);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_BUILD_DEBUG</span></span><br><span class="line">	<span class="comment">//关闭断言的messagebox，将消息写入到调试器的输出窗口</span></span><br><span class="line">	_CrtSetReportMode( _CRT_ASSERT, _CRTDBG_MODE_DEBUG );</span><br><span class="line">	<span class="comment">//用0来填充buffer缓冲区，因为我们假设FNames st只使用整个缓冲区的一小部分</span></span><br><span class="line">	_CrtSetDebugFillThreshold( <span class="number">0</span> );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>CRT，C Time Library，C/C++的运行时库，那里是<strong>动态内存分配</strong>的地方，可以使用CRT的一些函数，来检测或者开启一些功能，当发生错误的时候。</p>
<p><img src="Image/DebugOutput.png" alt="image-20220418184402053"></p>
<p>将断言的消息输出到这个窗口。</p>
<p>UE4实现的回调，当CRT检测到无效的参数的时候，<strong>调用这个回调函数。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">处理CRT的参数验证</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Expression - 失败的CRT检测的表达式</span></span><br><span class="line"><span class="comment">Function - 失败的CRT检测的函数</span></span><br><span class="line"><span class="comment">File - 失败发生的文件地方</span></span><br><span class="line"><span class="comment">Line - 失败发生的行的地方</span></span><br><span class="line"><span class="comment">Reserved - 没用的参数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InvalidParameterHandler</span><span class="params">(<span class="keyword">const</span> TCHAR* Expression,</span></span></span><br><span class="line"><span class="params"><span class="function">							 <span class="keyword">const</span> TCHAR* Function, </span></span></span><br><span class="line"><span class="params"><span class="function">							 <span class="keyword">const</span> TCHAR* File, </span></span></span><br><span class="line"><span class="params"><span class="function">							 uint32 Line, </span></span></span><br><span class="line"><span class="params"><span class="function">							 <span class="keyword">uintptr_t</span> Reserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogLaunchWindows, Fatal,<span class="built_in">TEXT</span>(<span class="string">&quot;SECURE CRT: Invalid parameter detected.\nExpression: %s Function: %s. File: %s Line: %d\n&quot;</span>), </span><br><span class="line">		Expression ? Expression : <span class="built_in">TEXT</span>(<span class="string">&quot;Unknown&quot;</span>), </span><br><span class="line">		Function ? Function : <span class="built_in">TEXT</span>(<span class="string">&quot;Unknown&quot;</span>), </span><br><span class="line">		File ? File : <span class="built_in">TEXT</span>(<span class="string">&quot;Unknown&quot;</span>), </span><br><span class="line">		Line );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>可以看到，当程序发生错误的时候，CRT，会调用UE4的回调函数，<strong>把发生错误的地方写入到日志里面。</strong></p>
<p>//verbosity：冗长，赘述</p>
<p>//partiy：对等</p>
<p>继续LanuchWindowsStartup函数的调用：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">int32 ErrorLevel = <span class="number">0</span>;</span><br><span class="line">hInstance = hInInstance;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!CmdLine)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//调用WIN32的函数，获取命令行参数</span></span><br><span class="line">	<span class="comment">//GetCommandLineW：Windows的平台函数</span></span><br><span class="line">	CmdLine = ::<span class="built_in">GetCommandLineW</span>();</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">ProcessCommandLine</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		CmdLine = *GSavedCommandLine;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>hInstance定义在Source/Runtime/Core/Public/Windows/WindowsSystemIncludes.h里面的，</p>
<p>说明在初始化入口的时候，<strong>会初始化Core里面相关平台的一些变量。</strong></p>
<p>GSavedCommandLine是一个<strong>全局静态的FString</strong>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> FString GSavedCommandLine;</span><br></pre></td></tr></table></figure>



<h3 id="ProcessCommandLine"><a href="#ProcessCommandLine" class="headerlink" title="ProcessCommandLine"></a>ProcessCommandLine</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ProcessCommandLine</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> argc = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//获取命令行参数，然后转换成argv数组</span></span><br><span class="line">	LPWSTR* argv = ::<span class="built_in">CommandLineToArgvW</span>(::<span class="built_in">GetCommandLineW</span>(), &amp;argc);</span><br><span class="line">	<span class="keyword">if</span> (argv != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//重新构造我们的命令行字符串，以一定合适的格式，用于FParse类</span></span><br><span class="line">		GSavedCommandLine = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//从第二个开始，因为第一个是程序名</span></span><br><span class="line">		<span class="keyword">for</span> (int32 Option = <span class="number">1</span>; Option &lt; argc; Option++)</span><br><span class="line">		&#123;</span><br><span class="line">			GSavedCommandLine += <span class="built_in">TEXT</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//注入&quot;字符到正确的位置，使得参数保留空白</span></span><br><span class="line">			FString Temp = argv[Option];</span><br><span class="line">			<span class="keyword">if</span> (Temp.<span class="built_in">Contains</span>(<span class="built_in">TEXT</span>(<span class="string">&quot; &quot;</span>)))</span><br><span class="line">			&#123;</span><br><span class="line">				int32 Quote = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">if</span>(Temp.<span class="built_in">StartsWith</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;-&quot;</span>)))</span><br><span class="line">				&#123;</span><br><span class="line">					int32 Separator;</span><br><span class="line">					<span class="keyword">if</span> (Temp.<span class="built_in">FindChar</span>(<span class="string">&#x27;=&#x27;</span>, Separator))</span><br><span class="line">					&#123;</span><br><span class="line">						Quote = Separator + <span class="number">1</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				Temp = Temp.<span class="built_in">Left</span>(Quote) + <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>) + Temp.<span class="built_in">Mid</span>(Quote) + <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			GSavedCommandLine += Temp;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//释放由CommandLineToArgvW分配的内存</span></span><br><span class="line">		::<span class="built_in">LocalFree</span>(argv);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="../../Image/CommandLine.png" alt="image-20220418192450741"></p>
<p>可以看到第一个是应用名，第二个是我们项目的配置文件名，第三个是一些额外的参数。</p>
<p>这个大概是把诸如-XX=AA，如果AA包含空白空格的，<strong>那么就变成”AA”。</strong></p>
<p>处理完毕后，用空格分割的参数，就放置在<strong>GSavedCommandLine</strong>里面了。</p>
<p>这里是大量的命令行参数<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.26/zh-CN/ProductionPipelines/CommandLineArguments/%E3%80%82">https://docs.unrealengine.com/4.26/zh-CN/ProductionPipelines/CommandLineArguments/。</a></p>
<p>继续我们的LaunchWindows.cpp流程：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果我们处于unattended模式，确认我们永远不显示错误会话，如果我们crash的话</span></span><br><span class="line"><span class="keyword">if</span> ( FParse::<span class="built_in">Param</span>( CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;unattended&quot;</span>) ) )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SetErrorMode</span>(SEM_FAILCRITICALERRORS | SEM_NOGPFAULTERRORBOX | SEM_NOOPENFILEERRORBOX);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这里用FParse看一下CmdLine里面有没有unattended，然后<strong>设置错误模式。</strong></p>
<p>这个SetErrorMode也是一个<strong>Windows平台的函数。</strong></p>
<p><img src="../../Image/UNATTENDED.png" alt="image-20220418193913619"></p>
<p>接下来继续：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(UE_BUILD_SHIPPING &amp;&amp; WITH_EDITOR)</span></span><br><span class="line">	<span class="comment">//我们使用有名的互斥量，去检测我们是否是第一个运行的游戏实例</span></span><br><span class="line">	<span class="comment">//防止这里有竞争，当我们保存shader cache的时候</span></span><br><span class="line">	GIsFirstInstance = <span class="built_in">MakeNamedMutex</span>( CmdLine );</span><br><span class="line">	<span class="comment">//分析一下命令行里面是否有crashreports，如果有，设置GAlywaysReportCrash</span></span><br><span class="line">	<span class="comment">//这个参数用来报告引擎的崩溃的</span></span><br><span class="line">	<span class="keyword">if</span> ( FParse::<span class="built_in">Param</span>( CmdLine,<span class="built_in">TEXT</span>(<span class="string">&quot;crashreports&quot;</span>) ) )</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//ExceptionHandling.h里面的</span></span><br><span class="line">		GAlwaysReportCrash = <span class="literal">true</span>;</span><br><span class="line">	&#125;	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<p>GAlywasReportCrash定义在Source/Runtime/Core/Public/HAL/ExceptionHandling.h里面。</p>
<p>GIsFirstInstance定义在Source/Runtime/Core/Public/CoreGlobals.h里面。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MakeNamedMutex</span><span class="params">( <span class="keyword">const</span> TCHAR* CmdLine )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> bIsFirstInstance = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	TCHAR MutexName[MAX_SPRINTF] = <span class="built_in">TEXT</span>( <span class="string">&quot;&quot;</span> );</span><br><span class="line">	<span class="comment">//把UnrealEngine4赋值给MutexName</span></span><br><span class="line">	FCString::<span class="built_in">Strcpy</span>( MutexName, MAX_SPRINTF, <span class="built_in">TEXT</span>( <span class="string">&quot;UnrealEngine4&quot;</span> ) );</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//创建这个互斥量</span></span><br><span class="line">	GNamedMutex = <span class="built_in">CreateMutex</span>( <span class="literal">NULL</span>, <span class="literal">true</span>, MutexName );</span><br><span class="line">	<span class="comment">//检查是否是第一个实例</span></span><br><span class="line">	<span class="keyword">if</span>( GNamedMutex	&amp;&amp; <span class="built_in">GetLastError</span>() != ERROR_ALREADY_EXISTS &amp;&amp; !FParse::<span class="built_in">Param</span>( CmdLine, <span class="built_in">TEXT</span>( <span class="string">&quot;NEVERFIRST&quot;</span> ) ) )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//我们是第一个实例</span></span><br><span class="line">		bIsFirstInstance = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//释放这个互斥量</span></span><br><span class="line">		<span class="built_in">ReleaseNamedMutex</span>();</span><br><span class="line">		<span class="comment">//这个置为false，表示已经有一个实例运行了</span></span><br><span class="line">		bIsFirstInstance = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span>( bIsFirstInstance );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>具名互斥量，<strong>可以用来判断多个进程间是否同时有一个互斥量。</strong></p>
<p>GetLastError也是Windows平台的函数。</p>
<p>接下来看看有没有这个，<strong>是否关闭C++原生的异常处理。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> bNoExceptionHandler = FParse::<span class="built_in">Param</span>(CmdLine,<span class="built_in">TEXT</span>(<span class="string">&quot;noexceptionhandler&quot;</span>));</span><br><span class="line"><span class="comment">//使用-noexceptionhandler参数，会关闭原生C++的异常处理，被管理的代码关闭</span></span><br><span class="line"><span class="comment">//默认的情况是有3个包裹的异常处理函数</span></span><br><span class="line"><span class="comment">//Native：WinMain() -&gt; Native：GuardedMainWrapper()</span></span><br><span class="line"><span class="comment">//内部的异常处理被GuardedMainWrapper()捕获，在原生的C++代码中，并且是唯一的方式去获取</span></span><br><span class="line"><span class="comment">//正确的调用栈，当运行64位执行程序的时候</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN64</span></span><br><span class="line">	<span class="keyword">if</span> ( FParse::<span class="built_in">Param</span>(CmdLine,<span class="built_in">TEXT</span>(<span class="string">&quot;noinnerexception&quot;</span>)) || FApp::<span class="built_in">IsBenchmarking</span>() || bNoExceptionHandler)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//内部的异常关闭</span></span><br><span class="line">		GEnableInnerException = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>	</span></span><br></pre></td></tr></table></figure>



<p>接下来是这个：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//当我们运行在嵌入的时候，假设外部的应用程序准备去处理crash报错</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_BUILD_DEBUG</span></span><br><span class="line">	<span class="keyword">if</span> (GUELibraryOverrideSettings.bIsEmbedded || !GAlwaysReportCrash)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">if</span> (GUELibraryOverrideSettings.bIsEmbedded || bNoExceptionHandler || (FPlatformMisc::<span class="built_in">IsDebuggerPresent</span>() &amp;&amp; !GAlwaysReportCrash))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//不处理异常</span></span><br><span class="line">        <span class="comment">//真正的Main函数入口</span></span><br><span class="line">		ErrorLevel = <span class="built_in">GuardedMain</span>( CmdLine );</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 使用结构化异常处理SEH去处理报错，显示一个对话框</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !PLATFORM_SEH_EXCEPTIONS_DISABLED</span></span><br><span class="line">		__try</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> 		&#123;</span><br><span class="line">			GIsGuarded = <span class="number">1</span>;</span><br><span class="line">			<span class="comment">//运行在监视模式下</span></span><br><span class="line">			ErrorLevel = <span class="built_in">GuardedMainWrapper</span>( CmdLine );</span><br><span class="line">			GIsGuarded = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !PLATFORM_SEH_EXCEPTIONS_DISABLED</span></span><br><span class="line">		__except( GEnableInnerException ? EXCEPTION_EXECUTE_HANDLER : <span class="built_in">ReportCrash</span>( <span class="built_in">GetExceptionInformation</span>( ) ) )</span><br><span class="line">		&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(UE_BUILD_SHIPPING &amp;&amp; WITH_EDITOR)</span></span><br><span class="line">			<span class="comment">//释放具名互斥量，就是我们前面那个</span></span><br><span class="line">			<span class="built_in">ReleaseNamedMutex</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			<span class="comment">//Crashed</span></span><br><span class="line">			ErrorLevel = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span>(GError)</span><br><span class="line">			&#123;</span><br><span class="line">                <span class="comment">//处理错误</span></span><br><span class="line">				GError-&gt;<span class="built_in">HandleError</span>();</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">//报错和退出</span></span><br><span class="line">			<span class="built_in">LaunchStaticShutdownAfterError</span>();</span><br><span class="line">			FPlatformMallocCrash::<span class="built_in">Get</span>().<span class="built_in">PrintPoolsUsage</span>();</span><br><span class="line">			FPlatformMisc::<span class="built_in">RequestExit</span>( <span class="literal">true</span> );</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>GIsGuarded定义在Source/Runtime/Core/Public/CoreGlobals.h里面。</p>
<p><strong>GError是定义在CoreGlobal.s里面一个FOutputDeviceError的对象。</strong></p>
<p>可以看出，这里有两种入口，一种是不会报错的入口GuardedMain，还有一种就是处于<strong>异常捕获情况</strong>下的入口GuardedMainWrapper。</p>
<p>最后是这个：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">TRACE_BOOKMARK</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;WinMain.Exit&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ErrorLevel;</span><br></pre></td></tr></table></figure>

<p>记录一下退出发生的日志。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//确保发生重大错误的时候，资源被正确的释放</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LaunchStaticsShutdownAfterError</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//确认物理被正确的关闭</span></span><br><span class="line">	<span class="built_in">TermGamePhys</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="GuardedMain和GuardedMainWrapper"><a href="#GuardedMain和GuardedMainWrapper" class="headerlink" title="GuardedMain和GuardedMainWrapper"></a>GuardedMain和GuardedMainWrapper</h2><p>GuardedMainWrapper是GuardedMain的封装。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LAUNCH_API int32 <span class="title">GuardedMainWrapper</span><span class="params">( <span class="keyword">const</span> TCHAR* CmdLine )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	int32 ErrorLevel = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> ( GEnableInnerException )</span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !PLATFORM_SEH_EXCEPTIONS_DISABLED</span></span><br><span class="line">	 	__try</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//运行监视代码</span></span><br><span class="line">			ErrorLevel = <span class="built_in">GuardedMain</span>( CmdLine );</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !PLATFORM_SEH_EXCEPTIONS_DISABLED</span></span><br><span class="line">        <span class="comment">//捕获异常，然后报错</span></span><br><span class="line">		__except( <span class="built_in">ReportCrash</span>( <span class="built_in">GetExceptionInformation</span>() ), EXCEPTION_CONTINUE_SEARCH )</span><br><span class="line">		&#123;</span><br><span class="line">			(<span class="keyword">void</span>)<span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//运行GuardedMain</span></span><br><span class="line">		ErrorLevel = <span class="built_in">GuardedMain</span>( CmdLine );</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ErrorLevel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="GuardedMain"><a href="#GuardedMain" class="headerlink" title="GuardedMain"></a>GuardedMain</h2><p>GuardedMain在Launch.cpp里面定义。</p>
<p><img src="../../Image/Launch.png" alt="image-20220418202443313"></p>
<p>LanuchWindows.cpp调用Launch.cpp，说明平台相关的入口都在相应的文件夹里面，</p>
<p><strong>然后再调用平台无关的入口Lanuch.cpp。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">静态的guarded main函数，进入到我们的函数中，那么我们可以有自己的异常处理，</span></span><br><span class="line"><span class="comment">对于debug/release构建，依赖于debugger是否附着</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">int32 <span class="title">GuardedMain</span><span class="params">( <span class="keyword">const</span> TCHAR* CmdLine )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//首先，判断debugger模式是否开启</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(UE_BUILD_SHIPPING)</span></span><br><span class="line">	<span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;waitforattach&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span> (!FPlatformMisc::<span class="built_in">IsDebuggerPresent</span>());</span><br><span class="line">		<span class="built_in">UE_DEBUG_BREAK</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//记录一下日志，DefaultMain</span></span><br><span class="line">	<span class="built_in">BootTimingPoint</span>(<span class="string">&quot;DefaultMain&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//超级早的初始化代码</span></span><br><span class="line">	FCoreDelegates::<span class="built_in">GetPreMainInitDelegate</span>().<span class="built_in">Broadcast</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//确认GEngineLoop::Exit()总是被调用</span></span><br><span class="line">	<span class="comment">//使用C++的RAII来控制</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">EngineLoopCleanupGuard</span> </span></span><br><span class="line"><span class="class">	&#123;</span> </span><br><span class="line">		~<span class="built_in">EngineLoopCleanupGuard</span>()</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// 在嵌入式下，不要关闭引擎，当退出作用域的时候，因为其他的应用会考虑这个</span></span><br><span class="line">			<span class="keyword">if</span> (!GUELibraryOverrideSettings.bIsEmbedded)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">EngineExit</span>();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; CleanupGuard;</span><br><span class="line">	<span class="comment">//设置小型转储文件名。在main函数中，我们不能直接做这个，因为我们使用了一个FString，</span></span><br><span class="line">    <span class="comment">//它请求了析构，并且main使用了SEH，结构化异常。</span></span><br><span class="line">	<span class="comment">//这些名字将会被更新，只要Filemanager被设置，那么我们可以写入到log文件中。</span></span><br><span class="line">    <span class="comment">//这个也会使用用户文件夹，对于安装的build，那么我们不用写入到程序文件。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_WINDOWS</span></span><br><span class="line">    <span class="comment">//unreal-v版本号-时间.dmp</span></span><br><span class="line">    <span class="comment">//这个文件保存了crash时候的一些信息</span></span><br><span class="line">	FCString::<span class="built_in">Strcpy</span>(MiniDumpFilenameW, *FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;unreal-v%i-%s.dmp&quot;</span>), FEngineVersion::<span class="built_in">Current</span>().<span class="built_in">GetChangelist</span>(), *FDateTime::<span class="built_in">Now</span>().<span class="built_in">ToString</span>()));</span><br><span class="line">	<span class="comment">//判断一下，是否是在控制台下运行的</span></span><br><span class="line">	GIsConsoleExecutable = (<span class="built_in">GetFileType</span>(<span class="built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE)) == FILE_TYPE_CHAR);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">//调用EnginePreInit</span></span><br><span class="line">	int32 ErrorLevel = <span class="built_in">EnginePreInit</span>( CmdLine );</span><br><span class="line"></span><br><span class="line">	<span class="comment">//退出，如果EnginePreInit调用失败</span></span><br><span class="line">	<span class="keyword">if</span> ( ErrorLevel != <span class="number">0</span> || <span class="built_in">IsEngineExitRequested</span>() )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> ErrorLevel;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function">FScopedSlowTask <span class="title">SlowTask</span><span class="params">(<span class="number">100</span>, NSLOCTEXT(<span class="string">&quot;EngineInit&quot;</span>, <span class="string">&quot;EngineInit_Loading&quot;</span>, <span class="string">&quot;Loading...&quot;</span>))</span></span>;</span><br><span class="line">        <span class="comment">//EnginePreInit剩余20%未使用的在它的slow task里面</span></span><br><span class="line">        <span class="comment">//这里我们立即地消耗80，那么启动画面的百分比，从一个slow task到另一个的时候，不会改变</span></span><br><span class="line">		<span class="comment">//注意，我们没有包含EngienPreInit在ScopedSlowTak，因为引擎不会完整地在那个点进行初始化</span></span><br><span class="line">		SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">		SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">		<span class="keyword">if</span> (GIsEditor)</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">//编辑器初始化</span></span><br><span class="line">			ErrorLevel = <span class="built_in">EditorInit</span>(GEngineLoop);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">//游戏引擎初始化</span></span><br><span class="line">			ErrorLevel = <span class="built_in">EngineInit</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//记录初始化时间</span></span><br><span class="line">	<span class="keyword">double</span> EngineInitializationTime = FPlatformTime::<span class="built_in">Seconds</span>() - GStartTime;</span><br><span class="line">    <span class="comment">//输出到窗口</span></span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogLoad, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;(Engine Initialization) Total time: %.2f seconds&quot;</span>), EngineInitializationTime);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">    <span class="comment">//蓝图的编译时间</span></span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogLoad, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;(Engine Initialization) Total Blueprint compile time: %.2f seconds&quot;</span>), BlueprintCompileAndLoadTimerData.<span class="built_in">GetTime</span>());</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">//累加加载时间</span></span><br><span class="line">	<span class="built_in">ACCUM_LOADTIME</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;EngineInitialization&quot;</span>), EngineInitializationTime);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//记录循环Tick开始的地方</span></span><br><span class="line">	<span class="built_in">BootTimingPoint</span>(<span class="string">&quot;Tick loop starting&quot;</span>);</span><br><span class="line">    <span class="comment">//输出这个Timing</span></span><br><span class="line">	<span class="built_in">DumpBootTiming</span>();</span><br><span class="line">	<span class="comment">//如果我们运行在嵌入的引擎，不要tick，我们依赖于外部的应用Tick我们</span></span><br><span class="line">	<span class="keyword">if</span> (!GUELibraryOverrideSettings.bIsEmbedded)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span>( !<span class="built_in">IsEngineExitRequested</span>() )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">EngineTick</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//记录下Tick的结束</span></span><br><span class="line">	<span class="built_in">TRACE_BOOKMARK</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Tick loop end&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">	<span class="keyword">if</span>( GIsEditor )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">EditorExit</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> ErrorLevel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>GIsConsoleExecutable是在Launch.cpp下定义的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">		<span class="keyword">if</span> (GIsEditor)</span><br><span class="line">		&#123;</span><br><span class="line">			ErrorLevel = <span class="built_in">EditorInit</span>(GEngineLoop);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		&#123;</span><br><span class="line">			ErrorLevel = <span class="built_in">EngineInit</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>GIsEditor定义在CoreGlobals.h里面，这里是关键，如果是<strong>编辑器状态</strong>下，那么就调用EditorInit，</p>
<p>否则调用EngineInit。</p>
<h2 id="FScopedSlowTask"><a href="#FScopedSlowTask" class="headerlink" title="FScopedSlowTask"></a>FScopedSlowTask</h2><p><a target="_blank" rel="noopener" href="https://isaratech.com/ue4-making-a-progress-bar-in-the-editor/">https://isaratech.com/ue4-making-a-progress-bar-in-the-editor/</a></p>
<p>SlowTask可以用来制作<strong>进度条</strong>，那么用户可以追踪任务的进度。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FScopedSlowTask <span class="title">ExplorePathsTask</span><span class="params">(SelectedPaths.Num(),</span></span></span><br><span class="line"><span class="params"><span class="function">LOCTEXT(<span class="string">&quot;LookingForUnusedAssetsText&quot;</span>, <span class="string">&quot;Looking for assets to remove&quot;</span>))</span></span>;</span><br><span class="line">ExplorePathsTask.<span class="built_in">MakeDialog</span>();</span><br></pre></td></tr></table></figure>

<p>第一个参数表示总共的迭代，第二个参数是用来表示要显示的文本。</p>
<p>第二行显示进度条在编辑器上。</p>
<p>更新进度条，使用<strong>EnterProgressFrame()函数</strong>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExploreFoldersTask.<span class="built_in">EnterProgressFrame</span>();</span><br></pre></td></tr></table></figure>



<p>不需要关闭对话框，如果ExplorePathsTask对象析构了，自然就会关闭对话框。</p>
<p>EnterProgressFrame还能<strong>填入参数</strong>，表示执行到百分之多少。</p>
<h2 id="EnginePreInit"><a href="#EnginePreInit" class="headerlink" title="EnginePreInit"></a>EnginePreInit</h2><p>调用GEngineLoop.PreInit函数。</p>
<h3 id="FEngineLoop-PreInit"><a href="#FEngineLoop-PreInit" class="headerlink" title="FEngineLoop::PreInit"></a>FEngineLoop::PreInit</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">FEngineLoop::PreInit</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> int32 rv1 = <span class="built_in">PreInitPreStartupScreen</span>(CmdLine);</span><br><span class="line">	<span class="keyword">if</span> (rv1 != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		PreInitContext.<span class="built_in">Cleanup</span>();</span><br><span class="line">		<span class="keyword">return</span> rv1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> int32 rv2 = <span class="built_in">PreInitPostStartupScreen</span>(CmdLine);</span><br><span class="line">	<span class="keyword">if</span> (rv2 != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		PreInitContext.<span class="built_in">Cleanup</span>();</span><br><span class="line">		<span class="keyword">return</span> rv2;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="FEngineLoop-PreInitPreStartupScreen"><a href="#FEngineLoop-PreInitPreStartupScreen" class="headerlink" title="FEngineLoop::PreInitPreStartupScreen"></a>FEngineLoop::PreInitPreStartupScreen</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">//设置主线程的局部存储TLS</span></span><br><span class="line">	FMemory::<span class="built_in">SetupTLSCachesOnCurrentThread</span>();</span><br><span class="line">	<span class="comment">//分析一下有没有UTF8Output</span></span><br><span class="line">	<span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;UTF8Output&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		FPlatformMisc::<span class="built_in">SetUTF8Output</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置工作目录为可执行文件目录</span></span><br><span class="line">	FPlatformProcess::<span class="built_in">SetCurrentWorkingDirectoryToBaseDir</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化trace</span></span><br><span class="line">	FTraceAuxiliary::<span class="built_in">Initialize</span>(CmdLine);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//关闭/开启 LLM基于命令行</span></span><br><span class="line">		&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;LLM Init&quot;</span>);</span><br><span class="line">		<span class="built_in">LLM</span>(FLowLevelMemTracker::<span class="built_in">Get</span>().<span class="built_in">ProcessCommandLine</span>(CmdLine));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> MEMPRO_ENABLED</span></span><br><span class="line">		FMemProProfiler::<span class="built_in">Init</span>(CmdLine);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">LLM_SCOPE</span>(ELLMTag::EnginePreInitMemory);</span><br><span class="line"></span><br><span class="line"><span class="comment">//------不知道干吗的委托------</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_ENGINE</span></span><br><span class="line">FCoreUObjectDelegates::PostGarbageCollectConditionalBeginDestroy.<span class="built_in">AddStatic</span>(DeferredPhysResourceCleanup);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	FCoreDelegates::OnSamplingInput.<span class="built_in">AddStatic</span>(UpdateGInputTime);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span>	STATS</span></span><br><span class="line">	<span class="comment">// 创建stat内存分析代理</span></span><br><span class="line">	<span class="keyword">if</span> (FStatsMallocProfilerProxy::<span class="built_in">HasMemoryProfilerToken</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (PLATFORM_USES_FIXED_GMalloc_CLASS)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogMemory, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Cannot do malloc profiling with PLATFORM_USES_FIXED_GMalloc_CLASS.&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 创建一个全局内存分配器</span></span><br><span class="line">		GMalloc = FStatsMallocProfilerProxy::<span class="built_in">Get</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// STATS</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_APPLICATION_CORE</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;CreateConsoleOutputDevice&quot;</span>);</span><br><span class="line">		<span class="comment">// 初始化日志控制台，去避免静态的初始化问题，当从命令行进入的时候</span></span><br><span class="line">		GScopedLogConsole = TUniquePtr&lt;FOutputDeviceConsole&gt;(FPlatformApplicationMisc::<span class="built_in">CreateConsoleOutputDevice</span>());</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_DESKTOP</span></span><br><span class="line">	<span class="comment">//初始化stdout，FOutputDeviceDebug负责输出log</span></span><br><span class="line">	<span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;stdout&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">InitializeStdOutDevice</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化输出设备</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;Init Output Devices&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_APPLICATION_CORE</span></span><br><span class="line">		GError = FPlatformApplicationMisc::<span class="built_in">GetErrorOutputDevice</span>();</span><br><span class="line">		GWarn = FPlatformApplicationMisc::<span class="built_in">GetFeedbackContext</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		GError = FPlatformOutputDevices::<span class="built_in">GetError</span>();</span><br><span class="line">		GWarn = FPlatformOutputDevices::<span class="built_in">GetFeedbackContext</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;	</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//开始文本本地化的PreInit</span></span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;BeginPreInitTextLocalization&quot;</span>);</span><br><span class="line">		<span class="built_in">BeginPreInitTextLocalization</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_ENGINE</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;PreInitShaderLibrary&quot;</span>);</span><br><span class="line">        <span class="comment">//ShaderCodeLibrary的PreInit</span></span><br><span class="line">		FShaderCodeLibrary::<span class="built_in">PreInit</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// WITH_ENGINE</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化文件管理器</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;IFileManager::Get().ProcessCommandLineOptions&quot;</span>);</span><br><span class="line">		IFileManager::<span class="built_in">Get</span>().<span class="built_in">ProcessCommandLineOptions</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化异步IO</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_COREUOBJECT</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;InitializeNewAsyncIO&quot;</span>);</span><br><span class="line">		FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">InitializeNewAsyncIO</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//记住主线程的线程ID</span></span><br><span class="line">	GGameThreadId = FPlatformTLS::<span class="built_in">GetCurrentThreadId</span>();</span><br><span class="line">	GIsGameThreadIdInitialized = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------不知道干吗用的------</span></span><br><span class="line">	FPlatformProcess::<span class="built_in">SetThreadAffinityMask</span>(FPlatformAffinity::<span class="built_in">GetMainGameMask</span>());</span><br><span class="line">	<span class="comment">//------初始化游戏线程------</span></span><br><span class="line">	FPlatformProcess::<span class="built_in">SetupGameThread</span>();</span><br><span class="line">	<span class="comment">//将磁盘上的着色器文件夹目录映射成虚拟目录</span></span><br><span class="line">	<span class="built_in">AddShaderSourceDirectoryMapping</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Engine&quot;</span>), FGenericPlatformProcess::<span class="built_in">ShaderDir</span>());</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------设置项目目录------</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//检查每个token，对于&#x27;-game&#x27;，&#x27;-server&#x27;，或者&#x27;-run=&#x27;</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化随机数生成器</span></span><br><span class="line">	&#123;</span><br><span class="line">		uint32 Seed1 = <span class="number">0</span>;</span><br><span class="line">		uint32 Seed2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!FApp::bUseFixedSeed)</span><br><span class="line">		&#123;</span><br><span class="line">			Seed1 = FPlatformTime::<span class="built_in">Cycles</span>();</span><br><span class="line">			Seed2 = FPlatformTime::<span class="built_in">Cycles</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		FMath::<span class="built_in">RandInit</span>(Seed1);</span><br><span class="line">		FMath::<span class="built_in">SRandInit</span>(Seed2);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogInit, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;RandInit(%d) SRandInit(%d).&quot;</span>), Seed1, Seed2);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置游戏项目的二进制目录...</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建TaskGraph和线程池</span></span><br><span class="line">	<span class="keyword">if</span> (bCreateTaskGraphAndThreadPools)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//初始化task graph子系统，在潜在的多线程下</span></span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FTaskGraphInterface::Startup&quot;</span>);</span><br><span class="line">		FTaskGraphInterface::<span class="built_in">Startup</span>(FPlatformMisc::<span class="built_in">NumberOfCores</span>());</span><br><span class="line">		FTaskGraphInterface::<span class="built_in">Get</span>().<span class="built_in">AttachToThread</span>(ENamedThreads::GameThread);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//加载核心模块UObject</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;LoadCoreModules&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">LoadCoreModules</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogInit, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to load Core modules.&quot;</span>));</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//---读取和创建一堆配置文件---</span></span><br><span class="line">	<span class="comment">//---还有Pak---</span></span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//使用初始化渲染所需的cache变量</span></span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//------创建线程池------</span></span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> WITH_APPLICATION_CORE</span></span><br><span class="line">	<span class="comment">//得到一个指向log output设备的指针</span></span><br><span class="line">	GLogConsole = GScopedLogConsole.<span class="built_in">Get</span>();</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;LoadPreInitModules&quot;</span>);</span><br><span class="line">		<span class="built_in">LoadPreInitModules</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------绑定一些委托-------</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_ENGINE &amp;&amp; CSV_PROFILER</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsRunningDedicatedServer</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		FCoreDelegates::OnBeginFrame.<span class="built_in">AddStatic</span>(UpdateCoreCsvStats_BeginFrame);</span><br><span class="line">		FCoreDelegates::OnEndFrame.<span class="built_in">AddStatic</span>(UpdateCoreCsvStats_EndFrame);</span><br><span class="line">	&#125;</span><br><span class="line">	FCsvProfiler::<span class="built_in">Get</span>()-&gt;<span class="built_in">Init</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">//------绑定一些委托-------</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//开始Application的初始化</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;AppInit&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">AppInit</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------创建IO线程------</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//从配置文件读取引擎的变量</span></span><br><span class="line">	<span class="built_in">ApplyCVarSettingsFromIni</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Script/Engine.RendererSettings&quot;</span>), *GEngineIni, ECVF_SetByProjectSetting);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//------使用渲染线程------</span></span><br><span class="line">		<span class="keyword">if</span> (FPlatformMisc::<span class="built_in">UseRenderThread</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			GUseThreadedRendering = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//------内存的初始化------</span></span><br><span class="line">		FPlatformMisc::<span class="built_in">PlatformInit</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_APPLICATION_CORE</span></span><br><span class="line">		FPlatformApplicationMisc::<span class="built_in">Init</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		FPlatformMemory::<span class="built_in">Init</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">//------初始化物理引擎------</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;InitGamePhys&quot;</span>);</span><br><span class="line">		<span class="comment">//初始化物理引擎</span></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">InitGamePhys</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// If we failed to initialize physics we cannot continue.</span></span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------初始化引擎文本本地化------</span></span><br><span class="line">	<span class="built_in">InitEngineTextLocalization</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Slate应用是否初始化高DPI</span></span><br><span class="line">	FSlateApplication::<span class="built_in">InitHighDPI</span>(bForceEnableHighDPI);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化引擎Bridge</span></span><br><span class="line">	UStringTable::<span class="built_in">InitializeEngineBridge</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------不是跑在DS下的------</span></span><br><span class="line">	<span class="comment">//展示初始化界面</span></span><br><span class="line">	<span class="comment">//FSlateApplication::Create()</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//------初始化所有的UniformBuffer结构体------</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FUniformBufferStruct::InitializeStructs()&quot;</span>);</span><br><span class="line">		FShaderParametersMetadata::<span class="built_in">InitializeAllUniformBufferStructs</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------初始化RHI-----</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;RHIInit&quot;</span>);</span><br><span class="line">		<span class="comment">// Initialize the RHI.</span></span><br><span class="line">		<span class="built_in">RHIInit</span>(bHasEditorToken);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;RenderUtilsInit&quot;</span>);</span><br><span class="line">		<span class="comment">//基于引擎的配置一次性初始化全局变量</span></span><br><span class="line">		<span class="built_in">RenderUtilsInit</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------初始化ShaderCodeLibrary------</span></span><br><span class="line">	<span class="comment">//------会打开材质着色器代码------</span></span><br><span class="line">	FShaderCodeLibrary::<span class="built_in">InitForRuntime</span>(GMaxRHIShaderPlatform);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------判断是否要编译着色器------</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//cache渲染模块在主线程，我们可以安全地获取它在之后的渲染线程</span></span><br><span class="line">	<span class="built_in">GetRendererModule</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (bEnableShaderCompile)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;InitializeShaderTypes&quot;</span>);</span><br><span class="line">			<span class="comment">//初始化着色器类型，在加载任何着色器之前</span></span><br><span class="line">			<span class="built_in">InitializeShaderTypes</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------这里要注意，开始编译全局ShaderMap------</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//------创建SlateRenderer------</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="comment">//------创建FSlateApplication------</span></span><br><span class="line">	FSlateApplication&amp; CurrentSlateApp = FSlateApplication::<span class="built_in">Get</span>();</span><br><span class="line">	CurrentSlateApp.<span class="built_in">InitializeRenderer</span>(SlateRendererSharedRef);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//------创建引擎字体服务------</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//FPreLoadScreenManager的一些初始化</span></span><br></pre></td></tr></table></figure>



<p>GMalloc，类型为FMalloc，一个全局内存分配器。</p>
<h4 id="FEngineLoop-PreInitPostStartupScreen"><a href="#FEngineLoop-PreInitPostStartupScreen" class="headerlink" title="FEngineLoop::PreInitPostStartupScreen"></a>FEngineLoop::PreInitPostStartupScreen</h4><p><img src="../../Image/FEngineLoop.png" alt="image-20220418225323310"></p>
<h2 id="EditorInit和EngineInit"><a href="#EditorInit和EngineInit" class="headerlink" title="EditorInit和EngineInit"></a>EditorInit和EngineInit</h2><p>EditorInit在Source\Editor\UnrealEd\Private\UnrealEdGlobals.cpp里面定义。</p>
<p>而EngineInit在Launch.cpp里面。</p>
<p><strong>FEngineLoop GEngineLoop</strong>也定义在Launch.cpp里面。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	Inits the engine loop </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//EngineInit比较简单，只是简单地调用GEngineLoop的初始化。</span></span><br><span class="line"><span class="function">int32 <span class="title">EngineInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	int32 ErrorLevel = GEngineLoop.<span class="built_in">Init</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span>( ErrorLevel );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">EditorInit</span><span class="params">(IEngineLoop&amp; EngineLoop)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//创建debug工具进程</span></span><br><span class="line">	GDebugToolExec = <span class="keyword">new</span> FDebugToolExec;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//定义一个stat对象，用来计时，暂时以后研究，RAII记录两次时间</span></span><br><span class="line">	<span class="built_in">DECLARE_SCOPE_CYCLE_COUNTER</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Editor Initialized&quot;</span>), STAT_EditorStartup, STATGROUP_LoadTime);</span><br><span class="line">    </span><br><span class="line">    <span class="function">FScopedSlowTask <span class="title">SlowTask</span><span class="params">(<span class="number">100</span>, NSLOCTEXT(<span class="string">&quot;EngineLoop&quot;</span>, <span class="string">&quot;EngineLoop_Loading&quot;</span>, <span class="string">&quot;Loading...&quot;</span>))</span></span>;</span><br><span class="line">    </span><br><span class="line">    SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">50</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//调用GEngineLoop.Init函数</span></span><br><span class="line">    int32 ErrorLevel = EngineLoop.<span class="built_in">Init</span>();</span><br><span class="line">    <span class="comment">//如果报错，启动画面就隐藏</span></span><br><span class="line">	<span class="keyword">if</span>( ErrorLevel != <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		FPlatformSplash::<span class="built_in">Hide</span>();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>FExec* GDebugToolExec定义在CoreGlobals.cpp里面。</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/438784425">https://zhuanlan.zhihu.com/p/438784425</a> UE4的Stat性能分析工具。</p>
<p><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.26/en-US/TestingAndOptimization/PerformanceAndProfiling/StatCommands/StatsSystemOverview/%E5%AE%98%E7%BD%91%E7%9A%84%E6%96%87%E6%A1%A3%E3%80%82">https://docs.unrealengine.com/4.26/en-US/TestingAndOptimization/PerformanceAndProfiling/StatCommands/StatsSystemOverview/官网的文档。</a></p>
<p>继续EditorInit：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//让分析器知道编辑器已经开始了</span></span><br><span class="line"><span class="comment">//暂时不知道FEngineAnalytics干吗用的</span></span><br><span class="line"><span class="keyword">if</span> ( FEngineAnalytics::<span class="built_in">IsAvailable</span>() )</span><br><span class="line">&#123;</span><br><span class="line">	TArray&lt;FAnalyticsEventAttribute&gt; EventAttributes;</span><br><span class="line">	EventAttributes.<span class="built_in">Add</span>(<span class="built_in">FAnalyticsEventAttribute</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GameName&quot;</span>), FApp::<span class="built_in">GetProjectName</span>()));</span><br><span class="line">	EventAttributes.<span class="built_in">Add</span>(<span class="built_in">FAnalyticsEventAttribute</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;CommandLine&quot;</span>), FCommandLine::<span class="built_in">Get</span>()));</span><br><span class="line"></span><br><span class="line">	FEngineAnalytics::<span class="built_in">GetProvider</span>().<span class="built_in">RecordEvent</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Editor.ProgramStarted&quot;</span>), EventAttributes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">40</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化Misc编辑器</span></span><br><span class="line">FUnrealEdMisc::<span class="built_in">Get</span>().<span class="built_in">OnInit</span>();</span><br><span class="line"></span><br><span class="line">SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//为加载和保存内容文件的默认目录数组设置主目录</span></span><br><span class="line">FEditorDirectories::<span class="built_in">Get</span>().<span class="built_in">LoadLastDirectories</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化actor文件夹单例，管理Actor的</span></span><br><span class="line">FActorFolders::<span class="built_in">Init</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//cache可用的目标对于现在的项目，那么我们可以展示正确的选项在包项目菜单</span></span><br><span class="line">FDesktopPlatformModule::<span class="built_in">Get</span>()-&gt;<span class="built_in">GetTargetsForCurrentProject</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// =================== 核心的Editor初始化已经完毕 ===================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//因此初始化界面，那么所有的事情都可以准备开始了</span></span><br><span class="line">FPlatformSplash::<span class="built_in">Hide</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断我们是否在交互式的模式？</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">bool</span> bIsImmersive = FPaths::<span class="built_in">IsProjectFilePathSet</span>() &amp;&amp; FParse::<span class="built_in">Param</span>( FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>( <span class="string">&quot;immersive&quot;</span> ) );</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行最终的设置步骤在编辑器那帧上，并且展示它</span></span><br><span class="line">&#123;</span><br><span class="line">   	<span class="built_in">TRACE_CPUPROFILER_EVENT_SCOPE</span>(EditorInit::MainFrame);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//拆除渲染线程一次，而不是每次调整窗口大小时都这样做？？</span></span><br><span class="line">       <span class="built_in">SCOPED_SUSPEND_RENDERING_THREAD</span>(<span class="literal">true</span>);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//开始Slate的主frame，还有其它的editor窗口</span></span><br><span class="line">       &#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> bStartImmersive = bIsImmersive;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> bStartPIE = bIsImmersive;</span><br><span class="line">		<span class="comment">//加载模块</span></span><br><span class="line">		IMainFrameModule&amp; MainFrameModule = FModuleManager::LoadModuleChecked&lt;IMainFrameModule&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;MainFrame&quot;</span>));</span><br><span class="line">		MainFrameModule.<span class="built_in">CreateDefaultMainFrame</span>( bStartImmersive, bStartPIE );</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//直接去VR模式，如果我们要求这样的话</span></span><br><span class="line"><span class="built_in">CheckAndMaybeGoToVRModeInternal</span>(bIsImmersive);</span><br><span class="line"></span><br><span class="line"><span class="comment">//检测自动的构建/提交选项</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">bool</span> bDoAutomatedMapBuild = FParse::<span class="built_in">Param</span>( FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;AutomatedMapBuild&quot;</span>) );</span><br><span class="line"></span><br><span class="line"><span class="comment">//促使更新游戏项目文件对于现在的版本，如果可以的话</span></span><br><span class="line"><span class="keyword">if</span> ( FPaths::<span class="built_in">IsProjectFilePathSet</span>() )</span><br><span class="line">&#123;</span><br><span class="line">	FGameProjectGenerationModule::<span class="built_in">Get</span>().<span class="built_in">CheckForOutOfDateGameProjectFile</span>();</span><br><span class="line">	FGameProjectGenerationModule::<span class="built_in">Get</span>().<span class="built_in">CheckAndWarnProjectFilenameValid</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =================== 编辑器初始化完成 ===================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//开始追踪</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> StartupTime = (<span class="keyword">float</span>)( FPlatformTime::<span class="built_in">Seconds</span>() - GStartTime );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( FEngineAnalytics::<span class="built_in">IsAvailable</span>() )</span><br><span class="line">	&#123;</span><br><span class="line">		FEngineAnalytics::<span class="built_in">GetProvider</span>().<span class="built_in">RecordEvent</span>(</span><br><span class="line">			<span class="built_in">TEXT</span>( <span class="string">&quot;Editor.Performance.Startup&quot;</span> ),</span><br><span class="line">			<span class="built_in">TEXT</span>( <span class="string">&quot;Duration&quot;</span> ), FString::<span class="built_in">Printf</span>( <span class="built_in">TEXT</span>( <span class="string">&quot;%.3f&quot;</span> ), StartupTime ) );</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FModuleManager::LoadModuleChecked&lt;IModuleInterface&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;HierarchicalLODOutliner&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//移除所有无效的key，在所有的插件和模块已经被加载的时候</span></span><br><span class="line"><span class="keyword">if</span> (UInputSettings* InputSettings = UInputSettings::<span class="built_in">GetInputSettings</span>())</span><br><span class="line">&#123;</span><br><span class="line">	InputSettings-&gt;<span class="built_in">RemoveInvalidKeys</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>



<p>可以看到EditorInit初始化了一大堆和编辑器有关的东西。</p>
<p><strong>比如Slate的加载。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这里是关键，是界面的初始化</span></span><br><span class="line">IMainFrameModule&amp; MainFrameModule = FModuleManager::LoadModuleChecked&lt;IMainFrameModule&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;MainFrame&quot;</span>));</span><br><span class="line">MainFrameModule.<span class="built_in">CreateDefaultMainFrame</span>( bStartImmersive, bStartPIE );</span><br></pre></td></tr></table></figure>



<h3 id="FEngineLoop-Init"><a href="#FEngineLoop-Init" class="headerlink" title="FEngineLoop::Init()"></a>FEngineLoop::Init()</h3><p>看一下这个FEngineLoop的初始化函数。</p>
<p><strong>定义在LanuchEngineLoop.cpp下面。</strong></p>
<p>Low-Level Memory Tracker</p>
<p><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.27/en-US/ProductionPipelines/DevelopmentSetup/Tools/LowLevelMemoryTracker/">https://docs.unrealengine.com/4.27/en-US/ProductionPipelines/DevelopmentSetup/Tools/LowLevelMemoryTracker/</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">//事件，以及记录初始化开始的地方</span></span><br><span class="line">	<span class="built_in">LLM_SCOPE</span>(ELLMTag::EngineInitMemory);</span><br><span class="line">	<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FEngineLoop::Init&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">DECLARE_SCOPE_CYCLE_COUNTER</span>( <span class="built_in">TEXT</span>( <span class="string">&quot;FEngineLoop::Init&quot;</span> ), STAT_FEngineLoop_Init, STATGROUP_LoadTime );</span><br><span class="line">	<span class="function">FScopedSlowTask <span class="title">SlowTask</span><span class="params">(<span class="number">100</span>)</span></span>;</span><br><span class="line">	SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">10</span>);</span><br><span class="line">	<span class="comment">//暂时不知道干吗用的东东</span></span><br><span class="line">	FEmbeddedCommunication::<span class="built_in">ForceTick</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">	UClass* EngineClass = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">if</span>( !GIsEditor )</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//不是编辑器的分支</span></span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;Create GEngine&quot;</span>);</span><br><span class="line">		<span class="comment">//我们在游戏中</span></span><br><span class="line">		FString GameEngineClassName;</span><br><span class="line">		GConfig-&gt;<span class="built_in">GetString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Script/Engine.Engine&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;GameEngine&quot;</span>), GameEngineClassName, GEngineIni);</span><br><span class="line">        <span class="comment">//加载这个UClass</span></span><br><span class="line">		EngineClass = <span class="built_in">StaticLoadClass</span>( UGameEngine::<span class="built_in">StaticClass</span>(), <span class="literal">nullptr</span>, *GameEngineClassName);</span><br><span class="line">		<span class="keyword">if</span> (EngineClass == <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogInit, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to load UnrealEd Engine class &#x27;%s&#x27;.&quot;</span>), *GameEngineClassName);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//根据这个EngineClass构造GEngine</span></span><br><span class="line">		GEngine = NewObject&lt;UEngine&gt;(<span class="built_in">GetTransientPackage</span>(), EngineClass);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">		<span class="comment">//编辑器</span></span><br><span class="line">		FString UnrealEdEngineClassName;</span><br><span class="line">		GConfig-&gt;<span class="built_in">GetString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Script/Engine.Engine&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;UnrealEdEngine&quot;</span>), UnrealEdEngineClassName, GEngineIni);</span><br><span class="line">		EngineClass = <span class="built_in">StaticLoadClass</span>(UUnrealEdEngine::<span class="built_in">StaticClass</span>(), <span class="literal">nullptr</span>, *UnrealEdEngineClassName);</span><br><span class="line">		<span class="keyword">if</span> (EngineClass == <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogInit, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to load UnrealEd Engine class &#x27;%s&#x27;.&quot;</span>), *UnrealEdEngineClassName);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//构造</span></span><br><span class="line">		GEngine = GEditor = GUnrealEd = NewObject&lt;UUnrealEdEngine&gt;(<span class="built_in">GetTransientPackage</span>(), EngineClass);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="built_in">check</span>(<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;	</span><br></pre></td></tr></table></figure>



<p>可以看到不在编辑器下，GEngine是整个引擎，<strong>而编辑器模式下，GEngine和GEditor和GUnrealEd一样。</strong></p>
<p>构造这个UClass的时候，顺便读入了<strong>配置文件。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">	FEmbeddedCommunication::<span class="built_in">ForceTick</span>(<span class="number">11</span>);</span><br><span class="line">	<span class="comment">//检查一个GEngine初始化成功了没</span></span><br><span class="line">	<span class="built_in">check</span>( GEngine );</span><br><span class="line"></span><br><span class="line">	<span class="built_in">GetMoviePlayer</span>()-&gt;<span class="built_in">PassLoadingScreenWindowBackToGame</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (FPreLoadScreenManager::<span class="built_in">Get</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        FPreLoadScreenManager::<span class="built_in">Get</span>()-&gt;<span class="built_in">PassPreLoadScreenWindowBackToGame</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;GEngine-&gt;ParseCommandline()&quot;</span>);</span><br><span class="line">		GEngine-&gt;<span class="built_in">ParseCommandline</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FEmbeddedCommunication::<span class="built_in">ForceTick</span>(<span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;InitTime&quot;</span>);</span><br><span class="line">		<span class="built_in">InitTime</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">60</span>);</span><br><span class="line">	<span class="comment">//这里关键</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;GEngine-&gt;Init&quot;</span>);</span><br><span class="line">        <span class="comment">//调用GEngine的Init函数</span></span><br><span class="line">		GEngine-&gt;<span class="built_in">Init</span>(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//调用初始化回调</span></span><br><span class="line">	FCoreDelegates::OnPostEngineInit.<span class="built_in">Broadcast</span>();</span><br><span class="line"></span><br><span class="line">	SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化引擎服务实例</span></span><br><span class="line">	<span class="keyword">if</span> (FPlatformProcess::<span class="built_in">SupportsMultithreading</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;SessionService etc&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">IsRunningCommandlet</span>())</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">//SessionService加载</span></span><br><span class="line">			SessionService = FModuleManager::LoadModuleChecked&lt;ISessionServicesModule&gt;(<span class="string">&quot;SessionServices&quot;</span>).<span class="built_in">GetSessionService</span>();</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (SessionService.<span class="built_in">IsValid</span>())</span><br><span class="line">			&#123;</span><br><span class="line">			SessionService-&gt;<span class="built_in">Start</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		EngineService = <span class="keyword">new</span> <span class="built_in">FEngineService</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;IProjectManager::Get().LoadModulesForProject(ELoadingPhase::PostEngineInit)&quot;</span>);</span><br><span class="line">		<span class="comment">//加载所有在引擎前的初始化模块</span></span><br><span class="line">		<span class="keyword">if</span> (!IProjectManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForProject</span>(ELoadingPhase::PostEngineInit) || !IPluginManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForEnabledPlugins</span>(ELoadingPhase::PostEngineInit))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">RequestEngineExit</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;One or more modules failed PostEngineInit&quot;</span>));</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//调用GEngine的Start</span></span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;GEngine-&gt;Start()&quot;</span>);</span><br><span class="line">		GEngine-&gt;<span class="built_in">Start</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FEmbeddedCommunication::<span class="built_in">ForceTick</span>(<span class="number">13</span>);</span><br><span class="line">	<span class="comment">//等待引擎加载完成</span></span><br><span class="line">    <span class="keyword">if</span> (FPreLoadScreenManager::<span class="built_in">Get</span>() &amp;&amp; FPreLoadScreenManager::<span class="built_in">Get</span>()-&gt;<span class="built_in">HasActivePreLoadScreenType</span>(EPreLoadScreenTypes::EngineLoadingScreen))</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;WaitForEngineLoadingScreenToFinish&quot;</span>);</span><br><span class="line">		FPreLoadScreenManager::<span class="built_in">Get</span>()-&gt;<span class="built_in">SetEngineLoadingComplete</span>(<span class="literal">true</span>);</span><br><span class="line">        FPreLoadScreenManager::<span class="built_in">Get</span>()-&gt;<span class="built_in">WaitForEngineLoadingScreenToFinish</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;WaitForMovieToFinish&quot;</span>);</span><br><span class="line">		<span class="built_in">GetMoviePlayer</span>()-&gt;<span class="built_in">WaitForMovieToFinish</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//加载一些模块</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_AUTOMATION_WORKER</span></span><br><span class="line">	FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="string">&quot;AutomationWorker&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_ENGINE &amp;&amp; !UE_BUILD_SHIPPING</span></span><br><span class="line">	FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="string">&quot;AutomationController&quot;</span>);</span><br><span class="line">	FModuleManager::GetModuleChecked&lt;IAutomationControllerModule&gt;(<span class="string">&quot;AutomationController&quot;</span>).<span class="built_in">Init</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">//------编辑器下加载Sequence有关的模块，还有Profiler客户端------</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">	<span class="keyword">if</span> (GIsEditor)</span><br><span class="line">	&#123;</span><br><span class="line">		FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ProfilerClient&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;SequenceRecorder&quot;</span>));</span><br><span class="line">	FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;SequenceRecorderSections&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">//GIsRunning设置为true</span></span><br><span class="line">	GIsRunning = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!GIsEditor)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// hide a couple frames worth of rendering</span></span><br><span class="line">		FViewport::<span class="built_in">SetGameRenderingEnabled</span>(<span class="literal">true</span>, <span class="number">3</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FEmbeddedCommunication::<span class="built_in">ForceTick</span>(<span class="number">15</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定一个委托</span></span><br><span class="line">	FCoreDelegates::StarvedGameLoop.<span class="built_in">BindStatic</span>(&amp;GameLoopIsStarved);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//准备去测量线程心跳</span></span><br><span class="line">	FThreadHeartBeat::<span class="built_in">Get</span>().<span class="built_in">Start</span>();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//ShaderPipelineCache暂停合批</span></span><br><span class="line">	FShaderPipelineCache::<span class="built_in">PauseBatching</span>();</span><br><span class="line">   	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(WITH_CODE_GUARD_HANDLER) &amp;&amp; WITH_CODE_GUARD_HANDLER</span></span><br><span class="line">         <span class="function"><span class="keyword">void</span> <span class="title">CheckImageIntegrity</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="built_in">CheckImageIntegrity</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FCoreDelegates::OnFEngineLoopInitComplete.Broadcast()&quot;</span>);</span><br><span class="line">        <span class="comment">//------委托调用一下------</span></span><br><span class="line">		FCoreDelegates::OnFEngineLoopInitComplete.<span class="built_in">Broadcast</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//恢复核批</span></span><br><span class="line">	FShaderPipelineCache::<span class="built_in">ResumeBatching</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BUILD_EMBEDDED_APP</span></span><br><span class="line">	FEmbeddedCommunication::<span class="built_in">AllowSleep</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Startup&quot;</span>));</span><br><span class="line">	FEmbeddedCommunication::<span class="built_in">KeepAwake</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;FirstTicks&quot;</span>), <span class="literal">true</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_EXTERNAL_PROFILING_ENABLED</span></span><br><span class="line">	FExternalProfiler* ActiveProfiler = FActiveExternalProfilerBase::<span class="built_in">InitActiveProfiler</span>();</span><br><span class="line">	<span class="keyword">if</span> (ActiveProfiler)</span><br><span class="line">	&#123;</span><br><span class="line">		ActiveProfiler-&gt;<span class="built_in">Register</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>		<span class="comment">// UE_EXTERNAL_PROFILING_ENABLED</span></span></span><br><span class="line"></span><br><span class="line">	FDelayedAutoRegisterHelper::<span class="built_in">RunAndClearDelayedAutoRegisterDelegates</span>(EDelayedRegisterRunPhase::EndOfEngineInit);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Emit logging. Don&#x27;t edit! Automation looks for this to detect failures during initialization.</span></span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogInit, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;Engine is initialized. Leaving FEngineLoop::Init()&quot;</span>));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>



<p>这里主要调用GEngine的Init和Start函数。</p>
<p>GEngine定义在Source\Runtime\Engine\Classes\Engine\Engine.h下。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" data-id="cl24x8q1j0000qwsz801p4mbx" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2021/12/12/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/12/12/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>