<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-SlateRenderer" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/21/SlateRenderer/" class="article-date">
  <time class="dt-published" datetime="2022-04-21T02:45:18.667Z" itemprop="datePublished">2022-04-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/21/SlateRenderer/">SlateRenderer</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>暂时只看Windows平台下的SlateRenderer是怎么实现的。</p>
<img src="/2022/04/21/SlateRenderer/SlateRenderer2.png" class title="image-20220421104715003">

<p>这两个是给独立的应用程序使用的。</p>
<img src="/2022/04/21/SlateRenderer/SlateRHI.png" class title="image-20220421105706110">

<p>SlateRHIRenderer是给引擎使用的。</p>
<h1 id="FSlateRenderer"><a href="#FSlateRenderer" class="headerlink" title="FSlateRenderer"></a>FSlateRenderer</h1><img src="/2022/04/21/SlateRenderer/SlateRenderer3.png" class title="image-20220421113605951">

<p>这个是2D的接口所在的文件。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SLATECORE_API</span> <span class="title">FSlateRenderer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 构造函数 */</span></span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">FSlateRenderer</span><span class="params">(<span class="keyword">const</span> TSharedRef&lt;FSlateFontServices&gt;&amp; InSlateFontServices)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 虚析构函数 */</span></span><br><span class="line">	<span class="keyword">virtual</span> ~<span class="built_in">FSlateRenderer</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">/** 返回一个draw buffer可以被Slate windows使用，去绘制window元素 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FSlateDrawBuffer&amp; <span class="title">GetDrawBuffer</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Initialize</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Destroy</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建一个渲染视口</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * InWindow:要创建渲染视口的Window</span></span><br><span class="line"><span class="comment">	 */</span> </span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CreateViewport</span><span class="params">( <span class="keyword">const</span> TSharedRef&lt;SWindow&gt; InWindow )</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 请求视口重新改变大小</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param Window		需要重新改变大小的窗口</span></span><br><span class="line"><span class="comment">	 * @param Width			窗口的新宽度</span></span><br><span class="line"><span class="comment">	 * @param Height		窗口的新高度</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">RequestResize</span><span class="params">( <span class="keyword">const</span> TSharedPtr&lt;SWindow&gt;&amp; InWindow, uint32 NewSizeX, uint32 NewSizeY )</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 在Window的视口上设置全屏状态</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param	InWindow		要更新全屏状态的窗口</span></span><br><span class="line"><span class="comment">	 * @param	OverrideResX	0 if no override</span></span><br><span class="line"><span class="comment">	 * @param	OverrideResY	0 if no override</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">UpdateFullscreenState</span><span class="params">( <span class="keyword">const</span> TSharedRef&lt;SWindow&gt; InWindow, uint32 OverrideResX = <span class="number">0</span>, uint32 OverrideResY = <span class="number">0</span> )</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 通过引擎设置系统的分辨率</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param	Width			系统分辨率的宽度</span></span><br><span class="line"><span class="comment">	 * @param	Height			系统分辨率的高度</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetSystemResolution</span><span class="params">(uint32 Width, uint32 Height)</span> </span>= <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 恢复给定的window到分辨率设置，分辨率现状通过engine来cached</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * @param InWindow    -&gt; The window to restore to the cached settings</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">RestoreSystemResolution</span><span class="params">(<span class="keyword">const</span> TSharedRef&lt;SWindow&gt; InWindow)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	 * 创建必要的资源去渲染一个窗口，并且发送渲染命令到渲染线程</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param WindowDrawBuffer	buffer包含了要绘制的渲染元素</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DrawWindows</span><span class="params">( FSlateDrawBuffer&amp; InWindowDrawBuffer )</span> </span>= <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** 一个回调函数，在slate渲染了每一个窗口，每一帧后使用 */</span></span><br><span class="line">	<span class="built_in">DECLARE_MULTICAST_DELEGATE_TwoParams</span>( FOnSlateWindowRendered, SWindow&amp;, <span class="keyword">void</span>* );</span><br><span class="line">	<span class="function">FOnSlateWindowRendered&amp; <span class="title">OnSlateWindowRendered</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> SlateWindowRendered; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 在游戏线程上里面销毁</span></span><br><span class="line"><span class="comment">	 * 这个可以销毁视口确定的资源</span></span><br><span class="line"><span class="comment">	 * @param Pointer to the API specific backbuffer type</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="built_in">DECLARE_MULTICAST_DELEGATE_OneParam</span>(FOnSlateWindowDestroyed, <span class="keyword">void</span>*);</span><br><span class="line">	<span class="function">FOnSlateWindowDestroyed&amp; <span class="title">OnSlateWindowDestroyed</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> OnSlateWindowDestroyedDelegate; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 在窗口被缩放之前，在游戏线程里面调用</span></span><br><span class="line"><span class="comment">	 * @param Pointer to the API specific backbuffer type</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="built_in">DECLARE_MULTICAST_DELEGATE_OneParam</span>(FOnPreResizeWindowBackbuffer, <span class="keyword">void</span>*);</span><br><span class="line">	<span class="function">FOnPreResizeWindowBackbuffer&amp; <span class="title">OnPreResizeWindowBackBuffer</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> PreResizeBackBufferDelegate; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 在窗口缩放之后，在游戏线程里面调用</span></span><br><span class="line"><span class="comment">	 * @param Pointer to the API specific backbuffer type</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="built_in">DECLARE_MULTICAST_DELEGATE_OneParam</span>(FOnPostResizeWindowBackbuffer, <span class="keyword">void</span>*);</span><br><span class="line">	<span class="function">FOnPostResizeWindowBackbuffer&amp; <span class="title">OnPostResizeWindowBackBuffer</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> PostResizeBackBufferDelegate; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 在slate渲染完毕之后，准备呈现出来的时候，进行调用 */</span></span><br><span class="line">	<span class="built_in">DECLARE_MULTICAST_DELEGATE_TwoParams</span>(FOnBackBufferReadyToPresent, SWindow&amp;, <span class="keyword">const</span> FTexture2DRHIRef&amp;);</span><br><span class="line">	<span class="function">FOnBackBufferReadyToPresent&amp; <span class="title">OnBackBufferReadyToPresent</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> OnBackBufferReadyToPresentDelegate; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	 * 设置哪个颜色画面过滤器去使用</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetColorVisionDeficiencyType</span><span class="params">(EColorVisionDeficiency Type, int32 Severity, <span class="keyword">bool</span> bCorrectDeficiency, <span class="keyword">bool</span> bShowCorrectionWithDeficiency)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	 * 创建一个动态的图像资源并且返回它的大小</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param InTextureName The name of the texture resource</span></span><br><span class="line"><span class="comment">	 * @return The size of the loaded texture</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FIntPoint <span class="title">GenerateDynamicImageResource</span><span class="params">(<span class="keyword">const</span> FName InTextureName)</span> </span>&#123;<span class="built_in">check</span>(<span class="number">0</span>); <span class="keyword">return</span> <span class="built_in">FIntPoint</span>( <span class="number">0</span>, <span class="number">0</span> );&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建一个动态的图像资源</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param ResourceName		图像资源的名字</span></span><br><span class="line"><span class="comment">	 * @param Width				资源的宽度</span></span><br><span class="line"><span class="comment">	 * @param Height			图像的高度</span></span><br><span class="line"><span class="comment">	 * @param Bytes				资源的负载</span></span><br><span class="line"><span class="comment">	 * @return					如果资源成功地生成，返回true，否则返回false</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">GenerateDynamicImageResource</span><span class="params">( FName ResourceName, uint32 Width, uint32 Height, <span class="keyword">const</span> TArray&lt; uint8 &gt;&amp; Bytes )</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">GenerateDynamicImageResource</span><span class="params">(FName ResourceName, FSlateTextureDataRef TextureData)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建一个句柄指向slate资源</span></span><br><span class="line"><span class="comment">	 * 一个句柄被用来快速地查找对于一个给定brush的渲染资源，当添加slate绘制元素的时候</span></span><br><span class="line"><span class="comment">	 * 这个可以被用来cached并且安全地恢复在代码中，它会是无效的，当一个资源被销毁的时候</span></span><br><span class="line"><span class="comment">	 * 创建一个资源是非常昂贵的，最好不要用在性能敏感的区域</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param	Brush		The brush to get a rendering resource handle </span></span><br><span class="line"><span class="comment">	 * @return	The created resource handle.  </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FSlateResourceHandle <span class="title">GetResourceHandle</span><span class="params">( <span class="keyword">const</span> FSlateBrush&amp; Brush )</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 默认的实现假设所有的资源都是可渲染的 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">CanRenderResource</span><span class="params">(UObject&amp; InResourceObject)</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 入队一个将要被移除的brush</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param BrushToRemove	The brush to queue for removal which is no longer valid to use</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">RemoveDynamicBrushResource</span><span class="params">( TSharedPtr&lt;FSlateDynamicImageBrush&gt; BrushToRemove )</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	 * 释放一个确切的资源</span></span><br><span class="line"><span class="comment">	 * It is unlikely that you want to call this directly.  Use RemoveDynamicBrushResource instead</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ReleaseDynamicResource</span><span class="params">( <span class="keyword">const</span> FSlateBrush&amp; Brush )</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 当窗口销毁的时候，给渲染器一个机会去释放资源 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnWindowDestroyed</span><span class="params">( <span class="keyword">const</span> TSharedRef&lt;SWindow&gt;&amp; InWindow )</span> </span>= <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** 当一个窗口准备重塑的时候 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnWindowFinishReshaped</span><span class="params">(<span class="keyword">const</span> TSharedPtr&lt;SWindow&gt;&amp; InWindow)</span> </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 提供一个视口资源(后台缓冲区)给窗口使用</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param Window	The window to get the viewport from </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span>* <span class="title">GetViewportResource</span><span class="params">( <span class="keyword">const</span> SWindow&amp; Window )</span> </span>&#123; <span class="keyword">return</span> <span class="literal">nullptr</span>; &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 询问给这个渲染器使用的字体服务</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">TSharedRef&lt;FSlateFontServices&gt; <span class="title">GetFontServices</span><span class="params">()</span> <span class="keyword">const</span> </span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> SlateFontServices.<span class="built_in">ToSharedRef</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 询问字体测量服务(游戏线程使用)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">TSharedRef&lt;class FSlateFontMeasure&gt; <span class="title">GetFontMeasureService</span><span class="params">()</span> <span class="keyword">const</span> </span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> SlateFontServices-&gt;<span class="built_in">GetFontMeasureService</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取字体cache给当前的线程使用</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">TSharedRef&lt;class FSlateFontCache&gt; <span class="title">GetFontCache</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> SlateFontServices-&gt;<span class="built_in">GetFontCache</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 冲刷出所有字体cache对于当前的线程</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">FlushFontCache</span><span class="params">(<span class="keyword">const</span> FString&amp; FlushReason)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		SlateFontServices-&gt;<span class="built_in">FlushFontCache</span>(FlushReason);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 给予渲染器一个机会去等待所有的命令已经完成</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">FlushCommands</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 给予渲染器一个机会去等待另一个线程完成</span></span><br><span class="line"><span class="comment">	 * 这个函数等待同步完成才返回</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Sync</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;&#125;;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 表示渲染器的新一帧 这个函数被Engine Loop使用</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BeginFrame</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;&#125;;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 表示渲染器当前帧的最后的情况 这个函数被Engine Loop使用</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">EndFrame</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 从磁盘上加载所有的资源</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ReloadTextureResources</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 加载所有被Style使用的资源</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">LoadStyleResources</span><span class="params">( <span class="keyword">const</span> ISlateStyle&amp; Style )</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 检查视口是否在全屏中</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @Window	The window to check for fullscreen</span></span><br><span class="line"><span class="comment">	 * @return true if the window&#x27;s viewport should be fullscreen</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">IsViewportFullscreen</span><span class="params">( <span class="keyword">const</span> SWindow&amp; Window )</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 检查slate依赖的shader是否已经编译好 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">AreShadersInitialized</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	 * 检查到FViewportRHI&#x27;的引用  </span></span><br><span class="line"><span class="comment">	 * This has to be done explicitly instead of using the FRenderResource mechanism because FViewportRHI&#x27;s are managed by the game thread.</span></span><br><span class="line"><span class="comment">	 * This is needed before destroying the RHI device. </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">InvalidateAllViewports</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * A renderer may need to keep a cache of accessed garbage collectible objects alive for the duration of their</span></span><br><span class="line"><span class="comment">	 * usage.  During some operations like ending a game.  It becomes important to immediately release game related</span></span><br><span class="line"><span class="comment">	 * resources.  This should flush any buffer holding onto those referenced objects.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ReleaseAccessedResources</span><span class="params">(<span class="keyword">bool</span> bImmediatelyFlush)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	 * 准备截取UI的一帧。  Rect是渲染输出的一部分比例。</span></span><br><span class="line"><span class="comment">	 * 会存储在FColor的数组中。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PrepareToTakeScreenshot</span><span class="params">(<span class="keyword">const</span> FIntRect&amp; Rect, TArray&lt;FColor&gt;* OutColorData, SWindow* InScreenshotWindow)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 压入确切的window到给定的渲染视口</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetWindowRenderTarget</span><span class="params">(<span class="keyword">const</span> SWindow&amp; Window, class IViewportRenderTargetProvider* Provider)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建一个可更新的纹理</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param	Width	Initial width of the texture</span></span><br><span class="line"><span class="comment">	 * @param	Height	Initial height of the texture</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @return	Newly created updatable texture</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FSlateUpdatableTexture* <span class="title">CreateUpdatableTexture</span><span class="params">(uint32 Width, uint32 Height)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 释放这个可更新的纹理</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param	Texture	The texture we are releasing (should not use this pointer after calling)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ReleaseUpdatableTexture</span><span class="params">(FSlateUpdatableTexture* Texture)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 返回关于这个渲染器有关的图集信息</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> ISlateAtlasProvider* <span class="title">GetTextureAtlasProvider</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 返回一种方式用来访问这个渲染器有关的字体信息</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> ISlateAtlasProvider* <span class="title">GetFontAtlasProvider</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 拷贝所有的slatewindow到一个指定的buffer，只有一半的分辨率</span></span><br><span class="line"><span class="comment">	 * like the mouse cursor and any keypresses.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CopyWindowsToVirtualScreenBuffer</span><span class="params">(<span class="keyword">const</span> TArray&lt;FString&gt;&amp; KeypressBuffer)</span> </span>&#123;&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** 允许和禁止访问CPU */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">MapVirtualScreenBuffer</span><span class="params">(FMappedTextureBuffer* OutImageData)</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">UnmapVirtualScreenBuffer</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 有必要去抓取，在冲刷进资源池之前，因为它可能被多个线程访问，当加载的时候</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FCriticalSection* <span class="title">GetResourceCriticalSection</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    注册渲染器的激活的场景指针。这个将返回场景内部的索引，会被用来给所有连续的元素进行绘制。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> int32 <span class="title">RegisterCurrentScene</span><span class="params">(FSceneInterface* Scene)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 返回现在注册的场景索引 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> int32 <span class="title">GetCurrentSceneIndex</span><span class="params">()</span> <span class="keyword">const</span>  </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 重载内部的场景跟踪 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ClearScenes</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DestroyCachedFastPathRenderingData</span><span class="params">(struct FSlateCachedFastPathRenderingData* VertexData)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DestroyCachedFastPathElementData</span><span class="params">(struct FSlateCachedElementData* ElementData)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HasLostDevice</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 让渲染器知道我们要渲染一些小器具到Render Target</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * @param Context						The context that describes what we&#x27;re rendering to</span></span><br><span class="line"><span class="comment">	 * @param bDeferredRenderTargetUpdate	Whether or not the update is deferred until the end of the frame when it is potentially less expensive to update the render target. </span></span><br><span class="line"><span class="comment">											See GDeferRetainedRenderingRenderThread for more info.</span></span><br><span class="line"><span class="comment">											Care must be taken to destroy anything referenced in the context when it is safe to do so.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AddWidgetRendererUpdate</span><span class="params">(<span class="keyword">const</span> struct FRenderThreadUpdateContext&amp; Context, <span class="keyword">bool</span> bDeferredRenderTargetUpdate)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> EPixelFormat <span class="title">GetSlateRecommendedColorFormat</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> PF_B8G8R8A8; &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Non-copyable</span></span><br><span class="line">	<span class="built_in">FSlateRenderer</span>(<span class="keyword">const</span> FSlateRenderer&amp;);</span><br><span class="line">	FSlateRenderer&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> FSlateRenderer&amp;);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">HandleFontCacheReleaseResources</span><span class="params">(<span class="keyword">const</span> class FSlateFontCache&amp; InFontCache)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 用来给这个渲染器绘制字体文本的字体服务器 */</span></span><br><span class="line">	TSharedPtr&lt;FSlateFontServices&gt; SlateFontServices;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 在slate渲染完后的回调 */</span></span><br><span class="line">	FOnSlateWindowRendered SlateWindowRendered;</span><br><span class="line"></span><br><span class="line">	FOnSlateWindowDestroyed OnSlateWindowDestroyedDelegate;</span><br><span class="line">	FOnPreResizeWindowBackbuffer PreResizeBackBufferDelegate;</span><br><span class="line">	FOnPostResizeWindowBackbuffer PostResizeBackBufferDelegate;</span><br><span class="line"></span><br><span class="line">	FOnBackBufferReadyToPresent OnBackBufferReadyToPresentDelegate;</span><br><span class="line">	FCriticalSection ResourceCriticalSection;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">FSlateRenderDataHandle</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h1 id="FSlateD3DRenderer"><a href="#FSlateD3DRenderer" class="headerlink" title="FSlateD3DRenderer"></a>FSlateD3DRenderer</h1><p>先看一下这个FSlateD3DRenderer，再看一下FSlateRHIRenderer。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FSlateD3DRenderer::<span class="built_in">FSlateD3DRenderer</span>( <span class="keyword">const</span> ISlateStyle&amp; InStyle )</span><br><span class="line">	: <span class="built_in">FSlateRenderer</span>( <span class="built_in">CreateD3DFontServices</span>() )</span><br><span class="line">	, <span class="built_in">bHasAttemptedInitialization</span>(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	ViewMatrix = <span class="built_in">FMatrix</span>(	<span class="built_in">FPlane</span>(<span class="number">1</span>,	<span class="number">0</span>,	<span class="number">0</span>,	<span class="number">0</span>),</span><br><span class="line">							<span class="built_in">FPlane</span>(<span class="number">0</span>,	<span class="number">1</span>,	<span class="number">0</span>,	<span class="number">0</span>),</span><br><span class="line">							<span class="built_in">FPlane</span>(<span class="number">0</span>,	<span class="number">0</span>,	<span class="number">1</span>,  <span class="number">0</span>),</span><br><span class="line">							<span class="built_in">FPlane</span>(<span class="number">0</span>,	<span class="number">0</span>,	<span class="number">0</span>,	<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>FSlateD3DRenderer<strong>创建了一个ViewMatrix</strong>，单位矩阵。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//------初始化函数------</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FSlateD3DRenderer::Initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!bHasAttemptedInitialization)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//------创建D3D设备------</span></span><br><span class="line">		<span class="keyword">bool</span> bResult = <span class="built_in">CreateDevice</span>();</span><br><span class="line">		<span class="keyword">if</span> (bResult)</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">//表示D3D设备是否遭遇错误，先置为false</span></span><br><span class="line">			GEncounteredCriticalD3DDeviceError = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//创建一个纹理管理器</span></span><br><span class="line">			TextureManager = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> FSlateD3DTextureManager);</span><br><span class="line">			</span><br><span class="line">            <span class="comment">//加载要使用的纹理</span></span><br><span class="line">			<span class="keyword">if</span> (!GEncounteredCriticalD3DDeviceError)</span><br><span class="line">			&#123;</span><br><span class="line">				TextureManager-&gt;<span class="built_in">LoadUsedTextures</span>();</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">            <span class="comment">//创建渲染策略类，将SlateFont字体服务和纹理管理器传入构造函数</span></span><br><span class="line">			<span class="keyword">if</span> (!GEncounteredCriticalD3DDeviceError)</span><br><span class="line">			&#123;</span><br><span class="line">				RenderingPolicy = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FSlateD3D11RenderingPolicy</span>(SlateFontServices.<span class="built_in">ToSharedRef</span>(), TextureManager.<span class="built_in">ToSharedRef</span>()));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//创建ElementBatcher</span></span><br><span class="line">			<span class="keyword">if</span> (!GEncounteredCriticalD3DDeviceError)</span><br><span class="line">			&#123;</span><br><span class="line">				ElementBatcher = MakeUnique&lt;FSlateElementBatcher&gt;(RenderingPolicy.<span class="built_in">ToSharedRef</span>());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			GEncounteredCriticalD3DDeviceError = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化成功</span></span><br><span class="line">	bHasAttemptedInitialization = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">return</span> bHasAttemptedInitialization &amp;&amp; !GEncounteredCriticalD3DDeviceError;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="FSlateD3DVertexBuffer"><a href="#FSlateD3DVertexBuffer" class="headerlink" title="FSlateD3DVertexBuffer"></a>FSlateD3DVertexBuffer</h2><p>顶点缓冲区包含了所有的Slate顶点。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FSlateD3DVertexBuffer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">FSlateD3DVertexBuffer</span>();</span><br><span class="line">	~<span class="built_in">FSlateD3DVertexBuffer</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 初始化顶点缓冲区的RHI资源 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">CreateBuffer</span><span class="params">( uint32 InStride )</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 释放顶点缓冲区的RHI资源 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">DestroyBuffer</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 返回缓冲区的字节大小 */</span></span><br><span class="line">	<span class="function">uint32 <span class="title">GetBufferSize</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> BufferSize; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 重新缩放buffer到指定的NewSize */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ResizeBuffer</span><span class="params">( uint32 NewSize )</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span>* <span class="title">Lock</span><span class="params">( uint32 Offset )</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Unlock</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">TRefCountPtr&lt;ID3D11Buffer&gt; <span class="title">GetResource</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Buffer; &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">/** buffer的字节大小 */</span></span><br><span class="line">	uint32 BufferSize;</span><br><span class="line">	uint32 Stride;</span><br><span class="line">	TRefCountPtr&lt;ID3D11Buffer&gt; Buffer;</span><br><span class="line">	<span class="comment">/** 隐藏的拷贝函数 */</span></span><br><span class="line">	<span class="built_in">FSlateD3DVertexBuffer</span>( <span class="keyword">const</span> FSlateD3DVertexBuffer&amp; );</span><br><span class="line">	<span class="keyword">void</span> <span class="keyword">operator</span>=(<span class="keyword">const</span> FSlateD3DVertexBuffer&amp; );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>CreateBuffer，创建了一个ID3D11Buffer，<strong>总共是2000 * InStride字节大小。</strong></p>
<p>ResizeBuffer，根据参数改变了Buffer大小，<strong>但是会将之前的拷贝进来。</strong></p>
<h2 id="FSlateD3DIndexBuffer"><a href="#FSlateD3DIndexBuffer" class="headerlink" title="FSlateD3DIndexBuffer"></a>FSlateD3DIndexBuffer</h2><p>FSlateD3DIndexBuffer和FSlateD3DVertexBuffer也一样，但是索引个数，最大是1000个。</p>
<h2 id="FSlateD3DConstantBuffer"><a href="#FSlateD3DConstantBuffer" class="headerlink" title="FSlateD3DConstantBuffer"></a>FSlateD3DConstantBuffer</h2><p>FSlateD3DConstantBuffer&lt;BufferType&gt;一个模板函数，<strong>用来创建D3D的常量缓冲区的。</strong></p>
<h2 id="FSlateD3DTexture"><a href="#FSlateD3DTexture" class="headerlink" title="FSlateD3DTexture"></a>FSlateD3DTexture</h2><p>FSlateD3DTexture继承自ID3D11ShaderResourceView，<strong>之后着色器可以通过这个接口来访问相关的资源。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FSlateD3DTexture</span> :</span> <span class="keyword">public</span> TSlateTexture&lt; TRefCountPtr&lt;ID3D11ShaderResourceView&gt; &gt;, <span class="keyword">public</span> FSlateUpdatableTexture</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">FSlateD3DTexture</span>( uint32 InSizeX, uint32 InSizeY )</span><br><span class="line">		: <span class="built_in">TSlateTexture</span>()</span><br><span class="line">		, <span class="built_in">SizeX</span>(InSizeX)</span><br><span class="line">		, <span class="built_in">SizeY</span>(InSizeY)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	~<span class="built_in">FSlateD3DTexture</span>()</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Init</span><span class="params">( DXGI_FORMAT InFormat, D3D11_SUBRESOURCE_DATA* InitalData = <span class="literal">NULL</span>, <span class="keyword">bool</span> bUpdatable = <span class="literal">false</span>, <span class="keyword">bool</span> bUseStagingTexture = <span class="literal">false</span> )</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Cleanup</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">delete</span> <span class="keyword">this</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">uint32 <span class="title">GetWidth</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> SizeX; &#125;</span><br><span class="line">	<span class="function">uint32 <span class="title">GetHeight</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> SizeY; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">TRefCountPtr&lt;ID3D11Texture2D&gt; <span class="title">GetTextureResource</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> D3DTexture; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// FSlateUpdatable的接口</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FSlateShaderResource* <span class="title">GetSlateResource</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ResizeTexture</span><span class="params">( uint32 Width, uint32 Height )</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">UpdateTexture</span><span class="params">(<span class="keyword">const</span> TArray&lt;uint8&gt;&amp; Bytes)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">UpdateTextureThreadSafe</span><span class="params">(<span class="keyword">const</span> TArray&lt;uint8&gt;&amp; Bytes)</span> <span class="keyword">override</span> </span>&#123; <span class="built_in">UpdateTexture</span>(Bytes); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">UpdateTextureThreadSafeRaw</span><span class="params">(uint32 Width, uint32 Height, <span class="keyword">const</span> <span class="keyword">void</span>* Buffer, <span class="keyword">const</span> FIntRect&amp; Dirty = FIntRect())</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">UpdateTextureThreadSafeWithTextureData</span><span class="params">(FSlateTextureData* TextureData)</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">//一个帮助函数，可以被不同的更新函数所使用</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">UpdateTextureRaw</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* Buffer, <span class="keyword">const</span> FIntRect&amp; Dirty)</span></span>;</span><br><span class="line">	<span class="comment">/** 真正的纹理 */</span></span><br><span class="line">	TRefCountPtr&lt;ID3D11Texture2D&gt; D3DTexture;</span><br><span class="line">	<span class="comment">/** 暂存在内存上的纹理，主要拿来更新的 */</span></span><br><span class="line">	TRefCountPtr&lt;ID3D11Texture2D&gt; StagingTexture;</span><br><span class="line">    <span class="comment">//宽高</span></span><br><span class="line">	uint32 SizeX;</span><br><span class="line">	uint32 SizeY;</span><br><span class="line">    <span class="comment">//每个像素的字节</span></span><br><span class="line">	uint32 BytesPerPixel;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>Init函数会根据是否可以更新从而创建暂存纹理，<strong>也会根据像素通道个数创建只有1个通道或者4个通道的纹理。</strong></p>
<p><strong>UpdateTextureRaw</strong>会进行纹理的更新，第二个参数<strong>表示暂存纹理的肮脏区域</strong>，如果有暂存纹理，就进行暂存纹理到实际纹理的拷贝，否则直接进行整个实际纹理的更新。</p>
<h2 id="FSlateTextureAtlasD3D"><a href="#FSlateTextureAtlasD3D" class="headerlink" title="FSlateTextureAtlasD3D"></a>FSlateTextureAtlasD3D</h2><p>FSlateTextureAtlasD3D继承自FSlateTextureAtlas，持有一个真正的纹理资源，FSlateD3DTexture。</p>
<h2 id="FSlateFontAtlasD3D"><a href="#FSlateFontAtlasD3D" class="headerlink" title="FSlateFontAtlasD3D"></a>FSlateFontAtlasD3D</h2><p>FSlateFontAtlas也继承自FSlateFontAtlas，持有一个真正的纹理，每个字体都<strong>根据自己的边界</strong>紧紧地挨着。</p>
<img src="/2022/04/21/SlateRenderer/SlateTexture.png" class title="image-20220421142734009">

<p>它们所继承的类都在这，<strong>说明相关的逻辑都是在SlateCore或者Slate里面</strong>，而渲染器则继承里面的一部分类。</p>
<h1 id="ISlate3DRenderer"><a href="#ISlate3DRenderer" class="headerlink" title="ISlate3DRenderer"></a>ISlate3DRenderer</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISlate3DRenderer</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">virtual</span> ~<span class="built_in">ISlate3DRenderer</span>()&#123;&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 设置是否应当在gamma空间进行渲染 */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetUseGammaCorrection</span><span class="params">(<span class="keyword">bool</span> bUseGammaCorrection)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetApplyColorDeficiencyCorrection</span><span class="params">(<span class="keyword">bool</span> bApplyColorCorrection)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 返回可用的buffer用来绘制 */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> FSlateDrawBuffer&amp; <span class="title">GetDrawBuffer</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    合批绘制元素在buffer中，用来渲染</span></span><br><span class="line"><span class="comment">    调用这个，在游戏线程中，在发送它到渲染线程之前</span></span><br><span class="line"><span class="comment">    参数是要准备的draw buffer</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DrawWindow_GameThread</span><span class="params">(FSlateDrawBuffer&amp; DrawBuffer)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    渲染draw buffer的合批绘制元素到给定的Render Target中</span></span><br><span class="line"><span class="comment">    在准备好draw buffer后进行绘制</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    RenderTarget drawbuffer要绘制到的render target</span></span><br><span class="line"><span class="comment">    InDrawBuffer drawbuffer包含了合批的元素要进行绘制</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DrawWindowToTarget_RenderThread</span><span class="params">(FRHICommandListImmediate&amp; RHICmdList, <span class="keyword">const</span> struct FRenderThreadUpdateContext&amp; Context)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> TSharedPtr&lt;ISlate3DRenderer, ESPMode::ThreadSafe&gt; ISlate3DRendererPtr;</span><br></pre></td></tr></table></figure>

<p>这个是Slate3D渲染器的接口。</p>
<p>这个在SlateRHIRenderer&#x2F;Public&#x2F;Interfaces&#x2F;ISlate3DRenderer.h里面</p>
<h1 id="ISlateRHIRenderer"><a href="#ISlateRHIRenderer" class="headerlink" title="ISlateRHIRenderer"></a>ISlateRHIRenderer</h1><p>FEngineLoop::PreInitPreStartupScreen里面<strong>会调用这个。</strong></p>
<img src="/2022/04/21/SlateRenderer/CreateSlateRHIRenderer.png" class title="image-20220425103930679">



<p>编辑器状态下，会使用这个SlateRHIRenderer。</p>
<p>服务器状态下，会使用那个空的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> SlateRHIConstants</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//当绘制窗口的时候，可以交互的顶点和索引缓冲区数量</span></span><br><span class="line">	<span class="keyword">const</span> int32 NumBuffers = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对于Slate RHI Renderer Module的接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISlateRHIRendererModule</span></span></span><br><span class="line"><span class="class">	:</span> <span class="keyword">public</span> IModuleInterface</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建一个Slate RHI Module</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @返回一个新的渲染器</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> TSharedRef&lt;FSlateRenderer&gt; <span class="title">CreateSlateRHIRenderer</span><span class="params">( )</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> TSharedRef&lt;ISlate3DRenderer, ESPMode::ThreadSafe&gt; <span class="title">CreateSlate3DRenderer</span><span class="params">(<span class="keyword">bool</span> bUseGammaCorrection)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> TSharedRef&lt;ISlateFontAtlasFactory&gt; <span class="title">CreateSlateFontAtlasFactory</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> TSharedRef&lt;ISlateUpdatableInstanceBuffer&gt; <span class="title">CreateInstanceBuffer</span><span class="params">( int32 InitialInstanceCount )</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="FSlateRHIRendererModule"><a href="#FSlateRHIRendererModule" class="headerlink" title="FSlateRHIRendererModule"></a>FSlateRHIRendererModule</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现了Slate RHI Renderer模块</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FSlateRHIRendererModule</span></span></span><br><span class="line"><span class="class">	:</span> <span class="keyword">public</span> ISlateRHIRendererModule</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ISlateRHIRenderer接口</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> TSharedRef&lt;FSlateRenderer&gt; <span class="title">CreateSlateRHIRenderer</span><span class="params">( )</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="built_in">ConditionalCreateResources</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">MakeShareable</span>( <span class="keyword">new</span> <span class="built_in">FSlateRHIRenderer</span>( SlateFontServices.<span class="built_in">ToSharedRef</span>(), ResourceManager.<span class="built_in">ToSharedRef</span>() ) );</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//创建3D渲染器的接口</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> TSharedRef&lt;ISlate3DRenderer, ESPMode::ThreadSafe&gt; <span class="title">CreateSlate3DRenderer</span><span class="params">(<span class="keyword">bool</span> bUseGammaCorrection)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="built_in">ConditionalCreateResources</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FSlate3DRenderer</span>(SlateFontServices.<span class="built_in">ToSharedRef</span>(), ResourceManager.<span class="built_in">ToSharedRef</span>(), bUseGammaCorrection), [=] (FSlate3DRenderer* Renderer) &#123;</span><br><span class="line">			Renderer-&gt;<span class="built_in">Cleanup</span>();</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//创建Slate字体图集工厂</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> TSharedRef&lt;ISlateFontAtlasFactory&gt; <span class="title">CreateSlateFontAtlasFactory</span><span class="params">()</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> FSlateRHIFontAtlasFactory);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//创建实例Buffer</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> TSharedRef&lt;ISlateUpdatableInstanceBuffer&gt; <span class="title">CreateInstanceBuffer</span><span class="params">( int32 InitialInstanceCount )</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">MakeShareable</span>( <span class="keyword">new</span> <span class="built_in">FSlateUpdatableInstanceBuffer</span>(InitialInstanceCount) );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">StartupModule</span><span class="params">( )</span> <span class="keyword">override</span> </span>&#123; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ShutdownModule</span><span class="params">( )</span> <span class="keyword">override</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">/** 创建资源管理器，如果它们不存在的话 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ConditionalCreateResources</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>( !ResourceManager.<span class="built_in">IsValid</span>() )</span><br><span class="line">		&#123;</span><br><span class="line">			ResourceManager = <span class="built_in">MakeShareable</span>( <span class="keyword">new</span> FSlateRHIResourceManager );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>( !SlateFontServices.<span class="built_in">IsValid</span>() )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">const</span> TSharedRef&lt;FSlateFontCache&gt; GameThreadFontCache = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FSlateFontCache</span>(<span class="built_in">MakeShareable</span>(<span class="keyword">new</span> FSlateRHIFontAtlasFactory), ESlateTextureAtlasThreadId::Game));</span><br><span class="line">			<span class="keyword">const</span> TSharedRef&lt;FSlateFontCache&gt; RenderThreadFontCache = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FSlateFontCache</span>(<span class="built_in">MakeShareable</span>(<span class="keyword">new</span> FSlateRHIFontAtlasFactory), ESlateTextureAtlasThreadId::Render));</span><br><span class="line"></span><br><span class="line">			SlateFontServices = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FSlateFontServices</span>(GameThreadFontCache, RenderThreadFontCache));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">/** 给所有渲染器使用的资源管理器 */</span></span><br><span class="line">	TSharedPtr&lt;FSlateRHIResourceManager&gt; ResourceManager;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 给所有渲染器使用的字体服务 */</span></span><br><span class="line">	TSharedPtr&lt;FSlateFontServices&gt; SlateFontServices;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>先看一下FSlateRHIRenderer</p>
<h2 id="FSlateRHIRenderer"><a href="#FSlateRHIRenderer" class="headerlink" title="FSlateRHIRenderer"></a>FSlateRHIRenderer</h2><img src="/2022/04/21/SlateRenderer/SlateRHIRenderer.png" class title="image-20220425110109790">



<p>FSlateRHIRenderer从FSlateRenderer继承。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 一个Slate渲染器的实现 */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FSlateRHIRenderer</span> :</span> <span class="keyword">public</span> FSlateRenderer</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">FSlateRHIRenderer</span>( TSharedRef&lt;FSlateFontServices&gt; InSlateFontServices, TSharedRef&lt;FSlateRHIResourceManager&gt; InResourceManager );</span><br><span class="line">	~<span class="built_in">FSlateRHIRenderer</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * 当渲染一个SWindow的时候，创建一个投影矩阵来使用</span></span><br><span class="line"><span class="comment">	 * @param Width 	The width of the window</span></span><br><span class="line"><span class="comment">	 * @param Height	The height of the window</span></span><br><span class="line"><span class="comment">	 * @return The created projection matrix</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> FMatrix <span class="title">CreateProjectionMatrix</span><span class="params">( uint32 Width, uint32 Height )</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** FSlateRenderer的接口 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Initialize</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Destroy</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FSlateDrawBuffer&amp; <span class="title">GetDrawBuffer</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnWindowDestroyed</span><span class="params">( <span class="keyword">const</span> TSharedRef&lt;SWindow&gt;&amp; InWindow )</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnWindowFinishReshaped</span><span class="params">(<span class="keyword">const</span> TSharedPtr&lt;SWindow&gt;&amp; InWindow)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">RequestResize</span><span class="params">( <span class="keyword">const</span> TSharedPtr&lt;SWindow&gt;&amp; Window, uint32 NewWidth, uint32 NewHeight )</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CreateViewport</span><span class="params">( <span class="keyword">const</span> TSharedRef&lt;SWindow&gt; Window )</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">UpdateFullscreenState</span><span class="params">( <span class="keyword">const</span> TSharedRef&lt;SWindow&gt; Window, uint32 OverrideResX, uint32 OverrideResY )</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetSystemResolution</span><span class="params">(uint32 Width, uint32 Height)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">RestoreSystemResolution</span><span class="params">(<span class="keyword">const</span> TSharedRef&lt;SWindow&gt; InWindow)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DrawWindows</span><span class="params">( FSlateDrawBuffer&amp; InWindowDrawBuffer )</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">FlushCommands</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Sync</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ReleaseDynamicResource</span><span class="params">( <span class="keyword">const</span> FSlateBrush&amp; InBrush )</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">RemoveDynamicBrushResource</span><span class="params">( TSharedPtr&lt;FSlateDynamicImageBrush&gt; BrushToRemove )</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FIntPoint <span class="title">GenerateDynamicImageResource</span><span class="params">(<span class="keyword">const</span> FName InTextureName)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">GenerateDynamicImageResource</span><span class="params">( FName ResourceName, uint32 Width, uint32 Height, <span class="keyword">const</span> TArray&lt; uint8 &gt;&amp; Bytes )</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">GenerateDynamicImageResource</span><span class="params">( FName ResourceName, FSlateTextureDataRef TextureData )</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FSlateResourceHandle <span class="title">GetResourceHandle</span><span class="params">( <span class="keyword">const</span> FSlateBrush&amp; Brush )</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">CanRenderResource</span><span class="params">(UObject&amp; InResourceObject)</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span>* <span class="title">GetViewportResource</span><span class="params">( <span class="keyword">const</span> SWindow&amp; Window )</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetColorVisionDeficiencyType</span><span class="params">(EColorVisionDeficiency Type, int32 Severity, <span class="keyword">bool</span> bCorrectDeficiency, <span class="keyword">bool</span> bShowCorrectionWithDeficiency)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FSlateUpdatableTexture* <span class="title">CreateUpdatableTexture</span><span class="params">(uint32 Width, uint32 Height)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ReleaseUpdatableTexture</span><span class="params">(FSlateUpdatableTexture* Texture)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> ISlateAtlasProvider* <span class="title">GetTextureAtlasProvider</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FCriticalSection* <span class="title">GetResourceCriticalSection</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ReleaseAccessedResources</span><span class="params">(<span class="keyword">bool</span> bImmediatelyFlush)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> int32 <span class="title">RegisterCurrentScene</span><span class="params">(FSceneInterface* Scene)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> int32 <span class="title">GetCurrentSceneIndex</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ClearScenes</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function">EPixelFormat <span class="title">GetSlateRecommendedColorFormat</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DestroyCachedFastPathRenderingData</span><span class="params">(struct FSlateCachedFastPathRenderingData* InRenderingData)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DestroyCachedFastPathElementData</span><span class="params">(FSlateCachedElementData* InCachedElementData)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BeginFrame</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">EndFrame</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AddWidgetRendererUpdate</span><span class="params">(<span class="keyword">const</span> struct FRenderThreadUpdateContext&amp; Context, <span class="keyword">bool</span> bDeferredRenderTargetUpdate)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 在一个渲染线程上绘制窗口，根据一个FSlateDrawBuffer */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">DrawWindow_RenderThread</span><span class="params">(FRHICommandListImmediate&amp; RHICmdList, FViewportInfo&amp; ViewportInfo, FSlateWindowElementList&amp; WindowElementList, <span class="keyword">const</span> struct FSlateDrawWindowCommandParams&amp; DrawParams)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 从磁盘上重新加载纹理资源           </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ReloadTextureResources</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">LoadStyleResources</span><span class="params">( <span class="keyword">const</span> ISlateStyle&amp; Style )</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 判断slate依赖的纹理资源是否已经编译完毕 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">AreShadersInitialized</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	 * 移除到FViewportRHI的引用</span></span><br><span class="line"><span class="comment">	 * This has to be done explicitly instead of using the FRenderResource mechanism because FViewportRHI&#x27;s are managed by the game thread.</span></span><br><span class="line"><span class="comment">	 * This is needed before destroying the RHI device. </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">InvalidateAllViewports</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PrepareToTakeScreenshot</span><span class="params">(<span class="keyword">const</span> FIntRect&amp; Rect, TArray&lt;FColor&gt;* OutColorData, SWindow* ScreenshotWindow)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置window的渲染目标</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetWindowRenderTarget</span><span class="params">(<span class="keyword">const</span> SWindow&amp; Window, class IViewportRenderTargetProvider* Provider)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">/** 从slate styles加载所有已知的纹理 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LoadUsedTextures</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 如果需要的话，重新缩放窗口的大小</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * @param ViewportInfo	The viewport to resize</span></span><br><span class="line"><span class="comment">	 * @param Width			The width that we should size to</span></span><br><span class="line"><span class="comment">	 * @param Height		The height that we shoudl size to</span></span><br><span class="line"><span class="comment">	 * @param bFullscreen	If we should be in fullscreen</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ConditionalResizeViewport</span><span class="params">( FViewportInfo* ViewportInfo, uint32 Width, uint32 Height, <span class="keyword">bool</span> bFullscreen )</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	 * 创建一个需要的资源，去渲染一个窗口，并且发送绘制命令到渲染线程</span></span><br><span class="line"><span class="comment">	 * @param WindowDrawBuffer	The buffer containing elements to draw </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">DrawWindows_Private</span><span class="params">( FSlateDrawBuffer&amp; InWindowDrawBuffer )</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Delete the updateable textures we&#x27;ve marked for delete that have already had their GPU resources released, but may</span></span><br><span class="line"><span class="comment">	 * have already been used on the game thread at the time they were released.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">CleanUpdatableTextures</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">/** 一个SWindow到它们的RHI实现的映射 */</span></span><br><span class="line">	TMap&lt; <span class="keyword">const</span> SWindow*, FViewportInfo*&gt; WindowToViewportInfo;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 被所有窗口使用的观察矩阵 */</span></span><br><span class="line">	FMatrix ViewMatrix;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 保持一个指针，当我们有延迟绘制发生的时候 */</span></span><br><span class="line">	FSlateDrawBuffer* EnqueuedWindowDrawBuffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    双缓冲绘制buffer，那么渲染线程可以渲染窗口，当游戏线程被设置下一帧的时候</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	FSlateDrawBuffer DrawBuffers[NumDrawBuffers];</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 可以被绘制的buffer的数组索引 */</span></span><br><span class="line">	uint8 FreeBufferIndex;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Element batcher which renders draw elements */</span></span><br><span class="line">	TUniquePtr&lt;FSlateElementBatcher&gt; ElementBatcher;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 在游戏线程，可以用来访问纹理资源 */</span></span><br><span class="line">	TSharedPtr&lt;FSlateRHIResourceManager&gt; ResourceManager;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 绘制策略 */</span></span><br><span class="line">	TSharedPtr&lt;FSlateRHIRenderingPolicy&gt; RenderingPolicy;</span><br><span class="line"></span><br><span class="line">	TArray&lt;TSharedPtr&lt;FSlateDynamicImageBrush&gt;&gt; DynamicBrushesToRemove[NumDrawBuffers];</span><br><span class="line"></span><br><span class="line">	FFastPathRenderingDataCleanupList* FastPathRenderingDataCleanupList;</span><br><span class="line"></span><br><span class="line">	FDeferredUpdateContextList DeferredUpdateContexts;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> bIsStandaloneStereoOnlyDevice;</span><br><span class="line">	<span class="keyword">bool</span> bTakingAScreenShot;</span><br><span class="line">	FIntRect ScreenshotRect;</span><br><span class="line">	FViewportInfo* ScreenshotViewportInfo;</span><br><span class="line">	TArray&lt;FColor&gt;* OutScreenshotData;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	这些是场景的状态管理器变量在游戏线程上</span></span><br><span class="line"><span class="comment">	一个相似的拷贝存在于RHI Rendering Policy，用于渲染线程</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="comment">/** These are state management variables for Scenes on the game thread. A similar copy exists on the RHI Rendering Policy for the rendering thread.*/</span></span><br><span class="line">	TArray&lt;FSceneInterface*, TInlineAllocator&lt;<span class="number">4</span>&gt;&gt; ActiveScenes;</span><br><span class="line">	int32 CurrentSceneIndex;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** Version that increments when it is okay to clean up older cached resources */</span></span><br><span class="line">	uint32 ResourceVersion;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>视口有关的信息：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 视口的RHI表示，用来cache宽度和高度，用来检测是否缩放了 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FViewportInfo</span> :</span> <span class="keyword">public</span> FRenderResource</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/** 用于视口的投影矩阵 */</span></span><br><span class="line">	FMatrix ProjectionMatrix;	</span><br><span class="line">	<span class="comment">/** 视口的渲染句柄 */</span></span><br><span class="line">	FViewportRHIRef ViewportRHI;</span><br><span class="line">	<span class="comment">/** 深度buffer纹理 */</span></span><br><span class="line">	FTexture2DRHIRef DepthStencil;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 用于HDR组合的buffer们</span></span><br><span class="line">	<span class="comment">/** sRGB UI渲染目标 */</span></span><br><span class="line">	TRefCountPtr&lt;IPooledRenderTarget&gt; UITargetRT;</span><br><span class="line">	TRefCountPtr&lt;IPooledRenderTarget&gt; UITargetRTMask;</span><br><span class="line">	<span class="comment">/** HDR后台缓冲区的拷贝 */</span></span><br><span class="line">	TRefCountPtr&lt;IPooledRenderTarget&gt; HDRSourceRT;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 颜色空间的HUT，用于HDR */</span></span><br><span class="line">	FTexture3DRHIRef ColorSpaceLUTRT;</span><br><span class="line">	FTexture3DRHIRef ColorSpaceLUTSRV;</span><br><span class="line">	int32 ColorSpaceLUTOutputDevice;</span><br><span class="line">	int32 ColorSpaceLUTOutputGamut;</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//FTexture2DRHIRef RenderTargetTexture;</span></span><br><span class="line">	<span class="comment">/** OS的窗口句柄，用于重新构造viewport */</span></span><br><span class="line">	<span class="keyword">void</span>* OSWindow;</span><br><span class="line">	<span class="comment">/** The actual width of the viewport */</span></span><br><span class="line">	uint32 Width;</span><br><span class="line">	<span class="comment">/** The actual height of the viewport */</span></span><br><span class="line">	uint32 Height;</span><br><span class="line">	<span class="comment">/** The desired width of the viewport */</span></span><br><span class="line">	uint32 DesiredWidth;</span><br><span class="line">	<span class="comment">/** The desired height of the viewport */</span></span><br><span class="line">	uint32 DesiredHeight;</span><br><span class="line">	<span class="comment">/** Whether or not the viewport requires a stencil test */</span></span><br><span class="line">	<span class="keyword">bool</span> bRequiresStencilTest;</span><br><span class="line">	<span class="comment">/** Whether or not the viewport is in fullscreen */</span></span><br><span class="line">	<span class="keyword">bool</span> bFullscreen;</span><br><span class="line">	<span class="comment">/** The desired pixel format for this viewport */</span></span><br><span class="line">	EPixelFormat PixelFormat;</span><br><span class="line">	<span class="comment">/** The desired SDR pixel format for this viewport */</span></span><br><span class="line">	EPixelFormat SDRPixelFormat;</span><br><span class="line">	<span class="comment">/** Color gamut for output to HDR display */</span></span><br><span class="line">	int32 HDRColorGamut;</span><br><span class="line">	<span class="comment">/** Device format for output to HDR display */</span></span><br><span class="line">	int32 HDROutputDevice;</span><br><span class="line"></span><br><span class="line">	IViewportRenderTargetProvider* RTProvider;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** 这是否是HDR的颜色空间 */</span></span><br><span class="line">	<span class="keyword">bool</span> bHDREnabled;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** FRenderResource的接口 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">InitRHI</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ReleaseRHI</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ReleaseResource</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">FViewportInfo</span>()</span><br><span class="line">		:	<span class="built_in">ColorSpaceLUTOutputDevice</span>(<span class="number">0</span>),</span><br><span class="line">			<span class="built_in">ColorSpaceLUTOutputGamut</span>(<span class="number">0</span>),</span><br><span class="line">			<span class="built_in">OSWindow</span>(<span class="literal">NULL</span>), </span><br><span class="line">			<span class="built_in">Width</span>(<span class="number">0</span>),</span><br><span class="line">			<span class="built_in">Height</span>(<span class="number">0</span>),</span><br><span class="line">			<span class="built_in">DesiredWidth</span>(<span class="number">0</span>),</span><br><span class="line">			<span class="built_in">DesiredHeight</span>(<span class="number">0</span>),</span><br><span class="line">			<span class="built_in">bRequiresStencilTest</span>(<span class="literal">false</span>),</span><br><span class="line">			<span class="built_in">bFullscreen</span>(<span class="literal">false</span>),</span><br><span class="line">			<span class="built_in">PixelFormat</span>(EPixelFormat::PF_Unknown),</span><br><span class="line">			<span class="built_in">SDRPixelFormat</span>(EPixelFormat::PF_Unknown),</span><br><span class="line">			<span class="built_in">RTProvider</span>(<span class="literal">nullptr</span>),</span><br><span class="line">			<span class="built_in">bHDREnabled</span>(<span class="literal">false</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">FViewportInfo</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		DepthStencil.<span class="built_in">SafeRelease</span>();</span><br><span class="line">		ColorSpaceLUTRT.<span class="built_in">SafeRelease</span>();</span><br><span class="line">		ColorSpaceLUTSRV.<span class="built_in">SafeRelease</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ConditionallyUpdateDepthBuffer</span><span class="params">(<span class="keyword">bool</span> bInRequiresStencilTest, uint32 Width, uint32 Height)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">RecreateDepthBuffer_RenderThread</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//------获取渲染目标纹理------</span></span><br><span class="line">	<span class="function">FTexture2DRHIRef <span class="title">GetRenderTargetTexture</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (RTProvider)</span><br><span class="line">		&#123;</span><br><span class="line">			FSlateShaderResource* RenderTargetTexture = RTProvider-&gt;<span class="built_in">GetViewportRenderTargetTexture</span>();</span><br><span class="line">			<span class="keyword">if</span>( RenderTargetTexture )</span><br><span class="line">			&#123;</span><br><span class="line">				FSlateRenderTargetRHI* RHITarget = (FSlateRenderTargetRHI*)RenderTargetTexture;</span><br><span class="line">				<span class="keyword">return</span> RHITarget-&gt;<span class="built_in">GetTypedResource</span>();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FSlateBackBuffer</span> :</span> <span class="keyword">public</span> FRenderTarget</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">FSlateBackBuffer</span>(FTexture2DRHIRef InRenderTargetTexture, FIntPoint InSizeXY)</span><br><span class="line">		: <span class="built_in">SizeXY</span>(InSizeXY)</span><br><span class="line">	&#123;</span><br><span class="line">		RenderTargetTextureRHI = InRenderTargetTexture;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FIntPoint <span class="title">GetSizeXY</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> SizeXY; &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	FIntPoint SizeXY;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>FSlateBackBuffer，后台缓冲区，<strong>有个二维的坐标点。</strong></p>
<img src="/2022/04/21/SlateRenderer/SlateRHIRenderer2.png" class title="image-20220425171836904">

<p>在调用完毕FSlateRHIRenderer的构造函数后，会调用它的Initialize函数。</p>
<h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><img src="/2022/04/21/SlateRenderer/SlateRHIRenderer3.png" class title="image-20220425172411369">

<h3 id="Initialize"><a href="#Initialize" class="headerlink" title="Initialize"></a>Initialize</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FSlateRHIRenderer::Initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">LoadUsedTextures</span>();</span><br><span class="line"></span><br><span class="line">	RenderingPolicy = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FSlateRHIRenderingPolicy</span>(SlateFontServices.<span class="built_in">ToSharedRef</span>(), ResourceManager.<span class="built_in">ToSharedRef</span>()));</span><br><span class="line"></span><br><span class="line">	ElementBatcher = MakeUnique&lt;FSlateElementBatcher&gt;(RenderingPolicy.<span class="built_in">ToSharedRef</span>());</span><br><span class="line"></span><br><span class="line">	CurrentSceneIndex = <span class="number">-1</span>;</span><br><span class="line">	ActiveScenes.<span class="built_in">Empty</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Initialize函数，<strong>创建了RenderingPolicy和ElementBatcher。</strong></p>
<p>参考内容：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u013412391/article/details/105279179">https://blog.csdn.net/u013412391/article/details/105279179</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/04/21/SlateRenderer/" data-id="cl28mle6c0000qwszg2mr81a4" data-title="SlateRenderer" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Slate" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/19/Slate/" class="article-date">
  <time class="dt-published" datetime="2022-04-19T04:49:18.170Z" itemprop="datePublished">2022-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/19/Slate/">Slate</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>UMG和Slate的关系，是UMG是对Slate的包装，UWidget持有SWidget的指针，</p>
<p>UWidget加入了UObject的GC系统，<strong>支持反射和蓝图功能。</strong></p>
<p>本身不包含控件逻辑。</p>
<h1 id="FSlateApplication-Create"><a href="#FSlateApplication-Create" class="headerlink" title="FSlateApplication::Create"></a>FSlateApplication::Create</h1><p>Slate在<strong>FEngineLoop::PreInitPreStartupScreen</strong>里面进行初始化的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建这个</span></span><br><span class="line">FSlateApplication::<span class="built_in">Create</span>();</span><br><span class="line"><span class="comment">//在RHI初始化后，给FSlateApplication用</span></span><br><span class="line">FSlateApplication&amp; CurrentSlateApp = FSlateApplication::<span class="built_in">Get</span>();</span><br><span class="line">CurrentSlateApp.<span class="built_in">InitializeRenderer</span>(SlateRendererSharedRef);</span><br></pre></td></tr></table></figure>

<img src="/2022/04/19/Slate/Slate.png" class title="image-20220419125903593">

<p>FSlateApplication::Create是在SlateApplication.cpp里面的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FSlateApplication::Create</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GSlateFastWidgetPath = GIsEditor ? <span class="literal">false</span> : <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//------这里接受了一个TSharedRef&lt;class GenericApplication&gt;对象------</span></span><br><span class="line">	<span class="built_in">Create</span>(<span class="built_in">MakeShareable</span>(FPlatformApplicationMisc::<span class="built_in">CreateApplication</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TSharedRef&lt;FSlateApplication&gt; <span class="title">FSlateApplication::Create</span><span class="params">(<span class="keyword">const</span> TSharedRef&lt;class GenericApplication&gt;&amp; InPlatformApplication)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	EKeys::<span class="built_in">Initialize</span>();</span><br><span class="line"></span><br><span class="line">	FCoreStyle::<span class="built_in">ResetToDefault</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取到平台相关的Application</span></span><br><span class="line">	PlatformApplication = InPlatformApplication;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//然后创建一个FSlateApplication</span></span><br><span class="line">	CurrentApplication = <span class="built_in">MakeShareable</span>( <span class="keyword">new</span> <span class="built_in">FSlateApplication</span>() );</span><br><span class="line">	CurrentBaseApplication = CurrentApplication;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置消息处理</span></span><br><span class="line">	PlatformApplication-&gt;<span class="built_in">SetMessageHandler</span>( CurrentApplication.<span class="built_in">ToSharedRef</span>() );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_ACCESSIBILITY</span></span><br><span class="line">	PlatformApplication-&gt;<span class="built_in">SetAccessibleMessageHandler</span>(CurrentApplication-&gt;<span class="built_in">GetAccessibleMessageHandler</span>());</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// The grid needs to know the size and coordinate system of the desktop.</span></span><br><span class="line">	<span class="comment">// Some monitor setups have a primary monitor on the right and below the</span></span><br><span class="line">	<span class="comment">// left one, so the leftmost upper right monitor can be something like (-1280, -200)Synt</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//获取虚拟桌面的几何</span></span><br><span class="line">		CurrentApplication-&gt;VirtualDesktopRect = []()</span><br><span class="line">		&#123;</span><br><span class="line">			FDisplayMetrics DisplayMetrics;</span><br><span class="line">            <span class="comment">//这里获取了尺寸</span></span><br><span class="line">			FSlateApplicationBase::<span class="built_in">Get</span>().<span class="built_in">GetDisplayMetrics</span>(DisplayMetrics);</span><br><span class="line">			<span class="keyword">const</span> FPlatformRect&amp; VirtualDisplayRect = DisplayMetrics.VirtualDisplayRect;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">FSlateRect</span>(VirtualDisplayRect.Left, VirtualDisplayRect.Top, VirtualDisplayRect.Right, VirtualDisplayRect.Bottom);</span><br><span class="line">		&#125;();</span><br><span class="line">		<span class="comment">//从OS注册更新</span></span><br><span class="line">		<span class="comment">//当平台Application更新尺寸的时候，就调用SlateApplication的OnVirtualDesktopSizeChanged</span></span><br><span class="line">		PlatformApplication-&gt;<span class="built_in">OnDisplayMetricsChanged</span>().<span class="built_in">AddSP</span>(CurrentApplication.<span class="built_in">ToSharedRef</span>(), &amp;FSlateApplication::OnVirtualDesktopSizeChanged);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FAsyncTaskNotificationFactory::<span class="built_in">Get</span>().<span class="built_in">RegisterFactory</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Slate&quot;</span>), []() -&gt; FAsyncTaskNotificationFactory::FImplPointerType &#123; <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">FSlateAsyncTaskNotificationImpl</span>(); &#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> CurrentApplication.<span class="built_in">ToSharedRef</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这个Create里面，主要把平台相关的Application的消息改变、大小改变，<strong>传递给SlateApplication。</strong></p>
<p>FEngineLoop::Tick会调用FSlateApplication的Tick，<strong>Tick调用PumpMessages等函数。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//------消息在这里派发------</span></span><br><span class="line"><span class="comment">//------windows的DispatchMessage就在这里------</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FSlateApplication::PumpMessages</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PlatformApplication-&gt;<span class="built_in">PumpMessages</span>( <span class="built_in">GetDeltaTime</span>() );</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>&#x2F;&#x2F;Pump：输送</p>
<h2 id="FPlatformApplicationMisc-CreateApplication"><a href="#FPlatformApplicationMisc-CreateApplication" class="headerlink" title="FPlatformApplicationMisc::CreateApplication()"></a>FPlatformApplicationMisc::CreateApplication()</h2><img src="/2022/04/19/Slate/ApplicationCore.png" class title="image-20220419130241636">

<p>然后，这个函数又是这个模块下的文件，<strong>平台相关的</strong>。</p>
<p><strong>WindowsApplication.cpp里面有键盘消息处理的模块。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GenericApplication* <span class="title">FWindowsPlatformApplicationMisc::CreateApplication</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//这里加载了一个UE4的ICON</span></span><br><span class="line">	HICON AppIconHandle = <span class="built_in">LoadIcon</span>( hInstance, <span class="built_in">MAKEINTRESOURCE</span>( <span class="built_in">GetAppIcon</span>() ) );</span><br><span class="line">	<span class="keyword">if</span>( AppIconHandle == <span class="literal">NULL</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		AppIconHandle = <span class="built_in">LoadIcon</span>( (HINSTANCE)<span class="literal">NULL</span>, IDI_APPLICATION ); </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//传入一个Windows的程序实例句柄和ICON句柄，然后创建GenericApplication*</span></span><br><span class="line">	<span class="keyword">return</span> FWindowsApplication::<span class="built_in">CreateWindowsApplication</span>( hInstance, AppIconHandle );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FWindowsApplication* <span class="title">FWindowsApplication::CreateWindowsApplication</span><span class="params">( <span class="keyword">const</span> HINSTANCE InstanceHandle, <span class="keyword">const</span> HICON IconHandle )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//创建一个FWindowsApplication，这里是平台相关</span></span><br><span class="line">    <span class="comment">//这里创建窗口的</span></span><br><span class="line">	WindowsApplication = <span class="keyword">new</span> <span class="built_in">FWindowsApplication</span>( InstanceHandle, IconHandle );</span><br><span class="line">	<span class="keyword">return</span> WindowsApplication;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这个FWindowsApplication继承自GenericApplication，<strong>所有平台相关的Application都从这个抽象基类继承。</strong></p>
<h2 id="FSlateApplication-Tick"><a href="#FSlateApplication-Tick" class="headerlink" title="FSlateApplication::Tick"></a>FSlateApplication::Tick</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用这个，进行UI的绘制</span></span><br><span class="line"><span class="built_in">TickAndDrawWidgets</span>(DeltaTime);</span><br></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FSlateApplication::TickAndDrawWidgets</span><span class="params">(<span class="keyword">float</span> DeltaTime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Draw all windows</span></span><br><span class="line">    <span class="built_in">DrawWindows</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FSlateApplication::DrawWindows</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">SCOPED_NAMED_EVENT_TEXT</span>(<span class="string">&quot;Slate::DrawWindows&quot;</span>, FColor::Magenta);</span><br><span class="line">	<span class="built_in">PrivateDrawWindows</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FSlateApplication::PrivateDrawWindows</span><span class="params">( TSharedPtr&lt;SWindow&gt; DrawOnlyThisWindow )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//Prepass the window</span></span><br><span class="line">    <span class="built_in">DrawPrepass</span>(DrawOnlyThisWindow);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//绘制窗口和子窗口</span></span><br><span class="line">    <span class="built_in">DrawWindowAndChildren</span>( ActiveModalWindow.<span class="built_in">ToSharedRef</span>(), DrawWindowArgs );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//调用了Slate渲染器的DrawWindows函数</span></span><br><span class="line">    Renderer-&gt;<span class="built_in">DrawWindows</span>( DrawWindowArgs.OutDrawBuffer );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里用了Slate的渲染器，来绘制UI。</p>
<img src="/2022/04/19/Slate/SlateRenderer.png" class title="image-20220419142254716">

<p>可以是D3D或者OpenGL的<strong>渲染器</strong>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FSlateApplication::DrawWindowAndChildren</span><span class="params">( <span class="keyword">const</span> TSharedRef&lt;SWindow&gt;&amp; WindowToDraw, FDrawWindowArgs&amp; DrawWindowArgs )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//------调用了SWindow的PaintWindow------</span></span><br><span class="line">	WindowToDraw-&gt;<span class="built_in">PaintWindow</span>(</span><br><span class="line">					<span class="built_in">GetCurrentTime</span>(),</span><br><span class="line">					<span class="built_in">GetDeltaTime</span>(),</span><br><span class="line">					WindowElementList,</span><br><span class="line">					<span class="built_in">FWidgetStyle</span>(),</span><br><span class="line">					WindowToDraw-&gt;<span class="built_in">IsEnabled</span>())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//PaintWindow继续调用FSlateInvalidationRoot::PaintInvalidationRoot</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//FSlateInvalidationRoot::PaintInvalidationRoot调用PaintSlowPath</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//PaintSlowPath调用SWidget::Paint</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//调用各种Widget的OnPaint</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//各种FSlateDrawElement的MakeBox</span></span><br></pre></td></tr></table></figure>



<h1 id="FSlateD3DRenderer-DrawWindows"><a href="#FSlateD3DRenderer-DrawWindows" class="headerlink" title="FSlateD3DRenderer::DrawWindows"></a>FSlateD3DRenderer::DrawWindows</h1><p>看一下渲染器做了啥。</p>
<p>StandaloneRenderer里面只有OpenGL和D3D类型的渲染器。</p>
<p>FSlateDrawBuffer里面有一堆之前根据Slate的逻辑生成的<strong>顶点缓冲区之类的东西。</strong></p>
<p>主要在这里生成渲染指令的，<strong>然后提交给渲染线程进行绘制。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FSlateD3DRenderer::DrawWindows</span><span class="params">(FSlateDrawBuffer&amp; InWindowDrawBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>参考资料：<a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/USparkle_UESlate.html">https://blog.uwa4d.com/archives/USparkle_UESlate.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/04/19/Slate/" data-id="cl25s8p6600006gsz1i2yg75h" data-title="Slate" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-UE4引擎启动流程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2022-01-05T10:38:20.410Z" itemprop="datePublished">2022-01-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">UE4引擎启动流程</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="游戏流程总览"><a href="#游戏流程总览" class="headerlink" title="游戏流程总览"></a>游戏流程总览</h1><p>两种主要路径：<strong>编辑器</strong>路径、<strong>standalone</strong>路径。</p>
<p>一般顺序为：初始化引擎、创建并初始化<strong>GameInstance</strong>、加载关卡，最后开始游戏。</p>
<h1 id="Standalone"><a href="#Standalone" class="headerlink" title="Standalone"></a>Standalone</h1><p>Standalone模式(在编辑器外进行的游戏使用该模式)，引擎启动和初始化之后<strong>立即</strong>对进行游戏所需的对象进行创建和初始化。<strong>GameInstace</strong>之类的对象在引擎启用之前被创建和初始化(与创建和初始化引擎不同)。</p>
<p>引擎的<strong>启动函数</strong>被调用后，将立即加载初始地图。</p>
<p>关卡创建适当的<strong>GameMode</strong>和<strong>GameState</strong>，然后创建其他的Actors后，游戏进程便立即开始。</p>
<h1 id="编辑器"><a href="#编辑器" class="headerlink" title="编辑器"></a>编辑器</h1><p>编辑器由<strong>Play In Editor</strong>和<strong>Simulate In Editor</strong>使用，流程完全不同。</p>
<p>引擎立即初始化并启动，因为需要它运行编辑器，但诸如<strong>GameInstance</strong>之类对象的创建和初始化将被延迟，</p>
<p>直到玩家按下启动按钮启动PIE或SIE会话。</p>
<p>此外，<strong>关卡中的Actors将被复制</strong>，每个对象(包括GameInstance)均有每个PIE实例的单独副本。</p>
<p>注意，<strong>会把每个Actors都复制。</strong></p>
<img src="/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/GameFlowChart.png" class>

<p>注意，紫色的小块，(UEngine)Start，在两个不同的分支的调用顺序是不一样的。</p>
<p>编辑器，多了一个(UEditorEngine)Init。</p>
<p>注意，按下按钮后，<strong>会进行拷贝的。</strong></p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p>启动入口在Source&#x2F;Runtime&#x2F;Launch里面。</p>
<h2 id="LaunchWindows-cpp"><a href="#LaunchWindows-cpp" class="headerlink" title="LaunchWindows.cpp"></a>LaunchWindows.cpp</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 WINAPI <span class="title">WinMain</span><span class="params">(_In_ HINSTANCE hInInstance, _In_opt_ HINSTANCE hPrevInstance, _In_ <span class="keyword">char</span>* pCmdLine, _In_ int32 nCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	int32 Result = <span class="built_in">LaunchWindowsStartup</span>(hInInstance, hPrevInstance, pCmdLine, nCmdShow, <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="built_in">LaunchWindowsShutdown</span>();</span><br><span class="line">	<span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Windows的入口，调用两个函数<strong>LaunchWindowsStartup</strong>和<strong>LaunchWindowsShutdown</strong>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LAUNCH_API int32 <span class="title">LaunchWindowsStartup</span><span class="params">( HINSTANCE hInInstance, HINSTANCE hPrevInstance, <span class="keyword">char</span>*, int32 nCmdShow, <span class="keyword">const</span> TCHAR* CmdLine )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">TRACE_BOOKMARK</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;WinMain.Enter&quot;</span>));<span class="comment">//这里产生了一个事件日志</span></span><br><span class="line">	</span><br><span class="line">    <span class="built_in">SetupWindowsEnvironment</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>TRACE_BOOKMARK，会产生一个事件日志，该事件名为WinMain.Enter。</p>
<p><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.26/en-US/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Reference/Trace/">https://docs.unrealengine.com/4.26/en-US/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Reference/Trace/</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置通用的debug设置</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetupWindowsEnvironment</span><span class="params">( <span class="keyword">void</span> )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//所有的ctr验证应当触发回调</span></span><br><span class="line">	_set_invalid_parameter_handler(InvalidParameterHandler);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_BUILD_DEBUG</span></span><br><span class="line">	<span class="comment">//关闭断言的messagebox，将消息写入到调试器的输出窗口</span></span><br><span class="line">	_CrtSetReportMode( _CRT_ASSERT, _CRTDBG_MODE_DEBUG );</span><br><span class="line">	<span class="comment">//用0来填充buffer缓冲区，因为我们假设FNames st只使用整个缓冲区的一小部分</span></span><br><span class="line">	_CrtSetDebugFillThreshold( <span class="number">0</span> );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>CRT，C Time Library，C&#x2F;C++的运行时库，那里是<strong>动态内存分配</strong>的地方，可以使用CRT的一些函数，来检测或者开启一些功能，当发生错误的时候。</p>
<img src="/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/DebugOutput.png" class title="image-20220418184402053">

<p>将断言的消息输出到这个窗口。</p>
<p>UE4实现的回调，当CRT检测到无效的参数的时候，<strong>调用这个回调函数。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">处理CRT的参数验证</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Expression - 失败的CRT检测的表达式</span></span><br><span class="line"><span class="comment">Function - 失败的CRT检测的函数</span></span><br><span class="line"><span class="comment">File - 失败发生的文件地方</span></span><br><span class="line"><span class="comment">Line - 失败发生的行的地方</span></span><br><span class="line"><span class="comment">Reserved - 没用的参数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InvalidParameterHandler</span><span class="params">(<span class="keyword">const</span> TCHAR* Expression,</span></span></span><br><span class="line"><span class="params"><span class="function">							 <span class="keyword">const</span> TCHAR* Function, </span></span></span><br><span class="line"><span class="params"><span class="function">							 <span class="keyword">const</span> TCHAR* File, </span></span></span><br><span class="line"><span class="params"><span class="function">							 uint32 Line, </span></span></span><br><span class="line"><span class="params"><span class="function">							 <span class="keyword">uintptr_t</span> Reserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogLaunchWindows, Fatal,<span class="built_in">TEXT</span>(<span class="string">&quot;SECURE CRT: Invalid parameter detected.\nExpression: %s Function: %s. File: %s Line: %d\n&quot;</span>), </span><br><span class="line">		Expression ? Expression : <span class="built_in">TEXT</span>(<span class="string">&quot;Unknown&quot;</span>), </span><br><span class="line">		Function ? Function : <span class="built_in">TEXT</span>(<span class="string">&quot;Unknown&quot;</span>), </span><br><span class="line">		File ? File : <span class="built_in">TEXT</span>(<span class="string">&quot;Unknown&quot;</span>), </span><br><span class="line">		Line );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>可以看到，当程序发生错误的时候，CRT，会调用UE4的回调函数，<strong>把发生错误的地方写入到日志里面。</strong></p>
<p>&#x2F;&#x2F;verbosity：冗长，赘述</p>
<p>&#x2F;&#x2F;partiy：对等</p>
<p>继续LanuchWindowsStartup函数的调用：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">int32 ErrorLevel = <span class="number">0</span>;</span><br><span class="line">hInstance = hInInstance;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!CmdLine)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//调用WIN32的函数，获取命令行参数</span></span><br><span class="line">	<span class="comment">//GetCommandLineW：Windows的平台函数</span></span><br><span class="line">	CmdLine = ::<span class="built_in">GetCommandLineW</span>();</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">ProcessCommandLine</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		CmdLine = *GSavedCommandLine;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>hInstance定义在Source&#x2F;Runtime&#x2F;Core&#x2F;Public&#x2F;Windows&#x2F;WindowsSystemIncludes.h里面的，</p>
<p>说明在初始化入口的时候，<strong>会初始化Core里面相关平台的一些变量。</strong></p>
<p>GSavedCommandLine是一个<strong>全局静态的FString</strong>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> FString GSavedCommandLine;</span><br></pre></td></tr></table></figure>



<h3 id="ProcessCommandLine"><a href="#ProcessCommandLine" class="headerlink" title="ProcessCommandLine"></a>ProcessCommandLine</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ProcessCommandLine</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> argc = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//获取命令行参数，然后转换成argv数组</span></span><br><span class="line">	LPWSTR* argv = ::<span class="built_in">CommandLineToArgvW</span>(::<span class="built_in">GetCommandLineW</span>(), &amp;argc);</span><br><span class="line">	<span class="keyword">if</span> (argv != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//重新构造我们的命令行字符串，以一定合适的格式，用于FParse类</span></span><br><span class="line">		GSavedCommandLine = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//从第二个开始，因为第一个是程序名</span></span><br><span class="line">		<span class="keyword">for</span> (int32 Option = <span class="number">1</span>; Option &lt; argc; Option++)</span><br><span class="line">		&#123;</span><br><span class="line">			GSavedCommandLine += <span class="built_in">TEXT</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//注入&quot;字符到正确的位置，使得参数保留空白</span></span><br><span class="line">			FString Temp = argv[Option];</span><br><span class="line">			<span class="keyword">if</span> (Temp.<span class="built_in">Contains</span>(<span class="built_in">TEXT</span>(<span class="string">&quot; &quot;</span>)))</span><br><span class="line">			&#123;</span><br><span class="line">				int32 Quote = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">if</span>(Temp.<span class="built_in">StartsWith</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;-&quot;</span>)))</span><br><span class="line">				&#123;</span><br><span class="line">					int32 Separator;</span><br><span class="line">					<span class="keyword">if</span> (Temp.<span class="built_in">FindChar</span>(<span class="string">&#x27;=&#x27;</span>, Separator))</span><br><span class="line">					&#123;</span><br><span class="line">						Quote = Separator + <span class="number">1</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				Temp = Temp.<span class="built_in">Left</span>(Quote) + <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>) + Temp.<span class="built_in">Mid</span>(Quote) + <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			GSavedCommandLine += Temp;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//释放由CommandLineToArgvW分配的内存</span></span><br><span class="line">		::<span class="built_in">LocalFree</span>(argv);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/CommandLine.png" class title="image-20220418192450741">

<p>可以看到第一个是应用名，第二个是我们项目的配置文件名，第三个是一些额外的参数。</p>
<p>这个大概是把诸如-XX&#x3D;AA，如果AA包含空白空格的，<strong>那么就变成”AA”。</strong></p>
<p>处理完毕后，用空格分割的参数，就放置在<strong>GSavedCommandLine</strong>里面了。</p>
<p>这里是大量的命令行参数<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.26/zh-CN/ProductionPipelines/CommandLineArguments/%E3%80%82">https://docs.unrealengine.com/4.26/zh-CN/ProductionPipelines/CommandLineArguments/。</a></p>
<p>继续我们的LaunchWindows.cpp流程：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果我们处于unattended模式，确认我们永远不显示错误会话，如果我们crash的话</span></span><br><span class="line"><span class="keyword">if</span> ( FParse::<span class="built_in">Param</span>( CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;unattended&quot;</span>) ) )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SetErrorMode</span>(SEM_FAILCRITICALERRORS | SEM_NOGPFAULTERRORBOX | SEM_NOOPENFILEERRORBOX);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这里用FParse看一下CmdLine里面有没有unattended，然后<strong>设置错误模式。</strong></p>
<p>这个SetErrorMode也是一个<strong>Windows平台的函数。</strong></p>
<img src="/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/UNATTENDED.png" class title="image-20220418193913619">



<p>接下来继续：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(UE_BUILD_SHIPPING &amp;&amp; WITH_EDITOR)</span></span><br><span class="line">	<span class="comment">//我们使用有名的互斥量，去检测我们是否是第一个运行的游戏实例</span></span><br><span class="line">	<span class="comment">//防止这里有竞争，当我们保存shader cache的时候</span></span><br><span class="line">	GIsFirstInstance = <span class="built_in">MakeNamedMutex</span>( CmdLine );</span><br><span class="line">	<span class="comment">//分析一下命令行里面是否有crashreports，如果有，设置GAlywaysReportCrash</span></span><br><span class="line">	<span class="comment">//这个参数用来报告引擎的崩溃的</span></span><br><span class="line">	<span class="keyword">if</span> ( FParse::<span class="built_in">Param</span>( CmdLine,<span class="built_in">TEXT</span>(<span class="string">&quot;crashreports&quot;</span>) ) )</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//ExceptionHandling.h里面的</span></span><br><span class="line">		GAlwaysReportCrash = <span class="literal">true</span>;</span><br><span class="line">	&#125;	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<p>GAlywasReportCrash定义在Source&#x2F;Runtime&#x2F;Core&#x2F;Public&#x2F;HAL&#x2F;ExceptionHandling.h里面。</p>
<p>GIsFirstInstance定义在Source&#x2F;Runtime&#x2F;Core&#x2F;Public&#x2F;CoreGlobals.h里面。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MakeNamedMutex</span><span class="params">( <span class="keyword">const</span> TCHAR* CmdLine )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> bIsFirstInstance = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	TCHAR MutexName[MAX_SPRINTF] = <span class="built_in">TEXT</span>( <span class="string">&quot;&quot;</span> );</span><br><span class="line">	<span class="comment">//把UnrealEngine4赋值给MutexName</span></span><br><span class="line">	FCString::<span class="built_in">Strcpy</span>( MutexName, MAX_SPRINTF, <span class="built_in">TEXT</span>( <span class="string">&quot;UnrealEngine4&quot;</span> ) );</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//创建这个互斥量</span></span><br><span class="line">	GNamedMutex = <span class="built_in">CreateMutex</span>( <span class="literal">NULL</span>, <span class="literal">true</span>, MutexName );</span><br><span class="line">	<span class="comment">//检查是否是第一个实例</span></span><br><span class="line">	<span class="keyword">if</span>( GNamedMutex	&amp;&amp; <span class="built_in">GetLastError</span>() != ERROR_ALREADY_EXISTS &amp;&amp; !FParse::<span class="built_in">Param</span>( CmdLine, <span class="built_in">TEXT</span>( <span class="string">&quot;NEVERFIRST&quot;</span> ) ) )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//我们是第一个实例</span></span><br><span class="line">		bIsFirstInstance = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//释放这个互斥量</span></span><br><span class="line">		<span class="built_in">ReleaseNamedMutex</span>();</span><br><span class="line">		<span class="comment">//这个置为false，表示已经有一个实例运行了</span></span><br><span class="line">		bIsFirstInstance = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span>( bIsFirstInstance );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>具名互斥量，<strong>可以用来判断多个进程间是否同时有一个互斥量。</strong></p>
<p>GetLastError也是Windows平台的函数。</p>
<p>接下来看看有没有这个，<strong>是否关闭C++原生的异常处理。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> bNoExceptionHandler = FParse::<span class="built_in">Param</span>(CmdLine,<span class="built_in">TEXT</span>(<span class="string">&quot;noexceptionhandler&quot;</span>));</span><br><span class="line"><span class="comment">//使用-noexceptionhandler参数，会关闭原生C++的异常处理，被管理的代码关闭</span></span><br><span class="line"><span class="comment">//默认的情况是有3个包裹的异常处理函数</span></span><br><span class="line"><span class="comment">//Native：WinMain() -&gt; Native：GuardedMainWrapper()</span></span><br><span class="line"><span class="comment">//内部的异常处理被GuardedMainWrapper()捕获，在原生的C++代码中，并且是唯一的方式去获取</span></span><br><span class="line"><span class="comment">//正确的调用栈，当运行64位执行程序的时候</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN64</span></span><br><span class="line">	<span class="keyword">if</span> ( FParse::<span class="built_in">Param</span>(CmdLine,<span class="built_in">TEXT</span>(<span class="string">&quot;noinnerexception&quot;</span>)) || FApp::<span class="built_in">IsBenchmarking</span>() || bNoExceptionHandler)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//内部的异常关闭</span></span><br><span class="line">		GEnableInnerException = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>	</span></span><br></pre></td></tr></table></figure>



<p>接下来是这个：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//当我们运行在嵌入的时候，假设外部的应用程序准备去处理crash报错</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_BUILD_DEBUG</span></span><br><span class="line">	<span class="keyword">if</span> (GUELibraryOverrideSettings.bIsEmbedded || !GAlwaysReportCrash)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">if</span> (GUELibraryOverrideSettings.bIsEmbedded || bNoExceptionHandler || (FPlatformMisc::<span class="built_in">IsDebuggerPresent</span>() &amp;&amp; !GAlwaysReportCrash))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//不处理异常</span></span><br><span class="line">        <span class="comment">//真正的Main函数入口</span></span><br><span class="line">		ErrorLevel = <span class="built_in">GuardedMain</span>( CmdLine );</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 使用结构化异常处理SEH去处理报错，显示一个对话框</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !PLATFORM_SEH_EXCEPTIONS_DISABLED</span></span><br><span class="line">		__try</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> 		&#123;</span><br><span class="line">			GIsGuarded = <span class="number">1</span>;</span><br><span class="line">			<span class="comment">//运行在监视模式下</span></span><br><span class="line">			ErrorLevel = <span class="built_in">GuardedMainWrapper</span>( CmdLine );</span><br><span class="line">			GIsGuarded = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !PLATFORM_SEH_EXCEPTIONS_DISABLED</span></span><br><span class="line">		__except( GEnableInnerException ? EXCEPTION_EXECUTE_HANDLER : <span class="built_in">ReportCrash</span>( <span class="built_in">GetExceptionInformation</span>( ) ) )</span><br><span class="line">		&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(UE_BUILD_SHIPPING &amp;&amp; WITH_EDITOR)</span></span><br><span class="line">			<span class="comment">//释放具名互斥量，就是我们前面那个</span></span><br><span class="line">			<span class="built_in">ReleaseNamedMutex</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			<span class="comment">//Crashed</span></span><br><span class="line">			ErrorLevel = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span>(GError)</span><br><span class="line">			&#123;</span><br><span class="line">                <span class="comment">//处理错误</span></span><br><span class="line">				GError-&gt;<span class="built_in">HandleError</span>();</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">//报错和退出</span></span><br><span class="line">			<span class="built_in">LaunchStaticShutdownAfterError</span>();</span><br><span class="line">			FPlatformMallocCrash::<span class="built_in">Get</span>().<span class="built_in">PrintPoolsUsage</span>();</span><br><span class="line">			FPlatformMisc::<span class="built_in">RequestExit</span>( <span class="literal">true</span> );</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>GIsGuarded定义在Source&#x2F;Runtime&#x2F;Core&#x2F;Public&#x2F;CoreGlobals.h里面。</p>
<p><strong>GError是定义在CoreGlobal.s里面一个FOutputDeviceError的对象。</strong></p>
<p>可以看出，这里有两种入口，一种是不会报错的入口GuardedMain，还有一种就是处于<strong>异常捕获情况</strong>下的入口GuardedMainWrapper。</p>
<p>最后是这个：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">TRACE_BOOKMARK</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;WinMain.Exit&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ErrorLevel;</span><br></pre></td></tr></table></figure>

<p>记录一下退出发生的日志。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//确保发生重大错误的时候，资源被正确的释放</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LaunchStaticsShutdownAfterError</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//确认物理被正确的关闭</span></span><br><span class="line">	<span class="built_in">TermGamePhys</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="GuardedMain和GuardedMainWrapper"><a href="#GuardedMain和GuardedMainWrapper" class="headerlink" title="GuardedMain和GuardedMainWrapper"></a>GuardedMain和GuardedMainWrapper</h2><p>GuardedMainWrapper是GuardedMain的封装。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LAUNCH_API int32 <span class="title">GuardedMainWrapper</span><span class="params">( <span class="keyword">const</span> TCHAR* CmdLine )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	int32 ErrorLevel = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> ( GEnableInnerException )</span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !PLATFORM_SEH_EXCEPTIONS_DISABLED</span></span><br><span class="line">	 	__try</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//运行监视代码</span></span><br><span class="line">			ErrorLevel = <span class="built_in">GuardedMain</span>( CmdLine );</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !PLATFORM_SEH_EXCEPTIONS_DISABLED</span></span><br><span class="line">        <span class="comment">//捕获异常，然后报错</span></span><br><span class="line">		__except( <span class="built_in">ReportCrash</span>( <span class="built_in">GetExceptionInformation</span>() ), EXCEPTION_CONTINUE_SEARCH )</span><br><span class="line">		&#123;</span><br><span class="line">			(<span class="keyword">void</span>)<span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//运行GuardedMain</span></span><br><span class="line">		ErrorLevel = <span class="built_in">GuardedMain</span>( CmdLine );</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ErrorLevel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="GuardedMain"><a href="#GuardedMain" class="headerlink" title="GuardedMain"></a>GuardedMain</h2><p>GuardedMain在Launch.cpp里面定义。</p>
<img src="/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/Launch.png" class title="image-20220418202443313">

<p>LanuchWindows.cpp调用Launch.cpp，说明平台相关的入口都在相应的文件夹里面，</p>
<p><strong>然后再调用平台无关的入口Lanuch.cpp。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">静态的guarded main函数，进入到我们的函数中，那么我们可以有自己的异常处理，</span></span><br><span class="line"><span class="comment">对于debug/release构建，依赖于debugger是否附着</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">int32 <span class="title">GuardedMain</span><span class="params">( <span class="keyword">const</span> TCHAR* CmdLine )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//首先，判断debugger模式是否开启</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(UE_BUILD_SHIPPING)</span></span><br><span class="line">	<span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;waitforattach&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span> (!FPlatformMisc::<span class="built_in">IsDebuggerPresent</span>());</span><br><span class="line">		<span class="built_in">UE_DEBUG_BREAK</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//记录一下日志，DefaultMain</span></span><br><span class="line">	<span class="built_in">BootTimingPoint</span>(<span class="string">&quot;DefaultMain&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//超级早的初始化代码</span></span><br><span class="line">	FCoreDelegates::<span class="built_in">GetPreMainInitDelegate</span>().<span class="built_in">Broadcast</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//确认GEngineLoop::Exit()总是被调用</span></span><br><span class="line">	<span class="comment">//使用C++的RAII来控制</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">EngineLoopCleanupGuard</span> </span></span><br><span class="line"><span class="class">	&#123;</span> </span><br><span class="line">		~<span class="built_in">EngineLoopCleanupGuard</span>()</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// 在嵌入式下，不要关闭引擎，当退出作用域的时候，因为其他的应用会考虑这个</span></span><br><span class="line">			<span class="keyword">if</span> (!GUELibraryOverrideSettings.bIsEmbedded)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">EngineExit</span>();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; CleanupGuard;</span><br><span class="line">	<span class="comment">//设置小型转储文件名。在main函数中，我们不能直接做这个，因为我们使用了一个FString，</span></span><br><span class="line">    <span class="comment">//它请求了析构，并且main使用了SEH，结构化异常。</span></span><br><span class="line">	<span class="comment">//这些名字将会被更新，只要Filemanager被设置，那么我们可以写入到log文件中。</span></span><br><span class="line">    <span class="comment">//这个也会使用用户文件夹，对于安装的build，那么我们不用写入到程序文件。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_WINDOWS</span></span><br><span class="line">    <span class="comment">//unreal-v版本号-时间.dmp</span></span><br><span class="line">    <span class="comment">//这个文件保存了crash时候的一些信息</span></span><br><span class="line">	FCString::<span class="built_in">Strcpy</span>(MiniDumpFilenameW, *FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;unreal-v%i-%s.dmp&quot;</span>), FEngineVersion::<span class="built_in">Current</span>().<span class="built_in">GetChangelist</span>(), *FDateTime::<span class="built_in">Now</span>().<span class="built_in">ToString</span>()));</span><br><span class="line">	<span class="comment">//判断一下，是否是在控制台下运行的</span></span><br><span class="line">	GIsConsoleExecutable = (<span class="built_in">GetFileType</span>(<span class="built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE)) == FILE_TYPE_CHAR);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">//调用EnginePreInit</span></span><br><span class="line">	int32 ErrorLevel = <span class="built_in">EnginePreInit</span>( CmdLine );</span><br><span class="line"></span><br><span class="line">	<span class="comment">//退出，如果EnginePreInit调用失败</span></span><br><span class="line">	<span class="keyword">if</span> ( ErrorLevel != <span class="number">0</span> || <span class="built_in">IsEngineExitRequested</span>() )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> ErrorLevel;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function">FScopedSlowTask <span class="title">SlowTask</span><span class="params">(<span class="number">100</span>, NSLOCTEXT(<span class="string">&quot;EngineInit&quot;</span>, <span class="string">&quot;EngineInit_Loading&quot;</span>, <span class="string">&quot;Loading...&quot;</span>))</span></span>;</span><br><span class="line">        <span class="comment">//EnginePreInit剩余20%未使用的在它的slow task里面</span></span><br><span class="line">        <span class="comment">//这里我们立即地消耗80，那么启动画面的百分比，从一个slow task到另一个的时候，不会改变</span></span><br><span class="line">		<span class="comment">//注意，我们没有包含EngienPreInit在ScopedSlowTak，因为引擎不会完整地在那个点进行初始化</span></span><br><span class="line">		SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">		SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">		<span class="keyword">if</span> (GIsEditor)</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">//编辑器初始化</span></span><br><span class="line">			ErrorLevel = <span class="built_in">EditorInit</span>(GEngineLoop);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">//游戏引擎初始化</span></span><br><span class="line">			ErrorLevel = <span class="built_in">EngineInit</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//记录初始化时间</span></span><br><span class="line">	<span class="keyword">double</span> EngineInitializationTime = FPlatformTime::<span class="built_in">Seconds</span>() - GStartTime;</span><br><span class="line">    <span class="comment">//输出到窗口</span></span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogLoad, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;(Engine Initialization) Total time: %.2f seconds&quot;</span>), EngineInitializationTime);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">    <span class="comment">//蓝图的编译时间</span></span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogLoad, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;(Engine Initialization) Total Blueprint compile time: %.2f seconds&quot;</span>), BlueprintCompileAndLoadTimerData.<span class="built_in">GetTime</span>());</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">//累加加载时间</span></span><br><span class="line">	<span class="built_in">ACCUM_LOADTIME</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;EngineInitialization&quot;</span>), EngineInitializationTime);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//记录循环Tick开始的地方</span></span><br><span class="line">	<span class="built_in">BootTimingPoint</span>(<span class="string">&quot;Tick loop starting&quot;</span>);</span><br><span class="line">    <span class="comment">//输出这个Timing</span></span><br><span class="line">	<span class="built_in">DumpBootTiming</span>();</span><br><span class="line">	<span class="comment">//如果我们运行在嵌入的引擎，不要tick，我们依赖于外部的应用Tick我们</span></span><br><span class="line">	<span class="keyword">if</span> (!GUELibraryOverrideSettings.bIsEmbedded)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span>( !<span class="built_in">IsEngineExitRequested</span>() )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">EngineTick</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//记录下Tick的结束</span></span><br><span class="line">	<span class="built_in">TRACE_BOOKMARK</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Tick loop end&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">	<span class="keyword">if</span>( GIsEditor )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">EditorExit</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> ErrorLevel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>GIsConsoleExecutable是在Launch.cpp下定义的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">		<span class="keyword">if</span> (GIsEditor)</span><br><span class="line">		&#123;</span><br><span class="line">			ErrorLevel = <span class="built_in">EditorInit</span>(GEngineLoop);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		&#123;</span><br><span class="line">			ErrorLevel = <span class="built_in">EngineInit</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>GIsEditor定义在CoreGlobals.h里面，这里是关键，如果是<strong>编辑器状态</strong>下，那么就调用EditorInit，</p>
<p>否则调用EngineInit。</p>
<h2 id="FScopedSlowTask"><a href="#FScopedSlowTask" class="headerlink" title="FScopedSlowTask"></a>FScopedSlowTask</h2><p><a target="_blank" rel="noopener" href="https://isaratech.com/ue4-making-a-progress-bar-in-the-editor/">https://isaratech.com/ue4-making-a-progress-bar-in-the-editor/</a></p>
<p>SlowTask可以用来制作<strong>进度条</strong>，那么用户可以追踪任务的进度。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FScopedSlowTask <span class="title">ExplorePathsTask</span><span class="params">(SelectedPaths.Num(),</span></span></span><br><span class="line"><span class="params"><span class="function">LOCTEXT(<span class="string">&quot;LookingForUnusedAssetsText&quot;</span>, <span class="string">&quot;Looking for assets to remove&quot;</span>))</span></span>;</span><br><span class="line">ExplorePathsTask.<span class="built_in">MakeDialog</span>();</span><br></pre></td></tr></table></figure>

<p>第一个参数表示总共的迭代，第二个参数是用来表示要显示的文本。</p>
<p>第二行显示进度条在编辑器上。</p>
<p>更新进度条，使用<strong>EnterProgressFrame()函数</strong>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExploreFoldersTask.<span class="built_in">EnterProgressFrame</span>();</span><br></pre></td></tr></table></figure>



<p>不需要关闭对话框，如果ExplorePathsTask对象析构了，自然就会关闭对话框。</p>
<p>EnterProgressFrame还能<strong>填入参数</strong>，表示执行到百分之多少。</p>
<h2 id="EnginePreInit"><a href="#EnginePreInit" class="headerlink" title="EnginePreInit"></a>EnginePreInit</h2><p>调用GEngineLoop.PreInit函数。</p>
<h3 id="FEngineLoop-PreInit"><a href="#FEngineLoop-PreInit" class="headerlink" title="FEngineLoop::PreInit"></a>FEngineLoop::PreInit</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">FEngineLoop::PreInit</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> int32 rv1 = <span class="built_in">PreInitPreStartupScreen</span>(CmdLine);</span><br><span class="line">	<span class="keyword">if</span> (rv1 != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		PreInitContext.<span class="built_in">Cleanup</span>();</span><br><span class="line">		<span class="keyword">return</span> rv1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> int32 rv2 = <span class="built_in">PreInitPostStartupScreen</span>(CmdLine);</span><br><span class="line">	<span class="keyword">if</span> (rv2 != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		PreInitContext.<span class="built_in">Cleanup</span>();</span><br><span class="line">		<span class="keyword">return</span> rv2;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="FEngineLoop-PreInitPreStartupScreen"><a href="#FEngineLoop-PreInitPreStartupScreen" class="headerlink" title="FEngineLoop::PreInitPreStartupScreen"></a>FEngineLoop::PreInitPreStartupScreen</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">//设置主线程的局部存储TLS</span></span><br><span class="line">	FMemory::<span class="built_in">SetupTLSCachesOnCurrentThread</span>();</span><br><span class="line">	<span class="comment">//分析一下有没有UTF8Output</span></span><br><span class="line">	<span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(CmdLine, <span class="built_in">TEXT</span>(<span class="string">&quot;UTF8Output&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		FPlatformMisc::<span class="built_in">SetUTF8Output</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置工作目录为可执行文件目录</span></span><br><span class="line">	FPlatformProcess::<span class="built_in">SetCurrentWorkingDirectoryToBaseDir</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化trace</span></span><br><span class="line">	FTraceAuxiliary::<span class="built_in">Initialize</span>(CmdLine);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//关闭/开启 LLM基于命令行</span></span><br><span class="line">		&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;LLM Init&quot;</span>);</span><br><span class="line">		<span class="built_in">LLM</span>(FLowLevelMemTracker::<span class="built_in">Get</span>().<span class="built_in">ProcessCommandLine</span>(CmdLine));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> MEMPRO_ENABLED</span></span><br><span class="line">		FMemProProfiler::<span class="built_in">Init</span>(CmdLine);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		&#125;</span><br><span class="line">	<span class="built_in">LLM_SCOPE</span>(ELLMTag::EnginePreInitMemory);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------不知道干吗的委托------</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_ENGINE</span></span><br><span class="line">	FCoreUObjectDelegates::PostGarbageCollectConditionalBeginDestroy.<span class="built_in">AddStatic</span>(DeferredPhysResourceCleanup);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	FCoreDelegates::OnSamplingInput.<span class="built_in">AddStatic</span>(UpdateGInputTime);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span>	STATS</span></span><br><span class="line">	<span class="comment">// 创建stat内存分析代理</span></span><br><span class="line">	<span class="keyword">if</span> (FStatsMallocProfilerProxy::<span class="built_in">HasMemoryProfilerToken</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (PLATFORM_USES_FIXED_GMalloc_CLASS)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogMemory, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Cannot do malloc profiling with PLATFORM_USES_FIXED_GMalloc_CLASS.&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 创建一个全局内存分配器</span></span><br><span class="line">		GMalloc = FStatsMallocProfilerProxy::<span class="built_in">Get</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// STATS</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_APPLICATION_CORE</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;CreateConsoleOutputDevice&quot;</span>);</span><br><span class="line">		<span class="comment">// 初始化日志控制台，去避免静态的初始化问题，当从命令行进入的时候</span></span><br><span class="line">		GScopedLogConsole = TUniquePtr&lt;FOutputDeviceConsole&gt;(FPlatformApplicationMisc::<span class="built_in">CreateConsoleOutputDevice</span>());</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_DESKTOP</span></span><br><span class="line">	<span class="comment">//初始化stdout，FOutputDeviceDebug负责输出log</span></span><br><span class="line">	<span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;stdout&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">InitializeStdOutDevice</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化输出设备</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;Init Output Devices&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_APPLICATION_CORE</span></span><br><span class="line">		GError = FPlatformApplicationMisc::<span class="built_in">GetErrorOutputDevice</span>();</span><br><span class="line">		GWarn = FPlatformApplicationMisc::<span class="built_in">GetFeedbackContext</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		GError = FPlatformOutputDevices::<span class="built_in">GetError</span>();</span><br><span class="line">		GWarn = FPlatformOutputDevices::<span class="built_in">GetFeedbackContext</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;	</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//开始文本本地化的PreInit</span></span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;BeginPreInitTextLocalization&quot;</span>);</span><br><span class="line">		<span class="built_in">BeginPreInitTextLocalization</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_ENGINE</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;PreInitShaderLibrary&quot;</span>);</span><br><span class="line">        <span class="comment">//ShaderCodeLibrary的PreInit</span></span><br><span class="line">		FShaderCodeLibrary::<span class="built_in">PreInit</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// WITH_ENGINE</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化文件管理器</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;IFileManager::Get().ProcessCommandLineOptions&quot;</span>);</span><br><span class="line">		IFileManager::<span class="built_in">Get</span>().<span class="built_in">ProcessCommandLineOptions</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化异步IO</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_COREUOBJECT</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;InitializeNewAsyncIO&quot;</span>);</span><br><span class="line">		FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">InitializeNewAsyncIO</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//记住主线程的线程ID</span></span><br><span class="line">	GGameThreadId = FPlatformTLS::<span class="built_in">GetCurrentThreadId</span>();</span><br><span class="line">	GIsGameThreadIdInitialized = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------不知道干吗用的------</span></span><br><span class="line">	FPlatformProcess::<span class="built_in">SetThreadAffinityMask</span>(FPlatformAffinity::<span class="built_in">GetMainGameMask</span>());</span><br><span class="line">	<span class="comment">//------初始化游戏线程------</span></span><br><span class="line">	FPlatformProcess::<span class="built_in">SetupGameThread</span>();</span><br><span class="line">	<span class="comment">//将磁盘上的着色器文件夹目录映射成虚拟目录</span></span><br><span class="line">	<span class="built_in">AddShaderSourceDirectoryMapping</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Engine&quot;</span>), FGenericPlatformProcess::<span class="built_in">ShaderDir</span>());</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------设置项目目录------</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//检查每个token，对于&#x27;-game&#x27;，&#x27;-server&#x27;，或者&#x27;-run=&#x27;</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化随机数生成器</span></span><br><span class="line">	&#123;</span><br><span class="line">		uint32 Seed1 = <span class="number">0</span>;</span><br><span class="line">		uint32 Seed2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!FApp::bUseFixedSeed)</span><br><span class="line">		&#123;</span><br><span class="line">			Seed1 = FPlatformTime::<span class="built_in">Cycles</span>();</span><br><span class="line">			Seed2 = FPlatformTime::<span class="built_in">Cycles</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		FMath::<span class="built_in">RandInit</span>(Seed1);</span><br><span class="line">		FMath::<span class="built_in">SRandInit</span>(Seed2);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogInit, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;RandInit(%d) SRandInit(%d).&quot;</span>), Seed1, Seed2);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置游戏项目的二进制目录</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建TaskGraph和线程池</span></span><br><span class="line">	<span class="keyword">if</span> (bCreateTaskGraphAndThreadPools)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//初始化task graph子系统，在潜在的多线程下</span></span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FTaskGraphInterface::Startup&quot;</span>);</span><br><span class="line">		FTaskGraphInterface::<span class="built_in">Startup</span>(FPlatformMisc::<span class="built_in">NumberOfCores</span>());</span><br><span class="line">		FTaskGraphInterface::<span class="built_in">Get</span>().<span class="built_in">AttachToThread</span>(ENamedThreads::GameThread);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//加载核心模块UObject</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;LoadCoreModules&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">LoadCoreModules</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogInit, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to load Core modules.&quot;</span>));</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//---读取和创建一堆配置文件---</span></span><br><span class="line">	<span class="comment">//---还有Pak---</span></span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//使用初始化渲染所需的cache变量</span></span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//------创建线程池------</span></span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> WITH_APPLICATION_CORE</span></span><br><span class="line">	<span class="comment">//得到一个指向log output设备的指针</span></span><br><span class="line">	GLogConsole = GScopedLogConsole.<span class="built_in">Get</span>();</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;LoadPreInitModules&quot;</span>);</span><br><span class="line">		<span class="built_in">LoadPreInitModules</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------绑定一些委托-------</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_ENGINE &amp;&amp; CSV_PROFILER</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsRunningDedicatedServer</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		FCoreDelegates::OnBeginFrame.<span class="built_in">AddStatic</span>(UpdateCoreCsvStats_BeginFrame);</span><br><span class="line">		FCoreDelegates::OnEndFrame.<span class="built_in">AddStatic</span>(UpdateCoreCsvStats_EndFrame);</span><br><span class="line">	&#125;</span><br><span class="line">	FCsvProfiler::<span class="built_in">Get</span>()-&gt;<span class="built_in">Init</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">//------绑定一些委托-------</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//开始Application的初始化</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;AppInit&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">AppInit</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------创建IO线程------</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//从配置文件读取引擎的变量</span></span><br><span class="line">	<span class="built_in">ApplyCVarSettingsFromIni</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Script/Engine.RendererSettings&quot;</span>), *GEngineIni, ECVF_SetByProjectSetting);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//------使用渲染线程------</span></span><br><span class="line">		<span class="keyword">if</span> (FPlatformMisc::<span class="built_in">UseRenderThread</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			GUseThreadedRendering = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//------内存的初始化------</span></span><br><span class="line">		FPlatformMisc::<span class="built_in">PlatformInit</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_APPLICATION_CORE</span></span><br><span class="line">		FPlatformApplicationMisc::<span class="built_in">Init</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		FPlatformMemory::<span class="built_in">Init</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">//------初始化物理引擎------</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;InitGamePhys&quot;</span>);</span><br><span class="line">		<span class="comment">//初始化物理引擎</span></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">InitGamePhys</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// If we failed to initialize physics we cannot continue.</span></span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------初始化引擎文本本地化------</span></span><br><span class="line">	<span class="built_in">InitEngineTextLocalization</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Slate应用是否初始化高DPI</span></span><br><span class="line">	FSlateApplication::<span class="built_in">InitHighDPI</span>(bForceEnableHighDPI);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化引擎Bridge</span></span><br><span class="line">	UStringTable::<span class="built_in">InitializeEngineBridge</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------不是跑在DS下的------</span></span><br><span class="line">	<span class="comment">//展示初始化界面</span></span><br><span class="line">	<span class="comment">//FSlateApplication::Create()</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//------初始化所有的UniformBuffer结构体------</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FUniformBufferStruct::InitializeStructs()&quot;</span>);</span><br><span class="line">		FShaderParametersMetadata::<span class="built_in">InitializeAllUniformBufferStructs</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------初始化RHI-----</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;RHIInit&quot;</span>);</span><br><span class="line">		<span class="comment">// Initialize the RHI.</span></span><br><span class="line">		<span class="built_in">RHIInit</span>(bHasEditorToken);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;RenderUtilsInit&quot;</span>);</span><br><span class="line">		<span class="comment">//基于引擎的配置一次性初始化全局变量</span></span><br><span class="line">		<span class="built_in">RenderUtilsInit</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------初始化ShaderCodeLibrary------</span></span><br><span class="line">	<span class="comment">//------会打开材质着色器代码------</span></span><br><span class="line">	FShaderCodeLibrary::<span class="built_in">InitForRuntime</span>(GMaxRHIShaderPlatform);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------判断是否要编译着色器------</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//cache渲染模块在主线程，我们可以安全地获取它在之后的渲染线程</span></span><br><span class="line">	<span class="built_in">GetRendererModule</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (bEnableShaderCompile)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;InitializeShaderTypes&quot;</span>);</span><br><span class="line">			<span class="comment">//初始化着色器类型，在加载任何着色器之前</span></span><br><span class="line">			<span class="built_in">InitializeShaderTypes</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------这里要注意，开始编译全局ShaderMap------</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//------创建SlateRenderer------</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="comment">//------创建FSlateApplication------</span></span><br><span class="line">	FSlateApplication&amp; CurrentSlateApp = FSlateApplication::<span class="built_in">Get</span>();</span><br><span class="line">	CurrentSlateApp.<span class="built_in">InitializeRenderer</span>(SlateRendererSharedRef);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//------创建引擎字体服务------</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//FPreLoadScreenManager的一些初始化</span></span><br></pre></td></tr></table></figure>



<p>GMalloc，类型为FMalloc，一个全局内存分配器。</p>
<h4 id="FEngineLoop-PreInitPostStartupScreen"><a href="#FEngineLoop-PreInitPostStartupScreen" class="headerlink" title="FEngineLoop::PreInitPostStartupScreen"></a>FEngineLoop::PreInitPostStartupScreen</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//恢复之前PreInitPostStartupScreen设置的一些bool变量</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//暂时不知道啥作用的IInstallBundleManager</span></span><br><span class="line">		TSharedPtr&lt;IInstallBundleManager&gt; BundleManager = IInstallBundleManager::<span class="built_in">GetPlatformInstallBundleManager</span>();	</span><br><span class="line"></span><br><span class="line">	<span class="comment">//-----Slate------</span></span><br><span class="line">	<span class="comment">//获取一些PreInit初始化的SlateRenderer</span></span><br><span class="line">	<span class="comment">//从Init文件设置加载过场动画</span></span><br><span class="line">	<span class="built_in">GetMoviePalyer</span>()-&gt;<span class="built_in">SetupLoadingScreenFromIni</span>();</span><br><span class="line"></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;LoadModulesForProject(ELoadingPhase::PreEarlyLoadingScreen)&quot;</span>);</span><br><span class="line">				<span class="comment">//加载所有有关的模块，在加载阶段的时候</span></span><br><span class="line">				<span class="keyword">if</span> (!IProjectManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForProject</span>(ELoadingPhase::PreEarlyLoadingScreen) || !IPluginManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForEnabledPlugins</span>(ELoadingPhase::PreEarlyLoadingScreen))</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;	</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//------绑定一个委托------</span></span><br><span class="line">			<span class="keyword">if</span> (BundleManager != <span class="literal">nullptr</span> &amp;&amp; !BundleManager-&gt;<span class="built_in">IsNullInterface</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				IInstallBundleManager::InstallBundleCompleteDelegate.<span class="built_in">AddStatic</span>(</span><br><span class="line">					&amp;OnStartupContentMounted, bDumpEarlyConfigReads, bDumpEarlyPakFileReads, bWithConfigPatching, bForceQuitAfterEarlyReads);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//------用SlateRenderer来初始化过场动画------</span></span><br><span class="line">			<span class="built_in">GetMoviePlayer</span>()-&gt;<span class="built_in">Initialize</span>(SlateRendererSharedRef.<span class="built_in">Get</span>(), FPreLoadScreenManager::<span class="built_in">Get</span>() ? FPreLoadScreenManager::<span class="built_in">Get</span>()-&gt;<span class="built_in">GetRenderWindow</span>() : <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//------EarylyStatupScreen已经完成，一些必要的步骤去安排paks，应用.ini cvars</span></span><br><span class="line">		<span class="comment">//打开shader libraries</span></span><br><span class="line">		<span class="comment">//查找插件</span></span><br><span class="line">	</span><br><span class="line">		<span class="comment">//重新应用CVars</span></span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//处理打开的shader library，在EarlyLoadScreen之后</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">LLM_SCOPE</span>(ELLMTag::Shaders);</span><br><span class="line">				<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FShaderCodeLibrary::OpenLibrary&quot;</span>);</span><br><span class="line"></span><br><span class="line">				<span class="comment">//打开游戏仓库，里面包含了材质shader</span></span><br><span class="line">				FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(FApp::<span class="built_in">GetProjectName</span>(), FPaths::<span class="built_in">ProjectContentDir</span>());</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">const</span> FString&amp; RootDir : FPlatformMisc::<span class="built_in">GetAdditionalRootDirectories</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(FApp::<span class="built_in">GetProjectName</span>(), FPaths::<span class="built_in">Combine</span>(RootDir, FApp::<span class="built_in">GetProjectName</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Content&quot;</span>)));</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">//看一下是否需要预编译</span></span><br><span class="line">				FShaderPipelineCache::<span class="built_in">OpenPipelineFileCache</span>(GMaxRHIShaderPlatform);</span><br><span class="line">			&#125;		</span><br><span class="line"></span><br><span class="line">			<span class="comment">//初始化游戏文本本地化</span></span><br><span class="line">			<span class="built_in">BeginInitGameTextLocalization</span>();</span><br><span class="line"></span><br><span class="line">			<span class="comment">//加载资产管理模块</span></span><br><span class="line">			<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;LoadAssetRegistryModule&quot;</span>);</span><br><span class="line">		    FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="string">&quot;AssetRegistry&quot;</span>);</span><br><span class="line">			<span class="comment">//确认所有的UObject类已经被注册，并且默认属性已经初始化</span></span><br><span class="line">			<span class="built_in">ProcessNewlyLoadedUObjects</span>();</span><br><span class="line"></span><br><span class="line">			<span class="built_in">EndInitGameTextLocalization</span>();</span><br><span class="line">			<span class="comment">//初始化默认材质</span></span><br><span class="line">			UMaterialInterface::<span class="built_in">InitDefaultMaterials</span>();</span><br><span class="line">			UMaterialInterface::<span class="built_in">AssertDefaultMaterialsExist</span>();</span><br><span class="line">			UMaterialInterface::<span class="built_in">AssertDefaultMaterialsPostLoaded</span>();</span><br><span class="line">			<span class="comment">//纹理流送管理器初始化</span></span><br><span class="line">			IStreamingManager::<span class="built_in">Get</span>();</span><br><span class="line">			<span class="comment">//告诉模块管理器，处理新加载的UObjects，当C++模块已经被加载了后</span></span><br><span class="line">			FModuleManager::<span class="built_in">Get</span>().<span class="built_in">StartProcessingNewlyLoadedObjects</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------初始化RHI------</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;PostInitRHI etc&quot;</span>);</span><br><span class="line">		<span class="built_in">PostInitRHI</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GUseThreadedRendering)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (GRHISupportsRHIThread)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">const</span> <span class="keyword">bool</span> DefaultUseRHIThread = <span class="literal">true</span>;</span><br><span class="line">				GUseRHIThread_InternalUseOnly = DefaultUseRHIThread;</span><br><span class="line">				<span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;rhithread&quot;</span>)))</span><br><span class="line">				&#123;</span><br><span class="line">					GUseRHIThread_InternalUseOnly = <span class="literal">true</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (FParse::<span class="built_in">Param</span>(FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;norhithread&quot;</span>)))</span><br><span class="line">				&#123;</span><br><span class="line">					GUseRHIThread_InternalUseOnly = <span class="literal">false</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">//---开始游戏线程---</span></span><br><span class="line">			<span class="built_in">StartRenderingThread</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//播放加载动画</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化profile可视化器</span></span><br><span class="line">	FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;TaskGraph&quot;</span>));</span><br><span class="line">	<span class="keyword">if</span> (FPlatformProcess::<span class="built_in">SupportsMultithreading</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ProfilerService&quot;</span>));</span><br><span class="line">		FModuleManager::<span class="built_in">Get</span>().GetModuleChecked&lt;IProfilerServiceModule&gt;(<span class="string">&quot;ProfilerService&quot;</span>).<span class="built_in">CreateProfilerServiceManager</span>();</span><br><span class="line">	&#125;	</span><br></pre></td></tr></table></figure>



<img src="/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/FEngineLoop.png" class title="image-20220418225323310">

<h2 id="EditorInit和EngineInit"><a href="#EditorInit和EngineInit" class="headerlink" title="EditorInit和EngineInit"></a>EditorInit和EngineInit</h2><p>EditorInit在Source\Editor\UnrealEd\Private\UnrealEdGlobals.cpp里面定义。</p>
<p>而EngineInit在Launch.cpp里面。</p>
<p><strong>FEngineLoop GEngineLoop</strong>也定义在Launch.cpp里面。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	Inits the engine loop </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//EngineInit比较简单，只是简单地调用GEngineLoop的初始化。</span></span><br><span class="line"><span class="function">int32 <span class="title">EngineInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	int32 ErrorLevel = GEngineLoop.<span class="built_in">Init</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span>( ErrorLevel );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">EditorInit</span><span class="params">(IEngineLoop&amp; EngineLoop)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//创建debug工具进程</span></span><br><span class="line">	GDebugToolExec = <span class="keyword">new</span> FDebugToolExec;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//定义一个stat对象，用来计时，暂时以后研究，RAII记录两次时间</span></span><br><span class="line">	<span class="built_in">DECLARE_SCOPE_CYCLE_COUNTER</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Editor Initialized&quot;</span>), STAT_EditorStartup, STATGROUP_LoadTime);</span><br><span class="line">    </span><br><span class="line">    <span class="function">FScopedSlowTask <span class="title">SlowTask</span><span class="params">(<span class="number">100</span>, NSLOCTEXT(<span class="string">&quot;EngineLoop&quot;</span>, <span class="string">&quot;EngineLoop_Loading&quot;</span>, <span class="string">&quot;Loading...&quot;</span>))</span></span>;</span><br><span class="line">    </span><br><span class="line">    SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">50</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//调用GEngineLoop.Init函数</span></span><br><span class="line">    int32 ErrorLevel = EngineLoop.<span class="built_in">Init</span>();</span><br><span class="line">    <span class="comment">//如果报错，启动画面就隐藏</span></span><br><span class="line">	<span class="keyword">if</span>( ErrorLevel != <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		FPlatformSplash::<span class="built_in">Hide</span>();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>FExec* GDebugToolExec定义在CoreGlobals.cpp里面。</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/438784425">https://zhuanlan.zhihu.com/p/438784425</a> UE4的Stat性能分析工具。</p>
<p><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.26/en-US/TestingAndOptimization/PerformanceAndProfiling/StatCommands/StatsSystemOverview/%E5%AE%98%E7%BD%91%E7%9A%84%E6%96%87%E6%A1%A3%E3%80%82">https://docs.unrealengine.com/4.26/en-US/TestingAndOptimization/PerformanceAndProfiling/StatCommands/StatsSystemOverview/官网的文档。</a></p>
<p>继续EditorInit：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//让分析器知道编辑器已经开始了</span></span><br><span class="line"><span class="comment">//暂时不知道FEngineAnalytics干吗用的</span></span><br><span class="line"><span class="keyword">if</span> ( FEngineAnalytics::<span class="built_in">IsAvailable</span>() )</span><br><span class="line">&#123;</span><br><span class="line">	TArray&lt;FAnalyticsEventAttribute&gt; EventAttributes;</span><br><span class="line">	EventAttributes.<span class="built_in">Add</span>(<span class="built_in">FAnalyticsEventAttribute</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GameName&quot;</span>), FApp::<span class="built_in">GetProjectName</span>()));</span><br><span class="line">	EventAttributes.<span class="built_in">Add</span>(<span class="built_in">FAnalyticsEventAttribute</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;CommandLine&quot;</span>), FCommandLine::<span class="built_in">Get</span>()));</span><br><span class="line"></span><br><span class="line">	FEngineAnalytics::<span class="built_in">GetProvider</span>().<span class="built_in">RecordEvent</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Editor.ProgramStarted&quot;</span>), EventAttributes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">40</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化Misc编辑器</span></span><br><span class="line">FUnrealEdMisc::<span class="built_in">Get</span>().<span class="built_in">OnInit</span>();</span><br><span class="line"></span><br><span class="line">SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//为加载和保存内容文件的默认目录数组设置主目录</span></span><br><span class="line">FEditorDirectories::<span class="built_in">Get</span>().<span class="built_in">LoadLastDirectories</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化actor文件夹单例，管理Actor的</span></span><br><span class="line">FActorFolders::<span class="built_in">Init</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//cache可用的目标对于现在的项目，那么我们可以展示正确的选项在包项目菜单</span></span><br><span class="line">FDesktopPlatformModule::<span class="built_in">Get</span>()-&gt;<span class="built_in">GetTargetsForCurrentProject</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// =================== 核心的Editor初始化已经完毕 ===================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//因此初始化界面，那么所有的事情都可以准备开始了</span></span><br><span class="line">FPlatformSplash::<span class="built_in">Hide</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断我们是否在交互式的模式？</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">bool</span> bIsImmersive = FPaths::<span class="built_in">IsProjectFilePathSet</span>() &amp;&amp; FParse::<span class="built_in">Param</span>( FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>( <span class="string">&quot;immersive&quot;</span> ) );</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行最终的设置步骤在编辑器那帧上，并且展示它</span></span><br><span class="line">&#123;</span><br><span class="line">   	<span class="built_in">TRACE_CPUPROFILER_EVENT_SCOPE</span>(EditorInit::MainFrame);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//拆除渲染线程一次，而不是每次调整窗口大小时都这样做？？</span></span><br><span class="line">       <span class="built_in">SCOPED_SUSPEND_RENDERING_THREAD</span>(<span class="literal">true</span>);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//开始Slate的主frame，还有其它的editor窗口</span></span><br><span class="line">       &#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> bStartImmersive = bIsImmersive;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> bStartPIE = bIsImmersive;</span><br><span class="line">		<span class="comment">//加载模块</span></span><br><span class="line">		IMainFrameModule&amp; MainFrameModule = FModuleManager::LoadModuleChecked&lt;IMainFrameModule&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;MainFrame&quot;</span>));</span><br><span class="line">		MainFrameModule.<span class="built_in">CreateDefaultMainFrame</span>( bStartImmersive, bStartPIE );</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//直接去VR模式，如果我们要求这样的话</span></span><br><span class="line"><span class="built_in">CheckAndMaybeGoToVRModeInternal</span>(bIsImmersive);</span><br><span class="line"></span><br><span class="line"><span class="comment">//检测自动的构建/提交选项</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">bool</span> bDoAutomatedMapBuild = FParse::<span class="built_in">Param</span>( FCommandLine::<span class="built_in">Get</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;AutomatedMapBuild&quot;</span>) );</span><br><span class="line"></span><br><span class="line"><span class="comment">//促使更新游戏项目文件对于现在的版本，如果可以的话</span></span><br><span class="line"><span class="keyword">if</span> ( FPaths::<span class="built_in">IsProjectFilePathSet</span>() )</span><br><span class="line">&#123;</span><br><span class="line">	FGameProjectGenerationModule::<span class="built_in">Get</span>().<span class="built_in">CheckForOutOfDateGameProjectFile</span>();</span><br><span class="line">	FGameProjectGenerationModule::<span class="built_in">Get</span>().<span class="built_in">CheckAndWarnProjectFilenameValid</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =================== 编辑器初始化完成 ===================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//开始追踪</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> StartupTime = (<span class="keyword">float</span>)( FPlatformTime::<span class="built_in">Seconds</span>() - GStartTime );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( FEngineAnalytics::<span class="built_in">IsAvailable</span>() )</span><br><span class="line">	&#123;</span><br><span class="line">		FEngineAnalytics::<span class="built_in">GetProvider</span>().<span class="built_in">RecordEvent</span>(</span><br><span class="line">			<span class="built_in">TEXT</span>( <span class="string">&quot;Editor.Performance.Startup&quot;</span> ),</span><br><span class="line">			<span class="built_in">TEXT</span>( <span class="string">&quot;Duration&quot;</span> ), FString::<span class="built_in">Printf</span>( <span class="built_in">TEXT</span>( <span class="string">&quot;%.3f&quot;</span> ), StartupTime ) );</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FModuleManager::LoadModuleChecked&lt;IModuleInterface&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;HierarchicalLODOutliner&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//移除所有无效的key，在所有的插件和模块已经被加载的时候</span></span><br><span class="line"><span class="keyword">if</span> (UInputSettings* InputSettings = UInputSettings::<span class="built_in">GetInputSettings</span>())</span><br><span class="line">&#123;</span><br><span class="line">	InputSettings-&gt;<span class="built_in">RemoveInvalidKeys</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>



<p>可以看到EditorInit初始化了一大堆和编辑器有关的东西。</p>
<p><strong>比如Slate的加载。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这里是关键，是界面的初始化</span></span><br><span class="line">IMainFrameModule&amp; MainFrameModule = FModuleManager::LoadModuleChecked&lt;IMainFrameModule&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;MainFrame&quot;</span>));</span><br><span class="line">MainFrameModule.<span class="built_in">CreateDefaultMainFrame</span>( bStartImmersive, bStartPIE );</span><br></pre></td></tr></table></figure>



<h3 id="FEngineLoop-Init"><a href="#FEngineLoop-Init" class="headerlink" title="FEngineLoop::Init()"></a>FEngineLoop::Init()</h3><p>看一下这个FEngineLoop的初始化函数。</p>
<p><strong>定义在LanuchEngineLoop.cpp下面。</strong></p>
<p>Low-Level Memory Tracker</p>
<p><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.27/en-US/ProductionPipelines/DevelopmentSetup/Tools/LowLevelMemoryTracker/">https://docs.unrealengine.com/4.27/en-US/ProductionPipelines/DevelopmentSetup/Tools/LowLevelMemoryTracker/</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">//事件，以及记录初始化开始的地方</span></span><br><span class="line">	<span class="built_in">LLM_SCOPE</span>(ELLMTag::EngineInitMemory);</span><br><span class="line">	<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FEngineLoop::Init&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">DECLARE_SCOPE_CYCLE_COUNTER</span>( <span class="built_in">TEXT</span>( <span class="string">&quot;FEngineLoop::Init&quot;</span> ), STAT_FEngineLoop_Init, STATGROUP_LoadTime );</span><br><span class="line">	<span class="function">FScopedSlowTask <span class="title">SlowTask</span><span class="params">(<span class="number">100</span>)</span></span>;</span><br><span class="line">	SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">10</span>);</span><br><span class="line">	<span class="comment">//暂时不知道干吗用的东东</span></span><br><span class="line">	FEmbeddedCommunication::<span class="built_in">ForceTick</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">	UClass* EngineClass = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">if</span>( !GIsEditor )</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//不是编辑器的分支</span></span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;Create GEngine&quot;</span>);</span><br><span class="line">		<span class="comment">//我们在游戏中</span></span><br><span class="line">		FString GameEngineClassName;</span><br><span class="line">		GConfig-&gt;<span class="built_in">GetString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Script/Engine.Engine&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;GameEngine&quot;</span>), GameEngineClassName, GEngineIni);</span><br><span class="line">        <span class="comment">//加载这个UClass</span></span><br><span class="line">		EngineClass = <span class="built_in">StaticLoadClass</span>( UGameEngine::<span class="built_in">StaticClass</span>(), <span class="literal">nullptr</span>, *GameEngineClassName);</span><br><span class="line">		<span class="keyword">if</span> (EngineClass == <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogInit, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to load UnrealEd Engine class &#x27;%s&#x27;.&quot;</span>), *GameEngineClassName);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//根据这个EngineClass构造GEngine</span></span><br><span class="line">		GEngine = NewObject&lt;UEngine&gt;(<span class="built_in">GetTransientPackage</span>(), EngineClass);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">		<span class="comment">//编辑器</span></span><br><span class="line">		FString UnrealEdEngineClassName;</span><br><span class="line">		GConfig-&gt;<span class="built_in">GetString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/Script/Engine.Engine&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;UnrealEdEngine&quot;</span>), UnrealEdEngineClassName, GEngineIni);</span><br><span class="line">		EngineClass = <span class="built_in">StaticLoadClass</span>(UUnrealEdEngine::<span class="built_in">StaticClass</span>(), <span class="literal">nullptr</span>, *UnrealEdEngineClassName);</span><br><span class="line">		<span class="keyword">if</span> (EngineClass == <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogInit, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to load UnrealEd Engine class &#x27;%s&#x27;.&quot;</span>), *UnrealEdEngineClassName);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//构造</span></span><br><span class="line">		GEngine = GEditor = GUnrealEd = NewObject&lt;UUnrealEdEngine&gt;(<span class="built_in">GetTransientPackage</span>(), EngineClass);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="built_in">check</span>(<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;	</span><br></pre></td></tr></table></figure>



<p>可以看到不在编辑器下，GEngine是整个引擎，<strong>而编辑器模式下，GEngine和GEditor和GUnrealEd一样。</strong></p>
<p>构造这个UClass的时候，顺便读入了<strong>配置文件。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">	FEmbeddedCommunication::<span class="built_in">ForceTick</span>(<span class="number">11</span>);</span><br><span class="line">	<span class="comment">//检查一个GEngine初始化成功了没</span></span><br><span class="line">	<span class="built_in">check</span>( GEngine );</span><br><span class="line"></span><br><span class="line">	<span class="built_in">GetMoviePlayer</span>()-&gt;<span class="built_in">PassLoadingScreenWindowBackToGame</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (FPreLoadScreenManager::<span class="built_in">Get</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        FPreLoadScreenManager::<span class="built_in">Get</span>()-&gt;<span class="built_in">PassPreLoadScreenWindowBackToGame</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;GEngine-&gt;ParseCommandline()&quot;</span>);</span><br><span class="line">		GEngine-&gt;<span class="built_in">ParseCommandline</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FEmbeddedCommunication::<span class="built_in">ForceTick</span>(<span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;InitTime&quot;</span>);</span><br><span class="line">		<span class="built_in">InitTime</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">60</span>);</span><br><span class="line">	<span class="comment">//这里关键</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;GEngine-&gt;Init&quot;</span>);</span><br><span class="line">        <span class="comment">//调用GEngine的Init函数</span></span><br><span class="line">		GEngine-&gt;<span class="built_in">Init</span>(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//调用初始化回调</span></span><br><span class="line">	FCoreDelegates::OnPostEngineInit.<span class="built_in">Broadcast</span>();</span><br><span class="line"></span><br><span class="line">	SlowTask.<span class="built_in">EnterProgressFrame</span>(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化引擎服务实例</span></span><br><span class="line">	<span class="keyword">if</span> (FPlatformProcess::<span class="built_in">SupportsMultithreading</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;SessionService etc&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">IsRunningCommandlet</span>())</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">//SessionService加载</span></span><br><span class="line">			SessionService = FModuleManager::LoadModuleChecked&lt;ISessionServicesModule&gt;(<span class="string">&quot;SessionServices&quot;</span>).<span class="built_in">GetSessionService</span>();</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (SessionService.<span class="built_in">IsValid</span>())</span><br><span class="line">			&#123;</span><br><span class="line">			SessionService-&gt;<span class="built_in">Start</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		EngineService = <span class="keyword">new</span> <span class="built_in">FEngineService</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;IProjectManager::Get().LoadModulesForProject(ELoadingPhase::PostEngineInit)&quot;</span>);</span><br><span class="line">		<span class="comment">//加载所有在引擎前的初始化模块</span></span><br><span class="line">		<span class="keyword">if</span> (!IProjectManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForProject</span>(ELoadingPhase::PostEngineInit) || !IPluginManager::<span class="built_in">Get</span>().<span class="built_in">LoadModulesForEnabledPlugins</span>(ELoadingPhase::PostEngineInit))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">RequestEngineExit</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;One or more modules failed PostEngineInit&quot;</span>));</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//调用GEngine的Start</span></span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;GEngine-&gt;Start()&quot;</span>);</span><br><span class="line">		GEngine-&gt;<span class="built_in">Start</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FEmbeddedCommunication::<span class="built_in">ForceTick</span>(<span class="number">13</span>);</span><br><span class="line">	<span class="comment">//等待引擎加载完成</span></span><br><span class="line">    <span class="keyword">if</span> (FPreLoadScreenManager::<span class="built_in">Get</span>() &amp;&amp; FPreLoadScreenManager::<span class="built_in">Get</span>()-&gt;<span class="built_in">HasActivePreLoadScreenType</span>(EPreLoadScreenTypes::EngineLoadingScreen))</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;WaitForEngineLoadingScreenToFinish&quot;</span>);</span><br><span class="line">		FPreLoadScreenManager::<span class="built_in">Get</span>()-&gt;<span class="built_in">SetEngineLoadingComplete</span>(<span class="literal">true</span>);</span><br><span class="line">        FPreLoadScreenManager::<span class="built_in">Get</span>()-&gt;<span class="built_in">WaitForEngineLoadingScreenToFinish</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;WaitForMovieToFinish&quot;</span>);</span><br><span class="line">		<span class="built_in">GetMoviePlayer</span>()-&gt;<span class="built_in">WaitForMovieToFinish</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//加载一些模块</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_AUTOMATION_WORKER</span></span><br><span class="line">	FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="string">&quot;AutomationWorker&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_ENGINE &amp;&amp; !UE_BUILD_SHIPPING</span></span><br><span class="line">	FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="string">&quot;AutomationController&quot;</span>);</span><br><span class="line">	FModuleManager::GetModuleChecked&lt;IAutomationControllerModule&gt;(<span class="string">&quot;AutomationController&quot;</span>).<span class="built_in">Init</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">//------编辑器下加载Sequence有关的模块，还有Profiler客户端------</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">	<span class="keyword">if</span> (GIsEditor)</span><br><span class="line">	&#123;</span><br><span class="line">		FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ProfilerClient&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;SequenceRecorder&quot;</span>));</span><br><span class="line">	FModuleManager::<span class="built_in">Get</span>().<span class="built_in">LoadModule</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;SequenceRecorderSections&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">//GIsRunning设置为true</span></span><br><span class="line">	GIsRunning = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!GIsEditor)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// hide a couple frames worth of rendering</span></span><br><span class="line">		FViewport::<span class="built_in">SetGameRenderingEnabled</span>(<span class="literal">true</span>, <span class="number">3</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FEmbeddedCommunication::<span class="built_in">ForceTick</span>(<span class="number">15</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定一个委托</span></span><br><span class="line">	FCoreDelegates::StarvedGameLoop.<span class="built_in">BindStatic</span>(&amp;GameLoopIsStarved);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//准备去测量线程心跳</span></span><br><span class="line">	FThreadHeartBeat::<span class="built_in">Get</span>().<span class="built_in">Start</span>();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//ShaderPipelineCache暂停合批</span></span><br><span class="line">	FShaderPipelineCache::<span class="built_in">PauseBatching</span>();</span><br><span class="line">   	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(WITH_CODE_GUARD_HANDLER) &amp;&amp; WITH_CODE_GUARD_HANDLER</span></span><br><span class="line">         <span class="function"><span class="keyword">void</span> <span class="title">CheckImageIntegrity</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="built_in">CheckImageIntegrity</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">		<span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FCoreDelegates::OnFEngineLoopInitComplete.Broadcast()&quot;</span>);</span><br><span class="line">        <span class="comment">//------委托调用一下------</span></span><br><span class="line">		FCoreDelegates::OnFEngineLoopInitComplete.<span class="built_in">Broadcast</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//恢复合批</span></span><br><span class="line">	FShaderPipelineCache::<span class="built_in">ResumeBatching</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BUILD_EMBEDDED_APP</span></span><br><span class="line">	FEmbeddedCommunication::<span class="built_in">AllowSleep</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Startup&quot;</span>));</span><br><span class="line">	FEmbeddedCommunication::<span class="built_in">KeepAwake</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;FirstTicks&quot;</span>), <span class="literal">true</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_EXTERNAL_PROFILING_ENABLED</span></span><br><span class="line">	FExternalProfiler* ActiveProfiler = FActiveExternalProfilerBase::<span class="built_in">InitActiveProfiler</span>();</span><br><span class="line">	<span class="keyword">if</span> (ActiveProfiler)</span><br><span class="line">	&#123;</span><br><span class="line">		ActiveProfiler-&gt;<span class="built_in">Register</span>();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>		<span class="comment">// UE_EXTERNAL_PROFILING_ENABLED</span></span></span><br><span class="line"></span><br><span class="line">	FDelayedAutoRegisterHelper::<span class="built_in">RunAndClearDelayedAutoRegisterDelegates</span>(EDelayedRegisterRunPhase::EndOfEngineInit);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Emit logging. Don&#x27;t edit! Automation looks for this to detect failures during initialization.</span></span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogInit, Display, <span class="built_in">TEXT</span>(<span class="string">&quot;Engine is initialized. Leaving FEngineLoop::Init()&quot;</span>));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>



<p>这里主要调用GEngine的Init和Start函数。</p>
<p>GEngine定义在Source\Runtime\Engine\Classes\Engine\Engine.h下。</p>
<h2 id="EngineTick"><a href="#EngineTick" class="headerlink" title="EngineTick"></a>EngineTick</h2><h3 id="FEngineLoop-Tick"><a href="#FEngineLoop-Tick" class="headerlink" title="FEngineLoop::Tick"></a>FEngineLoop::Tick</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开始一个具名事件对象的帧</span></span><br><span class="line">FPlatformMisc::<span class="built_in">BeginNamedEventFrame</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//现在帧的个数</span></span><br><span class="line">uint64 CurrentFrameCounter = GFrameCounter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行回调，对于cvar的改变</span></span><br><span class="line">	IConsoleManager::<span class="built_in">Get</span>().<span class="built_in">CallAllConsoleVariableSinks</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//开始Frame广播一下</span></span><br><span class="line">FCoreDelegates::OnBeginFrame.<span class="built_in">Broadcast</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------获取GEngine的世界上下文------</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> FWorldContext&amp; Context : GEngine-&gt;<span class="built_in">GetWorldContexts</span>())</span><br><span class="line">	&#123;</span><br><span class="line">           <span class="comment">//------获取UWorld------</span></span><br><span class="line">		UWorld* CurrentWorld = Context.<span class="built_in">World</span>();</span><br><span class="line">		<span class="keyword">if</span> (CurrentWorld)</span><br><span class="line">		&#123;</span><br><span class="line">			FSceneInterface* Scene = CurrentWorld-&gt;Scene;</span><br><span class="line">               <span class="comment">//------添加渲染命令到命令队列中------</span></span><br><span class="line">               <span class="comment">//------更新场景的图元------</span></span><br><span class="line">			<span class="built_in">ENQUEUE_RENDER_COMMAND</span>(UpdateScenePrimitives)(</span><br><span class="line">				[Scene](FRHICommandListImmediate&amp; RHICmdList)</span><br><span class="line">			&#123;</span><br><span class="line">				Scene-&gt;<span class="built_in">UpdateAllPrimitiveSceneInfos</span>(RHICmdList);</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//开始RHI的frame</span></span><br><span class="line">	<span class="built_in">ENQUEUE_RENDER_COMMAND</span>(BeginFrame)([CurrentFrameCounter](FRHICommandListImmediate&amp; RHICmdList)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">BeginFrameRenderThread</span>(RHICmdList, CurrentFrameCounter);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> FWorldContext&amp; Context : GEngine-&gt;<span class="built_in">GetWorldContexts</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		UWorld* CurrentWorld = Context.<span class="built_in">World</span>();</span><br><span class="line">		<span class="keyword">if</span> (CurrentWorld)</span><br><span class="line">		&#123;</span><br><span class="line">			FSceneInterface* Scene = CurrentWorld-&gt;Scene;</span><br><span class="line"></span><br><span class="line">               <span class="comment">//------Scene-&gt;StartFrame()------</span></span><br><span class="line">			<span class="built_in">ENQUEUE_RENDER_COMMAND</span>(SceneStartFrame)([Scene](FRHICommandListImmediate&amp; RHICmdList)</span><br><span class="line">			&#123;</span><br><span class="line">				Scene-&gt;<span class="built_in">StartFrame</span>();</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------更新内存分配状态------</span></span><br><span class="line">	GMalloc-&gt;<span class="built_in">UpdateStats</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//计算FPS</span></span><br><span class="line">	<span class="built_in">CalculateFPSTimings</span>();	</span><br><span class="line"></span><br><span class="line">	<span class="comment">//处理渲染线程之前的一些任务</span></span><br><span class="line">	<span class="built_in">ENQUEUE_RENDER_COMMAND</span>(ResetDeferredUpdates)(</span><br><span class="line">		[](FRHICommandList&amp; RHICmdList)</span><br><span class="line">		&#123;</span><br><span class="line">			FDeferredUpdateResource::<span class="built_in">ResetNeedsUpdate</span>();</span><br><span class="line">			<span class="built_in">FlushPendingDeleteRHIResources_RenderThread</span>();</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置World的尺寸</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//tick激活的平台文件</span></span><br><span class="line">	FPlatformFileManager::<span class="built_in">Get</span>().<span class="built_in">TickActivePlatformFile</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//粗糙地跟踪时间，当输入被采样的时候</span></span><br><span class="line">	FCoreDelegates::OnSamplingInput.<span class="built_in">Broadcast</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------处理FSlateApplication的输入------</span></span><br><span class="line">	<span class="keyword">if</span> (FSlateApplication::<span class="built_in">IsInitialized</span>() &amp;&amp; !bIdleMode)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">CSV_SCOPED_TIMING_STAT_EXCLUSIVE</span>(Input);</span><br><span class="line">		<span class="built_in">SCOPE_TIME_GUARD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;SlateInput&quot;</span>));</span><br><span class="line">		<span class="built_in">QUICK_SCOPE_CYCLE_COUNTER</span>(STAT_FEngineLoop_Tick_SlateInput);</span><br><span class="line">		<span class="built_in">LLM_SCOPE</span>(ELLMTag::UI);</span><br><span class="line"></span><br><span class="line">		FSlateApplication&amp; SlateApp = FSlateApplication::<span class="built_in">Get</span>();</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="built_in">QUICK_SCOPE_CYCLE_COUNTER</span>(STAT_FEngineLoop_Tick_PollGameDeviceState);</span><br><span class="line">               SlateApp.<span class="built_in">PollGameDeviceState</span>();</span><br><span class="line">           &#125;</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="built_in">QUICK_SCOPE_CYCLE_COUNTER</span>(STAT_FEngineLoop_Tick_FinishedInputThisFrame);</span><br><span class="line">               SlateApp.<span class="built_in">FinishedInputThisFrame</span>();</span><br><span class="line">           &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//主要的game engine tick(world, game objects, etc.)</span></span><br><span class="line">	GEngine-&gt;<span class="built_in">Tick</span>(FApp::<span class="built_in">GetDeltaTime</span>(), bIdleMode);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//处理任何异步的着色器编译结果，限制执行的时间</span></span><br><span class="line">	GShaderCompilingManager-&gt;<span class="built_in">ProcessAsyncResults</span>(<span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Tick平台，还有Slate应用的输入部分</span></span><br><span class="line">	<span class="keyword">if</span> (FSlateApplication::<span class="built_in">IsInitialized</span>() &amp;&amp; !bIdleMode)</span><br><span class="line">	&#123;</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">QUICK_SCOPE_CYCLE_COUNTER</span>(STAT_FEngineLoop_ProcessPlayerControllersSlateOperations);</span><br><span class="line">			<span class="built_in">check</span>(!<span class="built_in">IsRunningDedicatedServer</span>());</span><br><span class="line"></span><br><span class="line">			<span class="comment">//处理Slate累加的输入，在World Ticks里面</span></span><br><span class="line">			<span class="built_in">ProcessLocalPlayerSlateOperations</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		FSlateApplication::<span class="built_in">Get</span>().<span class="built_in">Tick</span>(ESlateTickType::PlatformAndInput);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//处理并发的slate任务</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//Tick Application，并且Tick 绘制slate应用的widgets</span></span><br><span class="line">	<span class="keyword">if</span> (FSlateApplication::<span class="built_in">IsInitialized</span>() &amp;&amp; !bIdleMode)</span><br><span class="line">	&#123;</span><br><span class="line">		FSlateApplication::<span class="built_in">Get</span>().<span class="built_in">Tick</span>(ESlateTickType::TimeAndWidgets);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//tick automation控制器(编辑器的)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">QUICK_SCOPE_CYCLE_COUNTER</span>(STAT_FEngineLoop_Tick_AutomationController);</span><br><span class="line">		<span class="function"><span class="keyword">static</span> FName <span class="title">AutomationController</span><span class="params">(<span class="string">&quot;AutomationController&quot;</span>)</span></span>;</span><br><span class="line">		<span class="keyword">if</span> (FModuleManager::<span class="built_in">Get</span>().<span class="built_in">IsModuleLoaded</span>(AutomationController))</span><br><span class="line">		&#123;</span><br><span class="line">			FModuleManager::GetModuleChecked&lt;IAutomationControllerModule&gt;(AutomationController).<span class="built_in">Tick</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------tick render硬件接口------</span></span><br><span class="line">	&#123;			</span><br><span class="line">		<span class="built_in">SCOPE_CYCLE_COUNTER</span>(STAT_RHITickTime);</span><br><span class="line">		<span class="built_in">RHITick</span>( FApp::<span class="built_in">GetDeltaTime</span>() ); <span class="comment">// Update RHI.</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//提升全局frame计数</span></span><br><span class="line">	GFrameCounter++;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ENQUEUE_RENDER_COMMAND</span>(FrameCounter)(</span><br><span class="line">		[CurrentFrameCounter = GFrameCounter](FRHICommandListImmediate&amp; RHICmdList)</span><br><span class="line">	&#123;</span><br><span class="line">		GFrameCounterRenderThread = CurrentFrameCounter;</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取总Tick时间</span></span><br><span class="line">	<span class="keyword">if</span> (GFrameCounter &gt; <span class="number">6</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		TotalTickTime += FApp::<span class="built_in">GetDeltaTime</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//找到我们下一帧要清理的对象</span></span><br><span class="line">	FPendingCleanupObjects* PreviousPendingCleanupObjects = PendingCleanupObjects;</span><br><span class="line">	PendingCleanupObjects = <span class="built_in">GetPendingCleanupObjects</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">//tick核心的ticker，线程和延迟命令</span></span><br><span class="line">		FTicker::<span class="built_in">GetCoreTicker</span>().<span class="built_in">Tick</span>(FApp::<span class="built_in">GetDeltaTime</span>());</span><br><span class="line">		FThreadManager::<span class="built_in">Get</span>().<span class="built_in">Tick</span>();</span><br><span class="line">		GEngine-&gt;<span class="built_in">TickDeferredCommands</span>();	</span><br><span class="line"></span><br><span class="line">	<span class="comment">//tick多媒体框架</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">const</span> FName <span class="title">MediaModuleName</span><span class="params">(TEXT(<span class="string">&quot;Media&quot;</span>))</span></span>;</span><br><span class="line">	IMediaModule* MediaModule = FModuleManager::LoadModulePtr&lt;IMediaModule&gt;(MediaModuleName);</span><br><span class="line">	<span class="keyword">if</span> (MediaModule != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">QUICK_SCOPE_CYCLE_COUNTER</span>(STAT_FEngineLoop_MediaTickPostRender);</span><br><span class="line">		MediaModule-&gt;<span class="built_in">TickPostRender</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//广播一下帧的结束</span></span><br><span class="line">	FCoreDelegates::OnEndFrame.<span class="built_in">Broadcast</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//结束RHI的frame</span></span><br><span class="line">	<span class="built_in">ENQUEUE_RENDER_COMMAND</span>(EndFrame)(</span><br><span class="line">		[CurrentFrameCounter](FRHICommandListImmediate&amp; RHICmdList)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">EndFrameRenderThread</span>(RHICmdList, CurrentFrameCounter);</span><br><span class="line">		&#125;);</span><br></pre></td></tr></table></figure>



<h4 id="UEditorEngine-Tick和UGameEngine-Tick和UUnrealEngine-Tick"><a href="#UEditorEngine-Tick和UGameEngine-Tick和UUnrealEngine-Tick" class="headerlink" title="UEditorEngine::Tick和UGameEngine::Tick和UUnrealEngine::Tick"></a>UEditorEngine::Tick和UGameEngine::Tick和UUnrealEngine::Tick</h4><p>不在编辑器模式下，就一个UGameEngine，在编辑器模式下，三个都一样。</p>
<p>在FEngineLoop::Init中初始化的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UEditorEngine* GEditor;</span><br><span class="line">UEngine* GEngine;</span><br><span class="line">UUnrealEdEngine* GUnrealEd;</span><br></pre></td></tr></table></figure>

<h5 id="UGameEngine-Tick"><a href="#UGameEngine-Tick" class="headerlink" title="UGameEngine::Tick"></a>UGameEngine::Tick</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_SERVER</span></span><br><span class="line">	<span class="comment">//Tick多媒体框架</span></span><br><span class="line">	MediaModule-&gt;<span class="built_in">TickPreEngine</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//------更新子系统------</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPE_TIME_GUARD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameEngine::Tick - StaticTick&quot;</span>));</span><br><span class="line">		<span class="built_in">StaticTick</span>(DeltaSeconds, !!GAsyncLoadingUseFullTimeLimit, GAsyncLoadingTimeLimit / <span class="number">1000.f</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------开始Tick World------</span></span><br><span class="line">	<span class="keyword">bool</span> bIsAnyNonPreviewWorldUnpaused = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	FName OriginalGWorldContext = NAME_None;</span><br><span class="line">	<span class="keyword">for</span> (int32 i=<span class="number">0</span>; i &lt; WorldList.<span class="built_in">Num</span>(); ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (WorldList[i].<span class="built_in">World</span>() == GWorld)</span><br><span class="line">		&#123;</span><br><span class="line">			OriginalGWorldContext = WorldList[i].ContextHandle;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (int32 WorldIdx = <span class="number">0</span>; WorldIdx &lt; WorldList.<span class="built_in">Num</span>(); ++WorldIdx)</span><br><span class="line">	&#123;</span><br><span class="line">		FWorldContext &amp;Context = WorldList[WorldIdx];</span><br><span class="line">		<span class="keyword">if</span> (Context.<span class="built_in">World</span>() == <span class="literal">NULL</span> || !Context.<span class="built_in">World</span>()-&gt;<span class="built_in">ShouldTick</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		GWorld = Context.<span class="built_in">World</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Tick all travel and Pending NetGames (Seamless, server, client)</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">QUICK_SCOPE_CYCLE_COUNTER</span>(STAT_UGameEngine_Tick_TickWorldTravel);</span><br><span class="line">			<span class="built_in">TickWorldTravel</span>(Context, DeltaSeconds);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!bIdleMode)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">SCOPE_TIME_GUARD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameEngine::Tick - WorldTick&quot;</span>));</span><br><span class="line"></span><br><span class="line">			<span class="comment">//Tick世界</span></span><br><span class="line">			Context.<span class="built_in">World</span>()-&gt;<span class="built_in">Tick</span>( LEVELTICK_All, DeltaSeconds );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">IsRunningDedicatedServer</span>() &amp;&amp; !<span class="built_in">IsRunningCommandlet</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">QUICK_SCOPE_CYCLE_COUNTER</span>(STAT_UGameEngine_Tick_CheckCaptures);</span><br><span class="line">			<span class="comment">//更新反射捕获</span></span><br><span class="line">			<span class="keyword">if</span> (Context.<span class="built_in">World</span>()-&gt;<span class="built_in">AreAlwaysLoadedLevelsLoaded</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//更新天光</span></span><br><span class="line">				USkyLightComponent::<span class="built_in">UpdateSkyCaptureContents</span>(Context.<span class="built_in">World</span>());</span><br><span class="line">				UReflectionCaptureComponent::<span class="built_in">UpdateReflectionCaptureContents</span>(Context.<span class="built_in">World</span>());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//------结束逐世界的Tick------</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment">//Tick游戏视口</span></span><br><span class="line">	<span class="keyword">if</span> ( GameViewport != <span class="literal">NULL</span> &amp;&amp; !bIdleMode )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPE_TIME_GUARD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameEngine::Tick - TickViewport&quot;</span>));</span><br><span class="line">		<span class="built_in">SCOPE_CYCLE_COUNTER</span>(STAT_GameViewportTick);</span><br><span class="line">		GameViewport-&gt;<span class="built_in">Tick</span>(DeltaSeconds);</span><br><span class="line">	&#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//------渲染线程命令------</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">bool</span> bPauseRenderingRealtimeClock = GPauseRenderingRealtimeClock;</span><br><span class="line">		<span class="built_in">ENQUEUE_RENDER_COMMAND</span>(TickRenderingTimer)(</span><br><span class="line">			[bPauseRenderingRealtimeClock, DeltaSeconds](FRHICommandListImmediate&amp; RHICmdList)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(!bPauseRenderingRealtimeClock)</span><br><span class="line">			&#123;</span><br><span class="line">				GRenderingRealtimeClock.<span class="built_in">Tick</span>(DeltaSeconds);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			GRenderTargetPool.<span class="built_in">TickPoolElements</span>();</span><br><span class="line">            <span class="comment">//------RDG???------</span></span><br><span class="line">			FRDGBuilder::<span class="built_in">TickPoolElements</span>();</span><br><span class="line">			ICustomResourcePool::<span class="built_in">TickPoolElements</span>(RHICmdList);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;  </span><br><span class="line">        </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">	<span class="built_in">BroadcastPostEditorTick</span>(DeltaSeconds);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Tick资产注册和管理模块</span></span><br><span class="line">	FAssetRegistryModule::<span class="built_in">TickAssetRegistry</span>(DeltaSeconds);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<p>UGameEngine里面会Tick世界，Tick渲染，<strong>比如最近很火的RDG</strong>。</p>
<h2 id="大概整个过程"><a href="#大概整个过程" class="headerlink" title="大概整个过程"></a>大概整个过程</h2><img src="/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/TickFlow.png" class>


























      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" data-id="cl24x8q1j0000qwsz801p4mbx" data-title="UE4引擎启动流程" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/12/12/hello-world/" class="article-date">
  <time class="dt-published" datetime="2021-12-12T10:20:50.417Z" itemprop="datePublished">2021-12-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/12/12/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/12/12/hello-world/" data-id="ckx33ne0v0000e4szbg4ndhwm" data-title="Hello World" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/04/21/SlateRenderer/">SlateRenderer</a>
          </li>
        
          <li>
            <a href="/2022/04/19/Slate/">Slate</a>
          </li>
        
          <li>
            <a href="/2022/01/05/UE4%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">UE4引擎启动流程</a>
          </li>
        
          <li>
            <a href="/2021/12/12/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>